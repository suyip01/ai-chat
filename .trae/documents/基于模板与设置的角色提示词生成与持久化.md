## 目标
- 在“唤醒角色”（POST /user-characters）与“更新角色”（PUT /user-characters/:id）时，按数据库的默认模板与设置生成两套提示词：
  - 场景版：system_prompt_scene、并记录 scene_model_id、scene_temperature、scene_template_id
  - 非场景版：system_prompt、并记录 prompt_model_id、prompt_temperature
- “草稿”接口保持不触发 LLM

## 数据来源
- 模板：templates 表中 `is_default=1` 的记录，取其 `id` 和 `content`；若无则回退 settings.default_template_id
- 设置：settings 表中 `selected_model` 与 `model_temperature`
- 模型 ID：通过 models 表把 `selected_model`（model_id/model_name/model_nickname）映射到标准 `model_id`

## 生成流程
- 组装角色数据对象（name、gender、identity、tagline、personality、relationship、age、occupation、tags、styleExamples、hobbies、experiences）
- 调用 `generateRolePrompt(data, { systemTemplate: tplContent, model: modelId, temperature })`
  - 返回场景版提示词；记录 `scene_template_id=tplId`、`scene_model_id=modelId`、`scene_temperature=temperature`
- 用场景版结果调用 `generateNoScenePrompt(scenePrompt, { model: modelId, temperature })`
  - 返回不带场景提示词；记录 `prompt_model_id=modelId`、`prompt_temperature=temperature`

## 持久化
- POST 创建后：在同一请求的 `setImmediate` 任务中更新 characters 表：
  - `system_prompt_scene`、`scene_temperature`、`scene_model_id`、`scene_template_id`
  - `system_prompt`、`prompt_temperature`、`prompt_model_id`
- PUT 更新后：同上在 `setImmediate` 中根据最新数据重新生成并更新上述字段
- 草稿接口（POST /user-characters/draft、PUT /user-characters/:id/draft）不触发 LLM

## 代码改动
- `server/src/client-routes/userCharacters.js`
  - 在 POST/PUT 的 `setImmediate` 回调内：
    1. 查询默认模板（is_default=1）；若无，尝试 settings.default_template_id
    2. 查询 settings.selected_model 与 settings.model_temperature
    3. 查询 models 获取规范化 `model_id`
    4. 调用 `generateRolePrompt`（传 `systemTemplate` 与 `model/temperature`）生成场景版；保存至 DB
    5. 以场景版结果调用 `generateNoScenePrompt`；保存至 DB
- `server/src/admin-services/sysprompt.js`
  - 已具备 `generateRolePrompt` 与 `generateNoScenePrompt`，支持 `overrides.systemTemplate/model/temperature`；无需额外修改

## 失败处理
- 模板或模型缺失：记录错误日志，跳过生成，不影响主流程（角色创建/更新成功）
- LLM 返回空：字段写入空字符串；下次更新重试即可

## 保持现有行为
- 草稿保存逻辑维持现状，不触发 LLM
- 前端无需改动提交字段；后端负责生成与持久化