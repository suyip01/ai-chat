import{r as lt,j as e,a as n,R as Ge}from"./index-w_K9jfvi.js";import{c as q,L as We,U as Je,C as Xe,a as rt,b as ye,X as ne,P as ce,I as Ke,d as it,T as Te,e as ot,S as Ze,E as ct,A as Ae,f as dt,g as Le}from"./x-BQPLqcaV.js";var xt=lt();/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],Qe=q("archive",mt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}]],ht=q("book",pt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],gt=q("bot",ut);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Oe=q("circle-check",ft);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]],ze=q("circle-question-mark",bt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],Ee=q("cloud-upload",yt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],et=q("copy",jt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]],wt=q("cpu",vt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],kt=q("database",Nt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],Re=q("download",St);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],we=q("file-text",Ct);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Fe=q("loader-circle",Mt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Ie=q("pen-line",_t);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Ue=q("refresh-cw",zt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],tt=q("rotate-cw",$t);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],fe=q("save",Tt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],It=q("search",Et);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],At=q("settings",Pt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],Ot=q("shield",Lt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}],["path",{d:"M20 2v4",key:"1rf3ol"}],["path",{d:"M22 4h-4",key:"gwowj6"}],["circle",{cx:"4",cy:"20",r:"2",key:"6kqj1y"}]],Ce=q("sparkles",Rt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],Ut=q("star",Ft);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Vt=q("upload",Dt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=[["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m14.305 16.53.923-.382",key:"1itpsq"}],["path",{d:"m15.228 13.852-.923-.383",key:"eplpkm"}],["path",{d:"m16.852 12.228-.383-.923",key:"13v3q0"}],["path",{d:"m16.852 17.772-.383.924",key:"1i8mnm"}],["path",{d:"m19.148 12.228.383-.923",key:"1q8j1v"}],["path",{d:"m19.53 18.696-.382-.924",key:"vk1qj3"}],["path",{d:"m20.772 13.852.924-.383",key:"n880s0"}],["path",{d:"m20.772 16.148.924.383",key:"1g6xey"}],["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Ht=q("user-cog",Bt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],qt=q("users",Yt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]],Me=q("wand-sparkles",Gt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],st=q("zoom-in",Wt);/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],at=q("zoom-out",Jt),Ne="/api/admin",Xt=()=>localStorage.getItem("admin_access_token")||"",Kt=()=>localStorage.getItem("admin_refresh_token")||"",Zt=(t,r)=>{t&&localStorage.setItem("admin_access_token",t),r&&localStorage.setItem("admin_refresh_token",r)},$e=()=>{localStorage.removeItem("admin_access_token"),localStorage.removeItem("admin_refresh_token");const t="/super-admin/login";typeof window<"u"&&window.location&&(typeof window.location.replace=="function"?window.location.replace(t):window.location.href=t)},De=()=>({Authorization:`Bearer ${Xt()}`});let Se=null;const Qt=async()=>{const t=Kt();if(!t)throw $e(),new Error("unauthorized");const r=await fetch(`${Ne}/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(!r.ok)throw $e(),new Error("refresh_failed");const i=await r.json();return Zt(i.access_token,i.refresh_token),i},F=async(t,r={})=>{const i={...r},l=typeof FormData<"u"&&i.body instanceof FormData,s=De(),d=l?{}:{"Content-Type":"application/json"};i.headers={...i.headers||{},...d,...s};let h=await fetch(`${Ne}${t}`,i);if(h.status===401){Se||(Se=Qt());try{await Se}finally{Se=null}const m=De(),p=l?{}:{"Content-Type":"application/json"};if(i.headers={...i.headers||{},...p,...m},h=await fetch(`${Ne}${t}`,i),h.status===401)throw $e(),new Error("unauthorized")}if(!h.ok)throw new Error("failed");if(!h.ok){let m="";try{m=await h.text()}catch{}throw console.error("[admin.api.request] failed",{path:t,status:h.status,body:m}),new Error("failed")}return h.json()},ge={async list(){return F("/templates")},async create(t){return F("/templates",{method:"POST",body:JSON.stringify(t)})},async update(t,r){return F(`/templates/${t}`,{method:"PUT",body:JSON.stringify(r)})},async remove(t){return F(`/templates/${t}`,{method:"DELETE"})},async copy(t){return F(`/templates/${t}/copy`,{method:"POST"})},async setDefault(t){return F(`/templates/${t}/default`,{method:"POST"})}},be={async list(t){const r=t?"?"+new URLSearchParams(t).toString():"";return F(`/characters${r}`)},async get(t){return F(`/characters/${t}`)},async create(t){return F("/characters",{method:"POST",body:JSON.stringify(t)})},async update(t,r){return F(`/characters/${t}`,{method:"PUT",body:JSON.stringify(r)})},async remove(t){return F(`/characters/${t}`,{method:"DELETE"})},async setStatus(t,r){return F(`/characters/${t}/status`,{method:"POST",body:JSON.stringify({status:r})})}},je={async list(){return F("/models")},async create(t){return F("/models",{method:"POST",body:JSON.stringify(t)})},async remove(t){return F(`/models/${t}`,{method:"DELETE"})}},Ve={async get(){return F("/settings")},async save(t){return F("/settings",{method:"PUT",body:JSON.stringify(t)})}},ve={async list(){return F("/stories")},async get(t){return F(`/stories/${t}`)},async create(t){return F("/stories",{method:"POST",body:JSON.stringify(t)})},async update(t,r){return F(`/stories/${t}`,{method:"PUT",body:JSON.stringify(r)})},async remove(t){return F(`/stories/${t}`,{method:"DELETE"})},async setStatus(t,r){return F(`/stories/${t}/status`,{method:"POST",body:JSON.stringify({status:r})})}},Be={async generate(t){return F("/sysprompt/generate",{method:"POST",body:JSON.stringify(t)})},async generateNoScene(t){return F("/sysprompt/generate-noscene",{method:"POST",body:JSON.stringify(t)})}},Pe={async avatar(t){const r=new FormData;return r.append("avatar",t),F("/uploads/avatar",{method:"POST",body:r})},async cover(t){const r=new FormData;return r.append("cover",t),F("/uploads/cover",{method:"POST",body:r})}},te={async list(t){const r=t?`?q=${encodeURIComponent(t)}`:"";return F(`/users${r}`)},async create(t){return F("/users",{method:"POST",body:JSON.stringify(t)})},async update(t,r){return F(`/users/${t}`,{method:"PUT",body:JSON.stringify(r)})},async remove(t){return F(`/users/${t}`,{method:"DELETE"})},async changePassword(t,r){return F(`/users/${t}/password`,{method:"POST",body:JSON.stringify({password:r})})}},oe={async list(t){const r=t?`?q=${encodeURIComponent(t)}`:"";return F(`/admins${r}`)},async create({username:t,email:r,password:i}){return F("/admins",{method:"POST",body:JSON.stringify({username:t,email:r,password:i})})},async update(t,r){return F(`/admins/${t}`,{method:"PUT",body:JSON.stringify(r)})},async remove(t){return F(`/admins/${t}`,{method:"DELETE"})},async changePassword(t,r){return F(`/admins/${t}/password`,{method:"POST",body:JSON.stringify({password:r})})},async getMyAvatar(){return F("/admins/me/avatar")},async updateMe(t){return F("/admins/me",{method:"PUT",body:JSON.stringify(t)})}},He=()=>e.jsx("style",{children:`
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Varela+Round&display=swap');
    body { font-family: 'Varela Round', 'PingFang SC', sans-serif; background-color: #FFFFFF; color: #4A4060; }
    .font-cute { font-family: 'ZCOOL KuaiLe', cursive; }
    .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 8px 30px rgba(236, 72, 153, 0.08); }
    .solid-card { background: #FFFFFF; border: 1px solid #FCE7F3; box-shadow: 0 4px 20px rgba(236, 72, 153, 0.05); }
    .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.5); }
    .dream-input { background: rgba(255, 255, 255, 0.6); border: 2px solid #FCE7F3; transition: all 0.3s ease; color: #5D5476; }
    .dream-input:focus { background: #FFFFFF; border-color: #F472B6; outline: none; box-shadow: 0 0 0 4px rgba(244, 114, 182, 0.15); }
    .tag-pill { background: linear-gradient(135deg, #FBCFE8 0%, #FCE7F3 100%); color: #BE185D; font-weight: 700; font-size: 0.75rem; border-radius: 8px; }
    .tag-select-btn { background: #FCE7F3; color: #BE185D; border: 1px solid transparent; border-radius: 20px; font-weight: bold; font-size: 0.85rem; padding: 8px 10px; transition: all 0.2s; white-space: nowrap; }
    .tag-select-btn.active { background: #EC4899; color: white; border-color: #DB2777; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); }
    .ambient-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(at 0% 0%, hsla(330, 70%, 98%, 1) 0, transparent 50%), radial-gradient(at 50% 100%, hsla(330, 85%, 95%, 1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(330, 80%, 97%, 1) 0, transparent 50%); background-size: 200% 200%; animation: gradientMove 15s ease infinite; }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.02); }
    ::-webkit-scrollbar-thumb { background: #FBCFE8; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #F472B6; }
    .glass-card p, .glass-card h4, .glass-card li, .glass-card ul { color: #4A4060; }
    .solid-card p, .solid-card h4, .solid-card li, .solid-card ul { color: #4A4060; }
  `}),nt=n.createContext(null),de=()=>n.useContext(nt),xe=({children:t})=>{const[r,i]=n.useState([]),l=n.useCallback((s,d="success")=>{const h=Date.now()+Math.random();i(m=>[...m,{id:h,message:s,type:d}]),setTimeout(()=>{i(m=>m.filter(p=>p.id!==h))},3e3)},[]);return e.jsxs(nt.Provider,{value:{showToast:l},children:[t,e.jsx("div",{className:"fixed top-6 left-64 right-0 z-50 flex flex-col items-center gap-3 pointer-events-none",children:r.map(s=>e.jsx("div",{className:`pointer-events-auto flex items-center justify-center text-center px-4 py-2 rounded-2xl shadow-xl border max-w-[480px] min-w-[180px] mx-auto ${s.type==="success"?"bg-white border-green-200 text-green-700":"bg-white border-red-200 text-red-700"}`,children:s.message},s.id))})]})},es=({onLogin:t})=>{const[r,i]=n.useState(""),[l,s]=n.useState(""),{showToast:d}=de(),h=async()=>{try{const j=(await(await fetch(`${Ne}/crypto/public-key`)).text()).replace(/-----BEGIN PUBLIC KEY-----/,"").replace(/-----END PUBLIC KEY-----/,"").replace(/\s+/g,""),C=Uint8Array.from(atob(j),b=>b.charCodeAt(0)),k=await window.crypto.subtle.importKey("spki",C.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!1,["encrypt"]),I=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},k,new TextEncoder().encode(l)),_=btoa(String.fromCharCode(...new Uint8Array(I))),u=await fetch(`${Ne}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r,password_encrypted:_})});if(!u.ok){d("登录失败","error");return}const g=await u.json();g!=null&&g.access_token&&localStorage.setItem("admin_access_token",g.access_token),g!=null&&g.refresh_token&&localStorage.setItem("admin_refresh_token",g.refresh_token),localStorage.setItem("admin_username",r),t()}catch{d("登录失败","error")}};return e.jsxs("div",{className:"min-h-screen flex items-center justify-center relative overflow-hidden",onKeyDown:m=>{m.key==="Enter"&&h()},children:[e.jsx("div",{className:"ambient-bg"}),e.jsxs("div",{className:"glass-card p-10 rounded-3xl w-full max-w-md shadow-2xl transform transition-all hover:scale-[1.01]",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-pink-100 text-pink-600 mb-4 shadow-inner",children:e.jsx(Ce,{size:32})}),e.jsx("h1",{className:"text-3xl font-cute text-pink-900 mb-2",children:"YumeCrush"}),e.jsx("p",{className:"text-pink-400 text-sm",children:"运营管理平台"})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-pink-800 mb-2 ml-1",children:"管理员账号"}),e.jsx("input",{type:"text",placeholder:"请输入管理员账号",value:r,onChange:m=>i(m.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-pink-800 mb-2 ml-1",children:"密码"}),e.jsx("input",{type:"password",placeholder:"••••••••",value:l,onChange:m=>s(m.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl"})]}),e.jsxs("button",{onClick:h,className:"w-full bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-pink-200 transition-all transform active:scale-95 flex items-center justify-center gap-2",children:[e.jsx(We,{size:18,className:"rotate-180"})," 登录后台"]})]})]})]})},ts=({activeTab:t,setActiveTab:r,onLogout:i,username:l,onEditProfile:s})=>{const[d,h]=n.useState(["characters","settings"]),m=[{id:"stories",label:"故事管理",icon:ht},{id:"templates",label:"提示词模版",icon:we},{id:"characters",label:"角色管理",icon:qt,subItems:[{id:"official_characters",label:"官方角色",icon:gt},{id:"user_characters",label:"用户角色",icon:Je}]},{id:"users",label:"用户管理",icon:Ht},{id:"settings",label:"系统设置",icon:At,subItems:[{id:"model_settings",label:"模型设置",icon:wt},...l==="admin"?[{id:"model_manage",label:"模型管理",icon:kt},{id:"admin_accounts",label:"管理员账号",icon:Ot}]:[]]}];n.useEffect(()=>{const c=m.find(N=>{var V;return(V=N.subItems)==null?void 0:V.some(B=>B.id===t)});c&&h(N=>N.includes(c.id)?N:[...N,c.id])},[t]);const p=c=>{h(N=>N.includes(c)?N.filter(V=>V!==c):[...N,c])},j=c=>{h(N=>N.includes(c)?N:[...N,c])},C=c=>{var B;const N=m.find(Y=>Y.id===c);((B=N==null?void 0:N.subItems)==null?void 0:B.some(Y=>Y.id===t))||h(Y=>Y.filter(M=>M!==c))},k=c=>{c.subItems?p(c.id):(r(c.id),h([]))},[I,_]=n.useState(!1),[u,g]=n.useState(""),[b,S]=n.useState(""),[E,o]=n.useState(""),v=async()=>{const c={};if(u&&u.trim()&&(c.nickname=u.trim()),b){if(b!==E)return;c.password=b}try{await oe.updateMe(c),_(!1),g(""),S(""),o("")}catch{}};return e.jsxs("div",{className:"w-16 xl:w-56 glass-nav h-screen fixed left-0 top-0 flex flex-col z-20 transition-all duration-300",style:{backgroundColor:"#f4f6fb"},children:[e.jsxs("div",{className:"p-4 xl:p-8 flex items-center justify-center xl:justify-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-pink-500 rounded-lg flex items-center justify-center text-white flex-shrink-0",children:e.jsx(Ce,{size:18})}),e.jsx("span",{className:"text-xl font-cute text-pink-900 tracking-wide hidden xl:block",children:"YumeCrush Admin"})]}),e.jsx("nav",{className:"flex-1 px-4 space-y-2",children:m.map(c=>e.jsxs("div",{onMouseEnter:()=>c.subItems&&j(c.id),onMouseLeave:()=>c.subItems&&C(c.id),children:[e.jsxs("button",{onClick:()=>k(c),className:`w-full flex items-center justify-center xl:justify-start gap-3 px-2 xl:px-4 py-3.5 rounded-2xl transition-all duration-300 font-bold text-sm ${t===c.id||c.subItems&&c.subItems.some(N=>N.id===t)?"bg-pink-100 text-pink-700 shadow-sm":"text-gray-500 hover:bg-white/50 hover:text-pink-600"}`,children:[e.jsx(c.icon,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"hidden xl:block flex-1 text-left",children:c.label}),c.subItems&&e.jsx("span",{className:"hidden xl:block transition-transform duration-300",children:d.includes(c.id)?e.jsx(Xe,{size:14}):e.jsx(rt,{size:14})})]}),c.subItems&&e.jsx("div",{className:`grid transition-all duration-300 ease-in-out ${d.includes(c.id)?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"}`,children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 space-y-1 xl:pl-4",children:c.subItems.map(N=>e.jsxs("button",{onClick:V=>{V.stopPropagation(),r(N.id)},className:`w-full flex items-center justify-center xl:justify-start gap-2 px-2 xl:px-4 py-2.5 rounded-xl transition-all duration-300 text-xs font-bold ${t===N.id?"bg-pink-200/50 text-pink-800":"text-gray-400 hover:text-pink-600 hover:bg-white/30"}`,children:[N.icon?e.jsx(N.icon,{size:16,className:"flex-shrink-0 hidden xl:block"}):e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-current flex-shrink-0 hidden xl:block"}),e.jsx("span",{className:"hidden xl:block",children:N.label}),e.jsx("span",{className:"xl:hidden",children:N.icon?e.jsx(N.icon,{size:14}):N.label.substring(0,1)})]},N.id))})})})]},c.id))}),e.jsx("div",{className:"p-4 border-t border-pink-100",children:e.jsxs("div",{className:"w-full flex xl:flex-row flex-col items-center xl:justify-start justify-center gap-3",children:[e.jsxs("div",{className:"group relative",onClick:()=>s&&s(),children:[e.jsx(ss,{username:l}),e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 -translate-y-full -top-2 bg-pink-700 text-white text-xs px-2 py-1 rounded shadow opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50",children:l})]}),e.jsxs("button",{onClick:i,className:"w-full xl:flex-1 flex items-center justify-center xl:justify-start gap-3 px-2 xl:px-4 py-3 text-red-400 hover:bg-red-50 rounded-2xl transition-colors font-bold text-sm",children:[e.jsx(We,{size:18,className:"flex-shrink-0"}),e.jsx("span",{className:"hidden xl:block",children:"退出登录"})]})]})}),I&&e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/40",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"font-bold mb-4 text-pink-900",children:"修改资料"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{children:e.jsx("input",{type:"text",placeholder:`昵称（当前：${l}）`,value:u,onChange:c=>g(c.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})}),e.jsx("div",{children:e.jsx("input",{type:"password",placeholder:"新密码",value:b,onChange:c=>S(c.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})}),e.jsx("div",{children:e.jsx("input",{type:"password",placeholder:"再次输入新密码",value:E,onChange:c=>o(c.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})})]}),e.jsxs("div",{className:"flex gap-2 justify-end mt-5",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{_(!1),g(""),S(""),o("")},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:v,disabled:!u.trim()&&!b,children:"保存"})]})]}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-[1px] bg-slate-300"})]})]})},ss=({username:t})=>{const[r,i]=n.useState("");return n.useEffect(()=>{let l=!0;return oe.getMyAvatar().then(s=>{l&&i((s==null?void 0:s.avatar)||"/uploads/avatars/default_admin.jpg")}).catch(()=>{l&&i("/uploads/avatars/default_admin.jpg")}),()=>{l=!1}},[t]),e.jsx("div",{className:"group relative w-8 h-8 rounded-full overflow-hidden border border-pink-200 bg-white flex items-center justify-center",children:r?e.jsx("img",{src:r,alt:t,className:"w-full h-full object-cover"}):e.jsx(Je,{size:16,className:"text-pink-500"})})},as=({onCancel:t,initialData:r,onSave:i,notify:l})=>{const[s,d]=n.useState({name:"",type:"恋爱",customType:"",tags:[],content:""}),[h,m]=n.useState(""),[p,j]=n.useState(!1),C=["恋爱","玄幻","悬疑","职场","科幻","同人"];n.useEffect(()=>{r&&(d({name:r.name||"",type:r.type||"恋爱",customType:"",tags:r.tags||[],content:r.content||""}),j(!1))},[r]);const k=g=>{g.key==="Enter"&&h.trim()&&(g.preventDefault(),s.tags.includes(h.trim())||d(b=>({...b,tags:[...b.tags,h.trim()]})),m(""))},I=g=>{const b=[...s.tags];b.splice(g,1),d(S=>({...S,tags:b}))},_=g=>{j(!1),d(b=>({...b,type:g}))},u=()=>{if(!s.name.trim()){typeof l=="function"&&l("保存失败：请输入模版名称","error");return}const g={id:r==null?void 0:r.id,name:s.name.trim(),type:p&&s.customType.trim()||s.type,tags:s.tags,content:s.content,refCount:(r==null?void 0:r.refCount)??0,creator:(r==null?void 0:r.creator)??"Admin"};try{i&&i(g)}catch{typeof l=="function"&&l("保存失败：请稍后重试","error")}};return e.jsxs("div",{className:"animate-fade-in pb-20",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:t,className:"w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-500 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:r?"编辑提示词模版":"新建提示词模版"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"定义基础 Prompt 框架"})]}),e.jsxs("div",{className:"ml-auto flex gap-3",children:[e.jsx("button",{onClick:t,className:"px-6 py-2.5 rounded-xl bg-white text-gray-500 font-bold text-sm shadow-sm hover:bg-gray-50",children:"取消"}),e.jsxs("button",{onClick:u,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text白 font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(fe,{size:16})," 保存模版"]})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsxs("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:[e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 模版基础信息"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"模版名称"}),e.jsx("input",{type:"text",value:s.name,onChange:g=>d({...s,name:g.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700 bg-gray-50/50 focus:bg-white",placeholder:"例如：病娇反派通用模版"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"模版类型"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[C.map(g=>e.jsx("button",{onClick:()=>_(g),className:`px-4 py-2 rounded-xl text-xs font-bold transition-all cute-font tracking-wide border ${!p&&s.type===g?"bg-pink-500 text白 border-pink-500 shadow-md shadow-pink-200":"bg白 text灰-500 border-gray-100 hover:border-pink-200"}`,children:g},g)),e.jsx("button",{onClick:()=>j(!0),className:`px-4 py-2 rounded-xl text-xs font-bold transition-all cute-font tracking-wide border ${p?"bg-pink-500 text白 border-pink-500 shadow-md shadow-pink-200":"bg白 text灰-500 border-gray-100 hover:border-pink-200"}`,children:"自定义..."})]}),p&&e.jsx("div",{className:"animate-fade-in mt-2",children:e.jsx("input",{type:"text",value:s.customType,onChange:g=>d({...s,customType:g.target.value}),placeholder:"请输入自定义类型名称",className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"模版标签 (回车生成)"}),e.jsxs("div",{className:"dream-input w-full px-4 py-3 rounded-xl min-h-[50px] flex flex-wrap gap-2 items-center bg-gray-50/50 focus-within:bg-white",children:[s.tags.map((g,b)=>e.jsxs("span",{className:"tag-pill px-3 py-1 flex items-center shadow-sm gap-1",children:["#",g," ",e.jsx("button",{onClick:()=>I(b),className:"hover:text-red-500 opacity-60 hover:opacity-100 transition-opacity",children:e.jsx(ne,{size:12})})]},b)),e.jsx("input",{value:h,onChange:g=>m(g.target.value),onKeyDown:k,type:"text",className:"bg-transparent outline-none text-sm w-40 placeholder-gray-400 h-8",placeholder:"输入标签按回车..."})]})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-4",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," Prompt 内容配置"]}),e.jsx("div",{className:"relative",children:e.jsx("textarea",{rows:"15",value:s.content,onChange:g=>d({...s,content:g.target.value}),className:"dream-input w-full px-5 py-4 rounded-xl text-sm leading-relaxed font-mono text-gray-600 bg-gray-50/50 focus:bg-white resize-y",placeholder:`在此输入系统提示词框架（System Instruction）...
可以使用 {'{{user}}'} 和 {'{{name}}'} 作为占位符。`})})]})]}),e.jsx("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"solid-card p-6 rounded-3xl bg-gradient-to-br from-pink-500 to-pink-600 text白 shadow-xl shadow-pink-200/50",children:[e.jsxs("h4",{className:"font-bold mb-3 flex items-center gap-2 text-lg font-cute",children:[e.jsx(Ce,{size:18,className:"text-yellow-300"})," 编写指南"]}),e.jsxs("ul",{className:"space-y-3 text-sm opacity-90 leading-relaxed list-disc list-inside",children:[e.jsxs("li",{children:["使用 ",e.jsx("b",{children:"{{name}}"})," 代表角色姓名。"]}),e.jsxs("li",{children:["使用 ",e.jsx("b",{children:"{{user}}"})," 代表用户昵称。"]}),e.jsxs("li",{children:["建议明确规定角色的",e.jsx("b",{children:"说话风格"}),"、",e.jsx("b",{children:"禁忌事项"}),"以及",e.jsx("b",{children:"背景设定"}),"。"]})]})]})})]})]})},ns=()=>{const[t,r]=n.useState("list"),[i,l]=n.useState([]),[s,d]=n.useState(1),h=6,[m,p]=n.useState(null),[j,C]=n.useState(null),{showToast:k}=de(),I=async()=>{try{const M=await ge.list();l(M.items||[])}catch{k("加载失败：请稍后再试","error")}};n.useEffect(()=>{I()},[]);const _=[...i].sort((M,U)=>{if(M.isDefault&&!U.isDefault)return-1;if(!M.isDefault&&U.isDefault)return 1;const H=M.createdAt?new Date(M.createdAt).getTime():0,L=U.createdAt?new Date(U.createdAt).getTime():0;return H-L}),u=Math.max(1,Math.ceil(_.length/h)),g=(s-1)*h,b=_.slice(g,g+h);n.useEffect(()=>{s>u&&d(u)},[i]);const S=M=>{if(!M)return"-";const U=new Date(M),H=U.getFullYear(),L=String(U.getMonth()+1).padStart(2,"0"),w=String(U.getDate()).padStart(2,"0"),x=String(U.getHours()).padStart(2,"0"),z=String(U.getMinutes()).padStart(2,"0");return`${H}/${L}/${w} ${x}:${z}`},E=async M=>{try{await ge.setDefault(M),k("已设为默认"),I()}catch{k("操作失败","error")}},o=M=>{p(M),r("create")},v=M=>{const U={...M,id:void 0,name:`${M.name}_copy`};p(U),r("create"),k("复制成功，已进入编辑")},c=async M=>{try{await ge.remove(M)}catch{throw new Error("failed")}},N=M=>C(M),V=()=>C(null),B=async()=>{if(j)try{await c(j.id),k("删除成功"),I()}catch{k("删除失败","error")}finally{V()}},Y=async M=>{try{m&&m.id?(await ge.update(m.id,M),k("保存成功：模版已更新")):(await ge.create(M),k("创建成功：模版已保存")),p(null),r("list"),I()}catch{k("保存失败：请稍后重试","error")}};return t==="create"?e.jsx(as,{onCancel:()=>{p(null),r("list")},initialData:m,onSave:Y,notify:k}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"}),"提示词模版库"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"管理用于生成角色的基础 Prompt"})]}),e.jsxs("button",{onClick:()=>{p(null),r("create")},className:"bg-pink-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-colors flex items-center gap-2 text-sm",children:[e.jsx(ce,{size:16})," 新建模版"]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-pink-50 p-4 rounded-2xl border border-pink-100 text-sm text-pink-700",children:[e.jsx(Ke,{size:18,className:"flex-shrink-0 text-pink-500"}),e.jsxs("span",{children:["提示：用户创建角色时，默认使用当前",e.jsx("span",{className:"font-bold",children:"“默认”"}),"提示词模板作为参考生成角色提示词。"]})]}),e.jsxs("div",{className:"glass-card rounded-3xl overflow-hidden",children:[e.jsxs("table",{className:"w-full text-left rounded-2xl overflow-hidden border-collapse",children:[e.jsx("thead",{className:"bg-pink-100 text-pink-900 font-cute text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 pl-6 w-16",children:"序号"}),e.jsx("th",{className:"p-3 pl-7",children:"模版名称"}),e.jsx("th",{className:"p-3",children:"类型"}),e.jsx("th",{className:"p-3",children:"标签"}),e.jsx("th",{className:"p-3",children:"创建时间"}),e.jsx("th",{className:"p-3",children:"引用数"}),e.jsx("th",{className:"p-3",children:"状态 / 操作"}),e.jsx("th",{className:"p-3 text-right pr-8",children:"操作"})]})}),e.jsx("tbody",{className:"text-sm divide-y divide-pink-100",children:b.map((M,U)=>{var H;return e.jsxs("tr",{className:"hover:bg-pink-50/30 transition-colors",children:[e.jsx("td",{className:"p-3 pl-6 text-gray-500 font-mono",children:g+U+1}),e.jsx("td",{className:"p-3 pl-8 font-bold text-gray-700",children:M.name}),e.jsx("td",{className:"p-3",children:e.jsx("span",{className:"bg-pink-100 text-pink-600 px-2.5 py-1 rounded-lg text-xs font-bold",children:M.type})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"flex gap-1",children:(H=M.tags)==null?void 0:H.map(L=>e.jsx("span",{className:"text-[10px] bg-white border border-pink-100 text-pink-400 px-1.5 py-0.5 rounded",children:L},L))})}),e.jsx("td",{className:"p-3 text-gray-500",children:S(M.createdAt)}),e.jsx("td",{className:"p-3 text-gray-500 font-mono",children:typeof M.refCount=="number"?M.refCount:0}),e.jsx("td",{className:"p-3",children:M.isDefault?e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-100 text-green-700 text-xs font-bold border border-green-200",children:[e.jsx(it,{size:14,className:"text-green-600"}),"当前默认"]}):e.jsxs("button",{onClick:()=>E(M.id),className:"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-500 text-xs font-bold hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50 transition-all group",children:[e.jsx(Ut,{size:14,className:"group-hover:fill-pink-200"}),"设为默认"]})}),e.jsxs("td",{className:"p-3 text-right pr-8 space-x-2",children:[e.jsxs("span",{className:"relative inline-flex group",children:[e.jsx("button",{onClick:()=>o(M),"aria-label":"编辑",className:"text-pink-400 hover:text-pink-600 p-1",children:e.jsx(Ie,{size:16})}),e.jsx("span",{className:"absolute -top-7 left-1/2 -translate-x-1/2 px-2 py-1 rounded-md text-xs bg-gray-800 text-white whitespace-nowrap opacity-0 group-hover:opacity-100",children:"编辑"})]}),e.jsxs("span",{className:"relative inline-flex group",children:[e.jsx("button",{onClick:()=>v(M),"aria-label":"复制",className:"text-pink-400 hover:text-pink-600 p-1",children:e.jsx(et,{size:16})}),e.jsx("span",{className:"absolute -top-7 left-1/2 -translate-x-1/2 px-2 py-1 rounded-md text-xs bg-gray-800 text-white whitespace-nowrap opacity-0 group-hover:opacity-100",children:"复制"})]}),e.jsxs("span",{className:"relative inline-flex group",children:[e.jsx("button",{onClick:()=>N(M),"aria-label":"删除",className:"text-red-400 hover:text-red-600 p-1",children:e.jsx(Te,{size:16})}),e.jsx("span",{className:"absolute -top-7 left-1/2 -translate-x-1/2 px-2 py-1 rounded-md text-xs bg-gray-800 text-white whitespace-nowrap opacity-0 group-hover:opacity-100",children:"删除"})]})]})]},M.id)})})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border-t border-pink-100",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["第 ",s," / ",u," 页"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:s===1,onClick:()=>d(M=>Math.max(1,M-1)),className:`px-3 py-1 rounded-lg text-xs font-bold ${s===1?"bg-gray-100 text-gray-400":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:"上一页"}),Array.from({length:u}).map((M,U)=>e.jsx("button",{onClick:()=>d(U+1),className:`w-8 h-8 rounded-lg text-xs font-bold ${s===U+1?"bg-pink-500 text-white":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:U+1},U)),e.jsx("button",{disabled:s===u,onClick:()=>d(M=>Math.min(u,M+1)),className:`px-3 py-1 rounded-lg text-xs font-bold ${s===u?"bg-gray-100 text-gray-400":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:"下一页"})]})]})]}),j&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50",onClick:V}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-pink-50 p-6 w-full max-w-md shadow-2xl",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900 mb-2",children:"删除提示词模版"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["确定删除“",j.name,"”吗？此操作不可撤回。"]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:V,className:"px-5 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50",children:"取消"}),e.jsx("button",{onClick:B,className:"px-5 py-2 rounded-xl bg-red-500 text-white font-bold text-sm shadow-sm hover:bg-red-600",children:"确认删除"})]})]})})]})]})},ls=()=>e.jsx(xe,{children:e.jsx(ns,{})}),rs=t=>new Promise(r=>{const i=new FileReader;i.addEventListener("load",()=>r(i.result),!1),i.readAsDataURL(t)}),is=t=>new Promise((r,i)=>{const l=new Image;l.addEventListener("load",()=>r(l)),l.addEventListener("error",s=>i(s)),l.setAttribute("crossOrigin","anonymous"),l.src=t});function Ye({initialImage:t,onSave:r,onCancel:i}){const[l,s]=n.useState(t?"main":"upload"),[d,h]=n.useState(t||null),[m,p]=n.useState(null),j=async k=>{if(k.target.files&&k.target.files.length>0){const I=k.target.files[0],_=await rs(I);p(_),s("edit")}},C=k=>{h(k),r(k)};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200",children:e.jsxs("div",{className:"relative w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-200",children:[e.jsx(os,{step:l,onBack:()=>s(l==="edit"?"upload":"main"),onClose:i}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:[l==="main"&&e.jsx(cs,{avatarUrl:d,onChangeClick:()=>s("upload"),onRemoveClick:()=>{h(null),r(null)}}),l==="upload"&&e.jsx(ds,{onFileChange:j}),l==="edit"&&m&&e.jsx(xs,{imageSrc:m,onSave:C,onCancel:()=>s("upload")})]})]})})}function os({step:t,onBack:r,onClose:i}){let l="头像设置";return t==="upload"&&(l="更换头像"),t==="edit"&&(l="裁剪与旋转"),e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-100 shrink-0 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t!=="main"&&t!=="upload"&&e.jsx("button",{onClick:r,className:"p-2 -ml-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),t==="upload"&&r&&null,e.jsx("h2",{className:"text-lg font-cute text-pink-900",children:l})]}),e.jsx("button",{onClick:i,className:"p-2 -mr-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(ne,{size:20})})]})}function cs({avatarUrl:t,onChangeClick:r,onRemoveClick:i}){return e.jsxs("div",{className:"flex flex-col h-full bg-gray-50/50",children:[e.jsxs("div",{className:"p-8 flex flex-col items-center text-center flex-1 justify-center",children:[e.jsx("div",{className:"relative group mb-8",children:e.jsx("div",{className:"w-48 h-48 rounded-full overflow-hidden ring-8 ring-white shadow-2xl bg-gray-200 flex items-center justify-center",children:t?e.jsx("img",{src:t,alt:"Profile",className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-6xl font-medium text-gray-400",children:"?"})})}),e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"设置一个好看的头像，让角色更具吸引力"})]}),e.jsxs("div",{className:"flex items-stretch border-t border-gray-100 bg-white divide-x divide-gray-100",children:[e.jsxs("button",{onClick:r,className:"flex-1 py-4 flex items-center justify-center gap-2 text-pink-600 hover:bg-pink-50 transition-colors font-bold text-sm",children:[e.jsx(ot,{size:16}),"更换头像"]}),e.jsxs("button",{onClick:i,className:"flex-1 py-4 flex items-center justify-center gap-2 text-gray-400 hover:bg-red-50 hover:text-red-500 transition-colors font-bold text-sm",children:[e.jsx(Te,{size:16}),"移除头像"]})]})]})}function ds({onFileChange:t}){const[r,i]=n.useState(!1),l=n.useRef(null),s=m=>{m.preventDefault(),i(!0)},d=m=>{m.preventDefault(),i(!1)},h=m=>{m.preventDefault(),i(!1),m.dataTransfer.files&&m.dataTransfer.files.length>0&&t({target:{files:m.dataTransfer.files}})};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 p-8 flex flex-col items-center justify-center",children:e.jsxs("div",{onDragOver:s,onDragLeave:d,onDrop:h,onClick:()=>l.current.click(),className:`w-full max-w-xs aspect-square rounded-3xl flex flex-col items-center justify-center transition-all duration-300 cursor-pointer border-2 border-dashed ${r?"bg-pink-50 border-pink-400 scale-105":"bg-gray-50 border-gray-200 hover:border-pink-300 hover:bg-pink-50/30"}`,children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-white shadow-sm flex items-center justify-center mb-4 text-pink-500",children:e.jsx(Ee,{size:32})}),e.jsx("p",{className:"text-gray-600 font-bold mb-1",children:"点击或拖拽上传"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"支持 JPG, PNG, GIF"})]})}),e.jsx("input",{type:"file",ref:l,onChange:t,className:"hidden",accept:"image/*"})]})}function xs({imageSrc:t,onSave:r,onCancel:i}){const l=n.useRef(null),[s,d]=n.useState(null),[h,m]=n.useState(!1),[p,j]=n.useState(0),[C,k]=n.useState({x:0,y:0}),[I,_]=n.useState(!1),[u,g]=n.useState({x:0,y:0}),[b,S]=n.useState(1),[E,o]=n.useState(1),v=800,c=600;n.useEffect(()=>{(async()=>{try{const w=await is(t);d(w);const x=v/w.width,z=v/w.height,y=Math.max(x,z);S(y),o(1)}catch(w){console.error(w)}})()},[t]);const N=L=>{L.preventDefault();const w=L.deltaY*-.001;o(x=>Math.max(.5,Math.min(x+w,3)))},V=n.useCallback(()=>{if(!s||!l.current)return;const w=l.current.getContext("2d");w.clearRect(0,0,v,v),w.fillStyle="#18181b",w.fillRect(0,0,v,v),w.save(),w.translate(v/2,v/2),w.rotate(p*Math.PI/180),w.translate(-v/2,-v/2);let x=p*Math.PI/180,z=C.x*Math.cos(-x)-C.y*Math.sin(-x),y=C.x*Math.sin(-x)+C.y*Math.cos(-x);const $=b*E,R=s.width*$,T=s.height*$,P=v/2,D=v/2;w.drawImage(s,P-R/2+z,D-T/2+y,R,T),w.restore();const O=(v-c)/2;w.fillStyle="rgba(0, 0, 0, 0.6)",w.beginPath(),w.rect(0,0,v,v),w.rect(O+c,O,-c,c),w.fill("evenodd")},[s,p,C,b,E]);n.useEffect(()=>{V()},[V]);const B=L=>{_(!0);const w=l.current.getBoundingClientRect(),x=L.clientX||L.touches[0].clientX,z=L.clientY||L.touches[0].clientY;g({x:x-w.left,y:z-w.top})},Y=L=>{if(!I)return;const w=l.current.getBoundingClientRect(),x=L.clientX||(L.touches?L.touches[0].clientX:0),z=L.clientY||(L.touches?L.touches[0].clientY:0),y=x-w.left,$=z-w.top,R=y-u.x,T=$-u.y;k(P=>({x:P.x+R,y:P.y+T})),g({x:y,y:$})},M=()=>{_(!1)},U=()=>{j(L=>(L+90)%360)},H=async()=>{if(!(!l.current||h)){m(!0);try{const L=document.createElement("canvas"),w=c;L.width=w,L.height=w;const x=L.getContext("2d"),z=(v-c)/2;x.drawImage(l.current,z,z,w,w,0,0,w,w);const y=await new Promise((T,P)=>{L.toBlob(D=>D?T(D):P(new Error("blob_failed")),"image/jpeg",.92)}),$=new File([y],`avatar_${Date.now()}.jpg`,{type:"image/jpeg"}),R=await Pe.avatar($);r(R.url)}catch(L){console.error(L)}finally{m(!1)}}};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 relative flex items-center justify-center bg-gray-900 overflow-hidden",children:e.jsx("canvas",{ref:l,width:v,height:v,onMouseDown:B,onMouseMove:Y,onMouseUp:M,onMouseLeave:M,onTouchStart:B,onTouchMove:Y,onTouchEnd:M,onWheel:N,className:"cursor-move max-w-full max-h-full",style:{width:"100%",height:"auto",maxHeight:"520px"}})}),e.jsxs("div",{className:"p-4 bg-white flex items-center justify-between border-t border-gray-100 gap-4",children:[e.jsxs("button",{onClick:U,className:"flex flex-col itemscenter gap-1 text-pink-600 hover:text-pink-700 transition text-xs font-bold px-2 py-2 rounded-xl hover:bg-pink-50 shrink-0",children:[e.jsx(tt,{size:20}),"旋转"]}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 max-w-[200px]",children:[e.jsx(at,{size:16,className:"text-gray-400 shrink-0"}),e.jsx("input",{type:"range",min:"0.5",max:"3",step:"0.1",value:E,onChange:L=>o(parseFloat(L.target.value)),className:"w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-500"}),e.jsx(st,{size:16,className:"text-gray-400 shrink-0"})]}),e.jsxs("div",{className:"flex gap-2 shrink-0",children:[e.jsx("button",{onClick:i,className:"px-4 py-2 rounded-xl text-gray-500 font-bold text-sm hover:bg-gray-100 transition-colors",children:"取消"}),e.jsx("button",{onClick:H,disabled:h,className:`px-5 py-2 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 transition-all ${h?"opacity-60 cursor-not-allowed":"hover:opacity-90"}`,children:h?"上传中...":"完成"})]})]})]})}const ms=({initialData:t,onCancel:r,mode:i="new",notify:l})=>{var ke;const[s,d]=n.useState({name:"",gender:"男",identity:"",tagline:"",tags:[],plotTheme:"",plotSummary:"",openingLine:"",styleExamples:["","",""],hobbies:"",experiences:"",published:!1,generatedPrompt:"",personality:"",relationship:"陌生人",customRelationship:"",sceneDescription:"",sceneGeneratedPrompt:"",avatar:"",characterType:"原创角色",age:"",occupation:""}),h=["陌生人","暧昧","恋爱中","冷战","分手"],[m,p]=n.useState(!1),[j,C]=n.useState(!0);n.useEffect(()=>{if(t){const a=h.includes(t.relationship);d({name:t.name||"",gender:t.gender||"男",identity:t.identity||"",tagline:t.tagline||"",tags:t.tags||[],plotTheme:t.plotTheme||"",plotSummary:t.plotSummary||"",openingLine:t.openingLine||t.opening||"",styleExamples:t.styleExamples||["","",""],hobbies:t.hobbies||"",experiences:t.experiences||"",published:t.status==="published",generatedPrompt:t.systemPrompt||"",personality:t.personality||"",relationship:a?t.relationship||"陌生人":"",customRelationship:a?"":t.relationship||"",avatar:t.avatar||"",sceneDescription:t.sceneDescription||"",sceneGeneratedPrompt:t.systemPromptScene||"",templateIdScene:t.sceneTemplateId?String(t.sceneTemplateId):"",characterType:t.characterType||t.type||"原创角色",age:t.age||"",occupation:t.occupation||""}),p(!a&&!!t.relationship),L(t.promptModelId||""),y(typeof t.promptTemperature=="number"?t.promptTemperature:t.promptTemperature||.1),x(t.sceneModelId||""),R(typeof t.sceneTemperature=="number"?t.sceneTemperature:t.sceneTemperature||.1)}},[t]);const[k,I]=n.useState(!1),[_,u]=n.useState(!1),[g,b]=n.useState(!1),[S,E]=n.useState(""),[o,v]=n.useState(!1),c=n.useRef(null),[N,V]=n.useState(!1),[B,Y]=n.useState(!1),M=n.useRef(null),U=n.useRef(null),[H,L]=n.useState(""),[w,x]=n.useState(""),[z,y]=n.useState(.1),[$,R]=n.useState(.1),[T,P]=n.useState([]),[D,O]=n.useState(!1),[X,se]=n.useState(""),[re,me]=n.useState([]),[pe,he]=n.useState(!1),W=["M/M","M/F","BL","BG","耽美","百合","责任感","偶像","占有欲","霸道","调戏","腹黑","温柔","年下","年上","感性","体贴","理性","反差","激情","校园","贴心","偏执","疯批","傲娇","职场","冷漠","忧郁","人夫","养胃","控制欲","黏人","可爱","成熟","性感"];n.useEffect(()=>{const a=A=>{o&&c.current&&!c.current.contains(A.target)&&v(!1),N&&M.current&&!M.current.contains(A.target)&&V(!1),B&&U.current&&!U.current.contains(A.target)&&Y(!1)},f=A=>{A.key==="Escape"&&(v(!1),V(!1),Y(!1))};return document.addEventListener("mousedown",a),document.addEventListener("keydown",f),()=>{document.removeEventListener("mousedown",a),document.removeEventListener("keydown",f)}},[o,N,B]),n.useEffect(()=>{(async()=>{try{const a=await je.list(),f=A=>{const ue=(A.model_nickname||"").match(/^模型-([A-Z])$/i);return ue?ue[1].toUpperCase():A.model_name||A.model_id||""};P((a.items||[]).sort((A,G)=>f(A).localeCompare(f(G))))}catch{}})()},[]),n.useEffect(()=>{(async()=>{try{he(!0);const a=await ge.list();me(a.items||[])}catch{}finally{he(!1)}})()},[]);const J=a=>{const f=T.find(A=>A.model_id===a);return f?f.model_nickname||f.model_name||f.model_id:"-- 请选择 --"},K=s.templateIdScene?(ke=re.find(a=>a.id===parseInt(s.templateIdScene)))==null?void 0:ke.name:"-- 请选择 --",Q=async()=>{v(!o)},le=async()=>{I(!0),d(a=>({...a,generatedPrompt:""}));try{const a={model:H||void 0,temperature:z===""?void 0:parseFloat(z),sourcePrompt:s.sceneGeneratedPrompt||""},f=await Be.generateNoScene(a);d(A=>({...A,generatedPrompt:f.prompt||""}))}catch{}finally{I(!1)}},ae=a=>{d(f=>({...f,templateIdScene:a})),v(!1)},Z=a=>{p(!1),d(f=>({...f,relationship:a,customRelationship:""}))},ee=()=>{p(!0),d(a=>({...a,relationship:""}))},ie=(a,f)=>{const A=[...s.styleExamples];A[a]=f,d(G=>({...G,styleExamples:A}))};return e.jsxs("div",{className:"animate-fade-in pb-20",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:r,className:"w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-500 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:t?"编辑角色":"创建新角色"}),e.jsx("p",{className:"text-gray-400 text-xs",children:t?"修改角色设定与提示词":"填写设定并生成专属提示词"})]}),e.jsxs("div",{className:"ml-auto flex gap-3",children:[e.jsx("button",{onClick:r,className:"px-6 py-2.5 rounded-xl bg-white text-gray-500 font-bold text-sm shadow-sm hover:bg-gray-50",children:"取消"}),e.jsxs("button",{onClick:async()=>{if(!s.name||!s.name.trim()){l&&l("保存失败：请输入角色名称","error");return}const a={name:s.name.trim(),gender:s.gender,sceneTemplateId:s.templateIdScene?parseInt(s.templateIdScene):(t==null?void 0:t.sceneTemplateId)??null,identity:s.identity||null,tagline:s.tagline||null,personality:s.personality||null,relationship:m?s.customRelationship||null:s.relationship||null,plotTheme:s.plotTheme||null,plotSummary:s.plotSummary||null,openingLine:s.openingLine||null,systemPrompt:s.generatedPrompt||null,systemPromptScene:s.sceneGeneratedPrompt||null,promptModelId:H||null,promptTemperature:z===""?null:parseFloat(z),sceneModelId:w||null,sceneTemperature:$===""?null:parseFloat($),hobbies:s.hobbies||null,experiences:s.experiences||null,status:s.published?"published":"draft",tags:s.tags||[],styleExamples:s.styleExamples||[],avatar:s.avatar||null,characterType:s.characterType||null,age:s.age===""?null:parseInt(s.age,10),occupation:s.occupation||null};try{i==="edit"&&(t!=null&&t.id)?(await be.update(t.id,a),l&&l("保存成功：角色已更新")):(await be.create(a),l&&l("保存成功：角色已保存")),r()}catch(f){console.error("[characters.save] failed",{mode:i,payload:a,error:f}),l&&l("保存失败：请稍后重试","error")}},className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(fe,{size:16})," 保存角色"]})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsxs("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:[e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-4",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 角色类型设置"]}),e.jsx("div",{className:"flex flex-wrap gap-3",children:["原创角色","二次创作","其他"].map(a=>e.jsx("button",{onClick:()=>d({...s,characterType:a}),className:`px-6 py-3 rounded-2xl text-sm font-bold transition-all ${s.characterType===a?"bg-pink-500 text-white shadow-md":"bg-white text-gray-500 hover:text-pink-600"}`,children:a},a))})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 基础设定"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色名称"}),e.jsx("input",{value:s.name,onChange:a=>d({...s,name:a.target.value}),type:"text",className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"角色姓名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"性别"}),e.jsx("div",{className:"flex bg-gray-50 p-1 rounded-xl border border-gray-200",children:["男","女","其他"].map(a=>e.jsx("button",{onClick:()=>d({...s,gender:a}),className:`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${s.gender===a?"bg-pink-500 text-white shadow-md":"text-gray-400 hover:text-pink-500"}`,children:a},a))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"年龄"}),e.jsx("input",{value:s.age,onChange:a=>d({...s,age:a.target.value}),type:"number",min:"0",max:"200",className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"年龄"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"职业"}),e.jsx("input",{value:s.occupation,onChange:a=>d({...s,occupation:a.target.value}),type:"text",className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"职业"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"身份背景 (Identity)"}),e.jsx("textarea",{value:s.identity,onChange:a=>d({...s,identity:a.target.value}),rows:"3",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none",placeholder:"角色的年龄、职业、过往经历..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"一句话人设 (Tagline)"}),e.jsx("input",{value:s.tagline,onChange:a=>d({...s,tagline:a.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"例如：表面温柔克己实则腹黑"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"性格 (Personality)"}),e.jsx("textarea",{value:s.personality,onChange:a=>d({...s,personality:a.target.value}),rows:"2",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none",placeholder:"例：占有欲强，容易吃醋..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色标签"}),e.jsxs("div",{onClick:()=>O(!0),className:"dream-input w-full px-3 py-2 min-h-[46px] flex flex-wrap gap-2 items-center bg-white/60 cursor-pointer hover:bg-white transition rounded-2xl border border-pink-100",children:[s.tags.length===0&&e.jsx("span",{className:"text-xs text-[#B3A4C8] ml-1",children:"点击添加标签 (#傲娇 #高冷...)"}),s.tags.map(a=>e.jsxs("span",{className:"tag-pill px-2 py-1 flex items-center shadow-sm",children:["#",a,e.jsx("button",{onClick:f=>{f.stopPropagation(),d(A=>({...A,tags:A.tags.filter(G=>G!==a)}))},className:"ml-1 opacity-60 hover:opacity-100",children:e.jsx(ne,{size:12})})]},a)),e.jsx("span",{className:"ml-auto text-pink-300 text-xs",children:"›"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"当下的关系"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[e.jsx("button",{onClick:ee,className:`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${m?"bg-pink-500 text-white shadow-md border-pink-500":"bg-white text-gray-500 border-gray-200 hover:border-pink-300"}`,children:"自定义"}),h.map(a=>e.jsx("button",{onClick:()=>Z(a),className:`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${!m&&s.relationship===a?"bg-pink-500 text-white shadow-md border-pink-500":"bg-white text-gray-500 border-gray-200 hover:border-pink-300"}`,children:a},a))]}),m&&e.jsx("div",{className:"animate-fade-in mt-2",children:e.jsx("input",{type:"text",value:s.customRelationship,onChange:a=>d({...s,customRelationship:a.target.value}),className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm",placeholder:"请输入自定义关系"})})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 第一情节"]}),e.jsxs("div",{className:"bg-pink-50 border border-pink-100 rounded-2xl p-4 flex gap-3 text-pink-700 text-sm leading-relaxed",children:[e.jsx(Ke,{size:18,className:"flex-shrink-0 mt-0.5 text-pink-500"}),e.jsx("div",{children:"第一情节的内容将被应用于和角色的第一次聊天。此外，设定第一情节并选择公开角色后，情节内容将显示在角色资料页上。"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"主题"}),e.jsx("input",{value:s.plotTheme,onChange:a=>d({...s,plotTheme:a.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"例：当温柔人夫终于爆发腹黑属性"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"情节梗概"}),e.jsx("textarea",{value:s.plotSummary,onChange:a=>d({...s,plotSummary:a.target.value}),rows:"4",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none",placeholder:"例：在一起这么久了，他还是一如既往的温柔体贴，从来不干涉你的个人生活。今天晚上你去酒吧玩，故意装作喝醉和他打电话，却在他应了一声后开始软声叫着别人的名字......"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"开场白"}),e.jsx("input",{value:s.openingLine,onChange:a=>d({...s,openingLine:a.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"例：“出来，我在酒吧门口”"})]})]}),e.jsxs("div",{className:"solid-card rounded-3xl overflow-hidden",children:[e.jsxs("div",{className:"p-8 pb-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>C(!j),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"}),e.jsx("h3",{className:"font-cute text-lg text-pink-900",children:"进阶设定"}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 bg-pink-100 text-pink-600 rounded",children:"可选"})]}),e.jsx(Xe,{size:20,className:`text-gray-400 transition-transform duration-300 ${j?"rotate-180":""}`})]}),j&&e.jsxs("div",{className:"p-8 pt-0 space-y-6 animate-in slide-in-from-top-4 fade-in duration-300",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-3",children:"说话风格示例"}),e.jsx("div",{className:"space-y-3",children:[0,1,2].map(a=>e.jsxs("div",{className:"relative flex items-center gap-3",children:[e.jsxs("span",{className:"text-xs font-bold text-pink-300 font-mono",children:["0",a+1]}),e.jsx("input",{type:"text",value:s.styleExamples[a]||"",onChange:f=>ie(a,f.target.value),className:"dream-input flex-1 px-4 py-3 rounded-xl text-sm",placeholder:a===0?"例：哼，别以为我会感谢你。":a===1?"例：今晚月色真美，不一起走走吗？":"例：再靠近一步，我就不客气了。"})]},a))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"爱好"}),e.jsx("textarea",{value:s.hobbies,onChange:a=>d({...s,hobbies:a.target.value}),rows:"3",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none",placeholder:"例：喜欢看书、收集古董怀表..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"经历"}),e.jsx("textarea",{value:s.experiences,onChange:a=>d({...s,experiences:a.target.value}),rows:"4",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none",placeholder:"请填写角色个人经历或你们的共同经历"})]})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl relative overflow-visible bg-gradient-to-r from-pink-50 to-pink-100 border-pink-100",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 mb-4 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 角色提示词配置（带场景描述）"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色提示词AI模型（场景）"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative z-50 flex-1",ref:U,children:[e.jsxs("button",{onClick:()=>Y(!B),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${B?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${w?"text-gray-700":"text-gray-400 font-normal"}`,children:J(w)}),e.jsx("div",{className:`text-pink-400 transition-transform ${B?"rotate-180":""}`,children:"▼"})]}),B&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:T.length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无模型"}):T.map(a=>e.jsx("li",{onClick:()=>{x(a.model_id),Y(!1)},className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${w===a.model_id?"bg-pink-100 font-bold text-pink-700":""}`,children:a.model_nickname||a.model_name||a.model_id},a.id))})]}),e.jsxs("div",{className:"flex items-center gap-2 min-w-[140px] justify-end",children:[e.jsx("input",{type:"number",min:"0",max:"2",step:"0.05",value:$,onChange:a=>R(a.target.value),className:"dream-input w-24 px-2 py-3 rounded-xl text-sm font-bold text-center"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ze,{size:18,className:"text-pink-400 cursor-help"}),e.jsx("div",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-48 p-3 bg-white/90 backdrop-blur-sm border border-pink-100 text-pink-900 text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none text-center",children:"温度：高数值输出随机，低数值输出集中。"})]})]})]})]}),e.jsxs("div",{className:"flex gap-4 items-end mt-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"选择基础模版"}),e.jsxs("div",{className:"relative z-20 flex-1",ref:c,children:[e.jsxs("button",{onClick:Q,className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${o?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${s.templateIdScene?"text-gray-700":"text-gray-400 font-normal"}`,children:K}),e.jsx("div",{className:`text-pink-400 transition-transform ${o?"rotate-180":""}`,children:"▼"})]}),o&&e.jsxs("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:[e.jsx("li",{onClick:()=>ae(""),className:"px-4 py-3 text-sm text-gray-400 hover:bg-pink-50 cursor-pointer border-b border-pink-50",children:"-- 请选择 --"}),pe?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"加载中..."}):re.map(a=>e.jsxs("li",{onClick:()=>ae(a.id.toString()),className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${s.templateIdScene==a.id?"bg-pink-100 font-bold text-pink-700":""}`,children:[a.name," (",a.type,")"]},a.id))]})]})]}),e.jsxs("button",{onClick:async()=>{if(!s.templateIdScene)return alert("请先选择一个提示词模版");u(!0),d(a=>({...a,sceneGeneratedPrompt:""}));try{const a=re.find(G=>G.id===parseInt(s.templateIdScene)),f={templateContent:(a==null?void 0:a.content)||"",model:w||void 0,temperature:$===""?void 0:parseFloat($),name:s.name,gender:s.gender,age:s.age,occupation:s.occupation,identity:s.identity,tagline:s.tagline,tags:s.tags,personality:s.personality,relationship:m?s.customRelationship:s.relationship,styleExamples:s.styleExamples,hobbies:s.hobbies,experiences:s.experiences},A=await Be.generate(f);d(G=>({...G,sceneGeneratedPrompt:A.prompt||""}))}catch{}finally{u(!1)}},disabled:_,className:"px-6 py-3 rounded-xl bg-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed min-w-[140px] justify-center z-0",children:[_?e.jsx("span",{className:"animate-spin",children:e.jsx(Ue,{size:16})}):e.jsx(Me,{size:16,className:"text-yellow-300"}),_?"生成中...":"生成提示词"]})]}),e.jsx("p",{className:"text-xs text-pink-400 mt-2 ml-1",children:"* 将根据上方填写的设定，自动填充到模版占位符中"}),e.jsxs("div",{className:"mt-4 relative",children:[e.jsx("textarea",{rows:"12",value:s.sceneGeneratedPrompt,onChange:a=>d({...s,sceneGeneratedPrompt:a.target.value}),className:"dream-input w-full px-5 py-4 rounded-xl text-sm leading-relaxed font-mono text-gray-700 bg-white focus:bg-white resize-y shadow-inner",placeholder:"点击上方“生成提示词”按钮，或在此直接编写 Prompt..."}),!s.sceneGeneratedPrompt&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none opacity-30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(we,{size:48,className:"mx-auto mb-2 text-pink-300"}),e.jsx("p",{className:"text-sm font-bold text-pink-400",children:"等待生成..."})]})})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl relative overflow-visible bg-gradient-to-r from-pink-50 to-pink-100 border-pink-100",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 mb-4 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 角色提示词配置"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色提示词AI模型"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative z-50 flex-1",ref:M,children:[e.jsxs("button",{onClick:()=>V(!N),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${N?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${H?"text-gray-700":"text-gray-400 font-normal"}`,children:J(H)}),e.jsx("div",{className:`text-pink-400 transition-transform ${N?"rotate-180":""}`,children:"▼"})]}),N&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:T.length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无模型"}):T.map(a=>e.jsx("li",{onClick:()=>{L(a.model_id),V(!1)},className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${H===a.model_id?"bg-pink-100 font-bold text-pink-700":""}`,children:a.model_nickname||a.model_name||a.model_id},a.id))})]}),e.jsxs("div",{className:"flex items-center gap-2 min-w-[140px] justify-end",children:[e.jsx("input",{type:"number",min:"0",max:"2",step:"0.05",value:z,onChange:a=>y(a.target.value),className:"dream-input w-24 px-2 py-3 rounded-xl text-sm font-bold text-center"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ze,{size:18,className:"text-pink-400 cursor-help"}),e.jsx("div",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-48 p-3 bg-white/90 backdrop-blur-sm border border-pink-100 text-pink-900 text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none text-center",children:"温度：高数值输出随机，低数值输出集中。"})]})]}),e.jsxs("button",{onClick:le,disabled:k,className:"px-6 py-3 rounded-xl bg-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed min-w-[140px] justify-center z-0",children:[k?e.jsx("span",{className:"animate-spin",children:e.jsx(Ue,{size:16})}):e.jsx(Me,{size:16,className:"text-yellow-300"}),k?"生成中...":"生成提示词"]})]})]}),e.jsx("p",{className:"text-xs text-pink-400 mt-2 ml-1",children:"* 将根据上方输出的提示词，进行二次生成不带场景描述的提示词。"}),e.jsxs("div",{className:"mt-4 relative",children:[e.jsx("textarea",{rows:"12",value:s.generatedPrompt,onChange:a=>d({...s,generatedPrompt:a.target.value}),className:"dream-input w-full px-5 py-4 rounded-xl text-sm leading-relaxed font-mono text-gray-700 bg-white focus:bg-white resize-y shadow-inner",placeholder:"点击上方“生成提示词”按钮，或在此直接编写 Prompt..."}),!s.generatedPrompt&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none opacity-30",children:e.jsxs("div",{className:"text-center",children:[e.jsx(we,{size:48,className:"mx-auto mb-2 text-pink-300"}),e.jsx("p",{className:"text-sm font-bold text-pink-400",children:"等待生成..."})]})})]})]})]}),e.jsxs("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:[e.jsxs("div",{className:"glass-card p-6 rounded-3xl flex flex-col items-center text-center",children:[e.jsx("h3",{className:"font-cute text-pink-900 mb-4 w-full text-left border-b border-pink-100 pb-2",children:"头像预览"}),e.jsxs("div",{onClick:()=>b(!0),className:"w-32 h-32 rounded-full bg-gray-100 border-4 border-white shadow-xl flex items-center justify-center mb-4 relative group cursor-pointer overflow-hidden",children:[s.avatar?e.jsx("img",{src:s.avatar,alt:"Avatar",className:"w-full h-full object-cover"}):e.jsx("div",{className:"text-4xl text-gray-300 font-bold",children:s.name?s.name[0]:"?"}),e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-bold",children:"更换头像"})]}),e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:"flex items-center justify-between p-4 bg-white/50 rounded-xl cursor-pointer hover:bg-white transition-colors border border-pink-50",children:[e.jsx("span",{className:"text-sm font-bold text-gray-700",children:"发布到广场"}),e.jsx("div",{onClick:()=>d({...s,published:!s.published}),className:`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${s.published?"bg-pink-500":"bg-gray-300"}`,children:e.jsx("div",{className:`w-4 h-4 rounded-full bg-white shadow-sm transform transition-transform duration-300 ${s.published?"translate-x-6":""}`})})]}),e.jsx("p",{className:"text-xs text-left text-gray-400 mt-2 px-1",children:"开启后，该角色将出现在公共广场，所有用户可见。"})]})]}),e.jsxs("div",{className:"glass-card p-6 rounded-3xl bg-gradient-to-br from-pink-500 to-pink-600 text-white",children:[e.jsxs("h4",{className:"font-bold mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"inline-block",children:e.jsx(Me,{size:16,className:"text-yellow-300"})})," 提示"]}),e.jsx("p",{className:"text-xs opacity-90 leading-relaxed",children:"好的 Prompt 决定了角色的灵魂。建议生成后仔细检查，补充更多细节。"})]})]})]}),D&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50",onClick:()=>O(!1)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-4xl rounded-3xl bg-white p-6 shadow-2xl border border-pink-50",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("button",{onClick:()=>O(!1),className:"w-8 h-8 rounded-full bg-pink-50 text-pink-800 flex items-center justify-center",children:"‹"}),e.jsx("h3",{className:"text-lg font-bold font-cute text-pink-900",children:"添加 #标签"}),e.jsx("button",{onClick:()=>O(!1),className:"text-sm font-bold text-pink-600 bg-pink-50 px-3 py-1 rounded-full",children:"完成"})]}),e.jsxs("div",{className:"space-y-6 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-gray-400 mb-2 ml-1",children:"选定的标签"}),e.jsx("div",{className:"flex flex-wrap gap-2 min-h-[46px] bg-pink-50/50 p-3 rounded-xl border border-pink-100 border-dashed",children:s.tags.length===0?e.jsx("span",{className:"text-xs text-gray-400",children:"暂无标签"}):s.tags.map(a=>e.jsxs("button",{onClick:()=>d(f=>({...f,tags:f.tags.filter(A=>A!==a)})),className:"bg-pink-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm flex items-center gap-1",children:["#",a," ",e.jsx("span",{className:"text-[10px] ml-1 opacity-80",children:"×"})]},a))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-gray-400 mb-2 ml-1",children:"直接添加 (自定义)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:X,onChange:a=>se(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){a.preventDefault();const f=X.trim();f&&d(A=>A.tags.includes(f)?A:{...A,tags:[...A.tags,f]}),se("")}},type:"text",placeholder:"输入标签，不用加#",className:"dream-input flex-1 px-4 py-2 text-sm bg-white rounded-xl"}),e.jsx("button",{onClick:()=>{const a=X.trim();a&&d(f=>f.tags.includes(a)?f:{...f,tags:[...f.tags,a]}),se("")},className:"bg-gradient-to-r from-pink-400 to-pink-500 text-white px-4 rounded-xl font-bold text-sm shadow-md active:scale-95 transition",children:"添加"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-gray-400 mb-2 ml-1",children:"标签选择"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:W.map(a=>e.jsxs("button",{onClick:()=>d(f=>({...f,tags:f.tags.includes(a)?f.tags.filter(A=>A!==a):[...f.tags,a]})),className:`tag-select-btn flex items-center justify-center ${s.tags.includes(a)?"active":""}`,children:["#",a]},a))})]})]})]})})]}),g&&e.jsx(Ye,{initialImage:s.avatar||null,onSave:async a=>{try{const f=await Pe.avatar(a);d(A=>({...A,avatar:f.url}))}catch{}b(!1)},onCancel:()=>b(!1)}),g&&e.jsx(Ye,{initialImage:s.avatar,onSave:a=>{d(f=>({...f,avatar:a})),b(!1)},onCancel:()=>b(!1)})]})},ps=({creatorRole:t})=>{const[r,i]=n.useState("list"),[l,s]=n.useState(null),[d,h]=n.useState([]),[m,p]=n.useState("new"),{showToast:j}=de(),[C,k]=n.useState(null),I=300,_=async()=>{try{const c=t?{creator_role:t}:{},N=await be.list(c);h(N.items||[])}catch{j("加载失败","error")}};n.useEffect(()=>{_()},[t]);const u=c=>{s(c),p("edit"),i("create")},g=()=>{s(null),p("new"),i("create")},b=c=>{const N={...c,id:void 0,name:`${c.name}_copy`,status:"draft"};s(N),p("copy"),i("create"),j("复制成功，已进入编辑")},S=async(c,N)=>{try{await be.setStatus(c,N==="published"?"draft":"published"),await _()}catch{j("操作失败","error")}},E=c=>k(c),o=()=>k(null),v=async()=>{if(C)try{await be.remove(C.id),j("删除成功"),await _()}catch{j("删除失败","error")}finally{o()}};return r==="create"?e.jsx(ms,{initialData:l,onCancel:()=>{i("list"),_()},mode:m,notify:j}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"}),t==="user_role"?"用户角色":"官方角色"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:t==="user_role"?"查看用户创建的角色":"管理官方发布的 AI 角色"})]}),t!=="user_role"&&e.jsxs("button",{onClick:g,className:"bg-gradient-to-r from-pink-500 to-pink-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-pink-200 hover:opacity-90 transition-all flex items-center gap-2 text-sm",children:[e.jsx(ce,{size:16})," 创建角色"]})]}),e.jsx("div",{className:"grid gap-6",style:{gridTemplateColumns:"repeat(auto-fit, minmax(320px, 360px))"},children:d.map(c=>e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"glass-card p-4 rounded-3xl hover:shadow-xl transition-all group relative overflow-hidden h-[220px] flex flex-col",children:[e.jsx("div",{className:`absolute top-4 right-4 text-xs px-2 py-0.5 rounded-md font-bold ${c.status==="published"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-500"}`,children:c.status==="published"?"已发布":"草稿"}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-pink-200 to-pink-300 flex items-center justify-center text-white text-xl font-bold shadow-inner border-2 border-white overflow-hidden flex-shrink-0",children:c.avatar?e.jsx("img",{src:c.avatar,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx("span",{children:c.name?c.name[0]:"?"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 truncate",children:c.name}),e.jsxs("div",{className:"text-xs text-gray-400 truncate",children:[c.age!=null&&c.age!==""?`${c.age}岁`:"",c.occupation?`${c.age!=null&&c.age!==""?" · ":""}${c.occupation}`:""]})]}),e.jsx("div",{className:"flex gap-1 mt-2 flex-nowrap whitespace-nowrap overflow-hidden",style:{maxWidth:I},children:c.tags.map(N=>e.jsxs("span",{className:"text-[10px] bg-pink-50 text-pink-600 px-1.5 py-0.5 rounded border border-pink-100",children:["#",N]},N))})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("p",{className:"text-gray-600 text-sm leading-relaxed break-words",children:c.tagline||"暂无一句话人设"})}),e.jsxs("div",{className:"mt-auto flex gap-2 pt-3 border-t border-white/50",children:[e.jsxs("button",{onClick:()=>u(c),className:"flex-1 py-2 text-xs font-bold text-pink-600 bg-pink-50 hover:bg-pink-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Ie,{size:12})," 编辑"]}),e.jsxs("button",{onClick:()=>b(c),className:"flex-1 py-2 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(et,{size:12})," 复制"]}),c.status==="published"?e.jsxs("button",{onClick:()=>S(c.id,c.status),className:"flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Qe,{size:12})," 回收"]}):e.jsxs("button",{onClick:()=>S(c.id,c.status),className:"flex-1 py-2 text-xs font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Ze,{size:12})," 发布"]})]})]}),e.jsx("button",{onClick:()=>E(c),className:"absolute -top-2 -right-2 z-10 w-8 h-8 rounded-full bg-white/60 backdrop-blur-md shadow-lg border border-pink-100 flex items-center justify-center text-gray-400 hover:text-red-500 transition",children:e.jsx(ne,{size:12})})]},c.id))}),C&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50",onClick:o}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-pink-50 p-6 w-full max-w-md shadow-2xl",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900 mb-2",children:"删除角色"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["确定删除“",C.name,"”吗？此操作不可撤回。"]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:o,className:"px-5 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50",children:"取消"}),e.jsx("button",{onClick:v,className:"px-5 py-2 rounded-xl bg-red-500 text-white font-bold text-sm shadow-sm hover:bg-red-600",children:"确认删除"})]})]})})]})]})},qe=({creatorRole:t})=>e.jsx(xe,{children:e.jsx(ps,{creatorRole:t})}),hs=({user:t,selected:r,onSelectChange:i,onDelete:l,onChangePwd:s,onEditNickname:d,onEditStatus:h,onEditExpire:m})=>{const[p,j]=n.useState(!1),[C,k]=n.useState({}),I=n.useRef(null);n.useEffect(()=>{const u=b=>{I.current&&!I.current.contains(b.target)&&(b.target.closest(".user-row-menu")||j(!1))},g=()=>{p&&j(!1)};return p&&(document.addEventListener("mousedown",u),window.addEventListener("scroll",g,!0),window.addEventListener("resize",g)),()=>{document.removeEventListener("mousedown",u),window.removeEventListener("scroll",g,!0),window.removeEventListener("resize",g)}},[p]);const _=()=>{if(!p&&I.current){const u=I.current.getBoundingClientRect(),g=window.innerHeight-u.bottom,b=220;let S={position:"fixed",width:"100px",zIndex:9999};g<b?(S.bottom=`${window.innerHeight-u.top+8}px`,S.right=`${window.innerWidth-u.right}px`,S.transformOrigin="bottom right"):(S.top=`${u.bottom+8}px`,S.right=`${window.innerWidth-u.right}px`,S.transformOrigin="top right"),k(S)}j(u=>!u)};return e.jsxs("tr",{className:"hover:bg-pink-50/30 transition-colors",children:[e.jsx("td",{className:"p-5 pl-8",children:e.jsx("img",{src:t.avatar||"/uploads/avatars/default_avatar.jpg",alt:t.username,className:"w-10 h-10 rounded-full object-cover shadow-sm"})}),e.jsx("td",{className:"p-5 font-mono text-gray-500",children:t.id.toString().padStart(4,"0")}),e.jsxs("td",{className:"p-5",children:[e.jsx("div",{className:"font-bold text-gray-700",children:t.username}),e.jsx("div",{className:"text-xs text-gray-400",children:t.email})]}),e.jsx("td",{className:"p-5",children:e.jsx("div",{className:"text-xs text-gray-700",children:t.nickname||"-"})}),e.jsxs("td",{className:"p-5",children:[e.jsx("span",{className:"font-mono text-pink-600 font-bold",children:t.used})," 次"]}),e.jsx("td",{className:"p-5",children:e.jsx("span",{className:"font-mono text-gray-600",children:typeof t.expireMinutes=="number"?t.expireMinutes:"-"})}),e.jsx("td",{className:"p-5",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${t.isActive===1||t.isActive===!0?"bg-green-50 text-green-600":"bg-gray-100 text-gray-500"}`,children:t.isActive===1||t.isActive===!0?"Active":"Inactive"})}),e.jsx("td",{className:"p-5 text-right pr-8",children:e.jsxs("div",{className:"flex items-center gap-3 justify-end relative",children:[e.jsx("input",{type:"checkbox",checked:!!r,onChange:u=>i(t.id,u.target.checked)}),e.jsx("button",{ref:I,className:"p-1 rounded text-gray-500 hover:text-pink-600",onClick:_,"aria-label":"更多",children:e.jsx(ct,{size:16})}),p&&xt.createPortal(e.jsxs("div",{className:"user-row-menu bg-white rounded-xl shadow-xl ring-1 ring-pink-200 overflow-hidden animate-fade-in-up",style:C,children:[e.jsx("button",{className:"w-full text-left px-2 py-2 text-xs text-gray-700 hover:bg-pink-50 first:rounded-t-xl",onClick:()=>{j(!1),d&&d(t)},children:"修改昵称"}),e.jsx("button",{className:"w-full text-left px-2 py-2 text-xs text-gray-700 hover:bg-pink-50",onClick:()=>{j(!1),h&&h(t)},children:"修改用户状态"}),e.jsx("button",{className:"w-full text-left px-2 py-2 text-xs text-gray-700 hover:bg-pink-50",onClick:()=>{j(!1),m&&m(t)},children:"修改过期时间"}),e.jsx("button",{className:"w-full text-left px-2 py-2 text-xs text-gray-700 hover:bg-pink-50",onClick:()=>{j(!1),s&&s()},children:"修改密码"}),e.jsx("button",{className:"w-full text-left px-2 py-2 text-xs text-red-600 hover:bg-red-50 last:rounded-b-xl",onClick:()=>{j(!1),l&&l()},children:"删除"})]}),document.body)]})})]})},us=({onCancel:t,onSave:r,notify:i})=>{const[l,s]=n.useState({username:"",nickname:"",email:"",password:"",chatLimit:0,expireAfterMinutes:60}),d=m=>{const{name:p,value:j}=m.target;s(C=>({...C,[p]:["chatLimit","expireAfterMinutes"].includes(p)?parseInt(j)||0:j}))},h=()=>{if(!l.username||!l.password){i&&i("创建失败：请填写用户名和密码","error");return}const m={username:l.username,nickname:l.nickname||null,email:l.email||`${l.username.toLowerCase()}@example.com`,password:l.password,chatLimit:l.chatLimit,expireAfterMinutes:l.expireAfterMinutes};r(m)};return e.jsxs("div",{className:"animate-fade-in pb-10",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:t,className:"w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-500 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:"添加新用户"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"分配后台登录权限和聊天额度"})]}),e.jsxs("div",{className:"ml-auto flex gap-3",children:[e.jsx("button",{onClick:t,className:"px-6 py-2.5 rounded-xl bg白 text-gray-500 font-bold text-sm shadow-sm hover:bg-gray-50",children:"取消"}),e.jsxs("button",{onClick:h,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text白 font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(ce,{size:16})," 创建用户"]})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6 max-w-2xl mx-auto",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 用户基础信息"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"用户名"}),e.jsx("input",{type:"text",name:"username",value:l.username,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"为新用户设置一个用户名"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"昵称"}),e.jsx("input",{type:"text",name:"nickname",value:l.nickname,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"显示名称（可选）"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"邮箱"}),e.jsx("input",{type:"email",name:"email",value:l.email,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"用于联系与通知（可选）"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"密码 (初始密码)"}),e.jsx("input",{type:"password",name:"password",value:l.password,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"设置初始密码"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"聊天额度 (次数)"}),e.jsx("input",{type:"number",name:"chatLimit",value:l.chatLimit,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"0 表示默认无额度",min:"0"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"设置用户默认可用的聊天次数，0 次表示用户初始无额度。"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"登录后禁用时间 (分钟)"}),e.jsx("input",{type:"number",name:"expireAfterMinutes",value:l.expireAfterMinutes,onChange:d,className:"dream-input w-full px-4 py-3 rounded-xl text-sm font-bold text-gray-700",placeholder:"例如 60，表示首次登录后 1 小时禁用；0 表示不限制",min:"0"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"用于测试账号：首次登录成功后，达到该分钟数后自动禁用账号。默认 60 分钟，数字按分钟填写。"})]})]})]})},gs=({onCancel:t,notify:r})=>{const[i,l]=n.useState("upload"),[s,d]=n.useState(!1),[h,m]=n.useState(null),[p,j]=n.useState([]),C=n.useRef(null),[k,I]=n.useState(0),[_,u]=n.useState(20),g=n.useMemo(()=>Math.max(1,Math.ceil(p.length/_)),[p.length,_]),b=n.useMemo(()=>p.slice(k*_,k*_+_),[p,k,_]);n.useEffect(()=>{I(0)},[p,_]);const[S,E]=n.useState({ok:0,bad:0}),[o,v]=n.useState(null),c=()=>{try{window.dispatchEvent(new CustomEvent("admin.users.refresh",{detail:{at:Date.now()}}))}catch{}},N=()=>{const x=["用户名","昵称","邮箱","密码","聊天额度(次数)","登录后禁用时间(分钟)"].map(D=>`"${D}"`).join(","),z=["test_user","测试","example@test.com","Pass@123","0","60"].map(D=>`"${D}"`).join(","),$=`\uFEFF${x}\r
${z}\r
`,R=new Blob([$],{type:"text/csv;charset=utf-8"}),T=URL.createObjectURL(R),P=document.createElement("a");P.href=T,P.download="用户批量导入模板.csv",P.click(),setTimeout(()=>URL.revokeObjectURL(T),1e3)},V=x=>{const z=[];let y=0,$="";const R=O=>{O.push($),$=""},T=O=>{z.push(O),$=""};let P=[],D=!1;for(;y<x.length;){const O=x[y];if(D)O==='"'?x[y+1]==='"'?($+='"',y+=2):(D=!1,y++):($+=O,y++);else{if(O==='"'){D=!0,y++;continue}if(O===","){R(P),y++;continue}if(O==="\r"){y++;continue}if(O===`
`){R(P),T(P),P=[],y++;continue}$+=O,y++}}return R(P),P.length&&T(P),z.filter(O=>O.length&&O.some(X=>String(X).trim().length))},B=x=>{x.preventDefault(),x.stopPropagation(),x.type==="dragenter"||x.type==="dragover"?d(!0):x.type==="dragleave"&&d(!1)},Y=x=>{x.preventDefault(),x.stopPropagation(),d(!1),x.dataTransfer.files&&x.dataTransfer.files[0]&&U(x.dataTransfer.files[0])},M=x=>{var y;const z=(y=x.target.files)==null?void 0:y[0];z&&U(z)},U=x=>{const z=(x.size/1024/1024).toFixed(2);m({name:x.name,size:`${z} MB`,status:"uploading"}),l("analyzing");const y=new FileReader;y.onload=()=>{var $;try{const R=String(y.result||""),T=V(R),P=(($=T[0])==null?void 0:$.map(W=>String(W).trim()))||[],O=Object.fromEntries(["用户名","昵称","邮箱","密码","聊天额度(次数)","登录后禁用时间(分钟)"].map(W=>[W,P.indexOf(W)])),X=T.slice(1).map((W,J)=>{const K=ae=>{const Z=O[ae];return Z>=0?String(W[Z]??"").trim():""},Q={username:K("用户名"),nickname:K("昵称")||null,email:K("邮箱")||null,password:K("密码"),chatLimit:(()=>{const ae=K("聊天额度(次数)"),Z=parseInt(ae||"");return isNaN(Z)?0:Math.max(0,Z)})(),expireAfterMinutes:(()=>{const ae=K("登录后禁用时间(分钟)"),Z=parseInt(ae||"");return isNaN(Z)?60:Math.max(0,Z)})()},le=[];return Q.username||le.push("用户名必填"),Q.password||le.push("密码必填"),Q.chatLimit<0&&le.push("聊天额度需为非负整数"),Q.expireAfterMinutes<0&&le.push("禁用时间需为非负整数"),{idx:J+1,data:Q,errors:le,status:"pending"}}),se=new Set,re=new Set;X.forEach(W=>{const J=W.data.username;J&&(se.has(J)?re.add(J):se.add(J))});const me=new Set,pe=new Set;X.forEach(W=>{const J=W.data.email;J&&(me.has(J)?pe.add(J):me.add(J))});const he=X.map(W=>{const J=[...W.errors],K=W.data.username;K&&re.has(K)&&J.push("文件内用户名重复");const Q=W.data.email;return Q&&pe.has(Q)&&J.push("文件内邮箱重复"),{...W,errors:J}});j(he),m(W=>W?{...W,status:"success"}:null),l("preview")}catch{j([]),m(R=>R?{...R,status:"idle"}:null),l("upload"),r&&r("解析失败","error")}},y.readAsText(x,"utf-8")},H=()=>{m(null),j([]),l("upload"),C.current&&(C.current.value="")},L=async()=>{l("importing");const x=T=>new Promise(P=>setTimeout(P,T));let z=0,y=0;const $=[...p];for(let T=0;T<$.length;T++){const P=$[T];if(P.errors&&P.errors.length){$[T]={...P,status:"fail"},y++;continue}try{const D={username:P.data.username,nickname:P.data.nickname,email:P.data.email,password:P.data.password,chatLimit:P.data.chatLimit,expireAfterMinutes:P.data.expireAfterMinutes};await te.create(D),$[T]={...P,status:"success"},z++}catch(D){$[T]={...P,status:"fail",errors:[...P.errors||[],String((D==null?void 0:D.message)||"导入失败")]},y++}j([...$]),await x(3)}E({ok:z,bad:y});const R=y===0?"success":z>0?"partial":"fail";v(R),l("completed")},w=()=>{const x=p.filter(O=>O.status==="fail");if(!x.length)return;const z=["用户名","昵称","邮箱","密码","聊天额度(次数)","登录后禁用时间(分钟)","错误信息"].map(O=>`"${O}"`).join(","),y=x.map(O=>[O.data.username||"",O.data.nickname||"",O.data.email||"",O.data.password||"",String(O.data.chatLimit??""),String(O.data.expireAfterMinutes??""),O.errors&&O.errors.length?O.errors.join("；"):"导入失败"].map(se=>`"${String(se).replace(/"/g,'""')}"`).join(",")),R=`\uFEFF${z}\r
${y.join(`\r
`)}\r
`,T=new Blob([R],{type:"text/csv;charset=utf-8"}),P=URL.createObjectURL(T),D=document.createElement("a");D.href=P,D.download=`导入失败列表_${Date.now()}.csv`,D.click(),setTimeout(()=>URL.revokeObjectURL(P),1e3)};return e.jsxs("div",{className:"flex flex-col h-full animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[i!=="upload"&&i!=="completed"&&e.jsx("button",{onClick:H,className:"p-1 -ml-2 rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-700 transition-colors",children:e.jsx(Ae,{size:20})}),e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:i==="upload"?"批量导入用户":i==="preview"?"预览并确认":i==="importing"?"正在导入":"导入完成"})]}),e.jsx("button",{onClick:()=>{c(),t&&t()},className:"p-2 text-slate-400 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(ne,{size:20})})]}),e.jsxs("div",{className:"flex-1 min-h-0 relative",children:[i==="upload"&&e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:`w-full max-w-2xl h-80 rounded-3xl border-3 border-dashed transition-all duration-300 flex flex-col items-center justify-center cursor-pointer group relative z-10 bg-white ${s?"border-pink-500 bg-pink-50/30":"border-slate-200 hover:border-pink-300 hover:bg-slate-50"}`,onDragEnter:B,onDragLeave:B,onDragOver:B,onDrop:Y,onClick:()=>{var x;return(x=C.current)==null?void 0:x.click()},children:[e.jsx("input",{ref:C,type:"file",className:"hidden",accept:".csv",onChange:M}),e.jsx("div",{className:`p-6 rounded-full bg-slate-50 mb-6 transition-transform group-hover:scale-110 group-hover:bg-pink-100 shadow-sm ${s?"scale-110 bg-pink-100":""}`,children:e.jsx(Ee,{size:48,className:`transition-colors ${s||"group-hover:text-pink-500"} ${s?"text-pink-600":"text-slate-400"}`})}),e.jsx("h3",{className:"text-xl font-bold text-slate-800 mb-2",children:"点击或拖拽文件上传"}),e.jsx("p",{className:"text-slate-500 text-sm",children:"仅支持 .CSV，单次最大 50MB。"}),e.jsx("p",{className:"text-rose-600 text-sm mt-1",children:"用户名和邮箱必须唯一，不能重复，并且必须填写。"}),e.jsx("div",{className:"mt-6",children:e.jsxs("button",{onClick:x=>{x.stopPropagation(),N()},className:"px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm text-pink-600 hover:border-pink-200 transition-colors flex items-center gap-2 shadow-sm",children:[e.jsx(Re,{size:14})," 下载模板"]})})]})}),i==="analyzing"&&e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-2xl border border-slate-100 shadow-xl p-8 text-center",children:[e.jsxs("div",{className:"w-16 h-16 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-6 relative",children:[e.jsx(Fe,{size:32,className:"text-pink-500 animate-spin"}),e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-pink-100 opacity-50"})]}),e.jsx("h3",{className:"text-xl font-bold text-slate-800 mb-2",children:"正在解析数据..."}),e.jsx("p",{className:"text-slate-500 text-sm mb-6",children:"正在校验文件格式并预览数据。"}),e.jsx("div",{className:"w-full bg-slate-100 h-2 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-pink-500 to-rose-500 w-2/3 animate-loading-bar"})}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-2 text-xs text-slate-400",children:[e.jsx(we,{size:12}),h==null?void 0:h.name]})]})}),i==="preview"&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl p-5 mb-6 flex items-center justify-between shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center",children:e.jsx(we,{size:24})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-slate-800",children:h==null?void 0:h.name}),e.jsxs("div",{className:"flex gap-3 text-xs mt-1",children:[e.jsx("span",{className:"text-slate-500 bg-slate-100 px-2 py-0.5 rounded",children:h==null?void 0:h.size}),e.jsxs("span",{className:"text-slate-500 bg-slate-100 px-2 py-0.5 rounded",children:["共 ",p.length," 条记录"]})]})]})]}),e.jsx("button",{onClick:H,className:"p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-colors",title:"重新上传",children:e.jsx(ne,{size:18})})]}),e.jsxs("div",{className:"flex-1 bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-slate-700",children:"数据预览"}),e.jsxs("div",{className:"text-xs text-slate-400",children:["共 ",p.length," 行；每页 ",_," 行；第 ",k+1,"/",g," 页"]})]}),e.jsx("div",{className:"flex-1 overflow-auto max-h-[50vh] overflow-x-auto scroll-gray",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"bg-slate-50 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500 w-16",children:"#"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"用户名"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"昵称"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"邮箱"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"聊天额度(次数)"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"登录后禁用时间(分钟)"}),e.jsx("th",{className:"px-6 py-3 font-semibold text-slate-500",children:"状态"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100",children:b.map((x,z)=>e.jsxs("tr",{className:`${x.status==="fail"?"bg-rose-50/30":""}`,children:[e.jsx("td",{className:"px-6 py-3 text-slate-400 font-mono",children:k*_+z+1}),e.jsx("td",{className:"px-6 py-3 font-medium text-slate-700",children:x.data.username}),e.jsx("td",{className:"px-6 py-3 text-slate-600",children:x.data.nickname||""}),e.jsx("td",{className:"px-6 py-3 text-slate-600",children:x.data.email||""}),e.jsx("td",{className:"px-6 py-3 text-slate-600",children:x.data.chatLimit}),e.jsx("td",{className:"px-6 py-3 text-slate-600",children:x.data.expireAfterMinutes}),e.jsx("td",{className:"px-6 py-3",children:x.errors&&x.errors.length?e.jsxs("div",{className:"flex items-center gap-1.5 text-rose-600 text-xs font-medium",children:[e.jsx(dt,{size:14})," ",x.errors.join("；")]}):e.jsxs("div",{className:"flex items-center gap-1.5 text-emerald-600 text-xs font-medium",children:[e.jsx(Oe,{size:14})," 正常"]})})]},k*_+z))})]})}),e.jsxs("div",{className:"px-6 py-3 border-t border-slate-100 bg-white flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-500",children:["第 ",k+1," 页 / 共 ",g," 页"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-slate-500",children:"每页"}),e.jsxs("select",{value:_,onChange:x=>u(parseInt(x.target.value)||20),className:"dream-input px-3 py-1.5 rounded-lg text-sm",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]}),e.jsx("button",{onClick:()=>I(Math.max(0,k-1)),disabled:k===0,className:`w-8 h-8 rounded-full ${k===0?"bg-slate-200 text-slate-400":"bg-white text-slate-600 hover:bg-slate-50"} flex items-center justify-center border border-slate-200`,children:e.jsx(Ae,{size:16})}),e.jsx("button",{onClick:()=>I(Math.min(g-1,k+1)),disabled:k>=g-1,className:`w-8 h-8 rounded-full ${k>=g-1?"bg-slate-200 text-slate-400":"bg-white text-slate-600 hover:bg-slate-50"} flex items-center justify-center border border-slate-200`,children:e.jsx(Le,{size:16})})]})]})]})]}),i==="importing"&&e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"w-20 h-20 bg-pink-50 rounded-full flex items-center justify-center mx-auto mb-6 relative",children:[e.jsx(Fe,{size:32,className:"text-pink-500 animate-spin"}),e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-pink-100 border-t-pink-500 animate-spin"})]}),e.jsx("h2",{className:"text-2xl font-bold text-slate-800",children:"正在写入数据..."}),e.jsx("p",{className:"text-slate-500 mt-2",children:"请勿关闭窗口，这可能需要几秒钟。"})]})}),i==="completed"&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx("div",{className:`w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-sm ${o==="success"?"bg-emerald-50":o==="partial"?"bg-amber-50":"bg-rose-50"}`,children:e.jsx(Oe,{size:48,className:`${o==="success"?"text-emerald-500":o==="partial"?"text-amber-500":"text-rose-500"}`})}),e.jsx("h2",{className:"text-3xl font-bold text-slate-800 mb-2",children:o==="success"?"导入成功!":o==="partial"?"部分导入成功":"导入失败"}),e.jsx("p",{className:"text-slate-500 mb-8 text-center max-w-sm",children:o==="success"?`已成功导入 ${S.ok} 条数据。`:o==="partial"?`成功 ${S.ok} 条，失败 ${S.bad} 条。可返回修复后继续导入。`:`未成功导入数据。失败 ${S.bad} 条，请返回修复后重试。`}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>{c(),t&&t()},className:"px-8 py-3 bg-slate-900 text-white rounded-xl hover:bg-slate-800 font-medium transition-all shadow-lg shadow-slate-200",children:"返回列表"}),e.jsx("button",{onClick:()=>{m(null),j([]),E({ok:0,bad:0}),v(null),l("upload")},className:"px-8 py-3 bg-white text-slate-700 border border-slate-200 rounded-xl hover:bg-slate-50 font-medium transition-colors",children:"继续导入"}),S.bad>0&&e.jsxs("button",{onClick:w,className:"px-8 py-3 bg-white text-rose-600 border border-rose-200 rounded-xl hover:bg-rose-50 font-medium transition-colors flex items-center gap-2",children:[e.jsx(Re,{size:16})," 导出失败列表"]})]})]})]}),i==="preview"&&e.jsxs("div",{className:"mt-6 flex items-center justify-end gap-4 pt-4 border-t border-slate-100",children:[e.jsxs("div",{className:"mr-auto text-sm text-slate-500",children:[e.jsx("span",{className:"font-medium text-slate-700",children:p.filter(x=>!x.errors||x.errors.length===0).length})," 条数据准备就绪"]}),e.jsx("button",{onClick:t,className:"px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 hover:text-slate-900 transition-colors",children:"取消"}),e.jsxs("button",{onClick:L,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-rose-600 text白 font-medium shadow-lg shadow-pink-200 flex items-center gap-2 hover:shadow-pink-300 hover:-translate-y-0.5 transition-all",children:["确认导入",e.jsx(Le,{size:18})]})]})]})},fs=()=>{const[t,r]=n.useState([]),[i,l]=n.useState("list"),[s,d]=n.useState(""),[h,m]=n.useState(0),[p,j]=n.useState(10),[C,k]=n.useState(null),[I,_]=n.useState(""),[u,g]=n.useState(""),[b,S]=n.useState(null),[E,o]=n.useState(null),[v,c]=n.useState(""),[N,V]=n.useState(null),[B,Y]=n.useState(1),[M,U]=n.useState(null),[H,L]=n.useState(""),[w,x]=n.useState(!1),[z,y]=n.useState(new Set),[$,R]=n.useState(null),{showToast:T}=de(),[P,D]=n.useState(!1);n.useEffect(()=>{te.list().then(r).catch(()=>{});const a=()=>{te.list().then(r).catch(()=>{})};try{window.addEventListener("admin.users.refresh",a)}catch{}return()=>{try{window.removeEventListener("admin.users.refresh",a)}catch{}}},[]);const O=async a=>{try{const{id:f}=await te.create(a);r(A=>[...A,{...a,id:f,used:0}]),T(`用户 ${a.username} 创建成功`),l("list")}catch{T("创建失败","error")}},X=async a=>{try{await te.remove(a),r(f=>f.filter(A=>A.id!==a)),T("用户已删除")}catch{T("删除失败","error")}},se=(a,f)=>{y(A=>{const G=new Set(A);return f?G.add(a):G.delete(a),G})},re=()=>{const a=ie.map(f=>f.id);y(f=>{const A=new Set(f);return a.forEach(G=>A.add(G)),A})},me=()=>y(new Set),pe=()=>{const a=ie.map(f=>f.id).filter(f=>z.has(f));a.length&&R(a)},he=async()=>{const a=$||[];let f=0,A=0;for(let G=0;G<a.length;G++)try{await te.remove(a[G]),f++}catch{A++}r(G=>G.filter(ue=>!a.includes(ue.id))),R(null),me(),A===0?T(`已删除 ${f} 条用户`):T(`删除成功 ${f} 条，失败 ${A} 条`,"error")},W=b&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-80",children:[e.jsx("div",{className:"font-bold mb-3",children:"确认删除该用户？"}),e.jsx("p",{className:"text-sm text-gray-500 mb-5",children:"此操作不可恢复。"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>S(null),children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-red-500 text-white",onClick:()=>{const a=b.id;S(null),X(a)},children:"删除"})]})]})}),J=E&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96",children:[e.jsxs("div",{className:"font-bold mb-3",children:["修改用户 ",E.username," 昵称"]}),e.jsx("div",{className:"space-y-3",children:e.jsx("input",{type:"text",placeholder:"输入新昵称",className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700",value:v,onChange:a=>c(a.target.value)})}),e.jsxs("div",{className:"flex gap-2 justify-end mt-5",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{o(null),c("")},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:async()=>{try{await te.update(E.id,{nickname:v||null}),r(a=>a.map(f=>f.id===E.id?{...f,nickname:v||null}:f)),T("昵称已更新")}catch{T("更新失败","error")}o(null),c("")},children:"保存"})]})]})}),K=N&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96",children:[e.jsxs("div",{className:"font-bold mb-3",children:["修改用户 ",N.username," 状态"]}),e.jsx("div",{className:"flex justify-center my-6",children:e.jsxs("div",{className:"bg-gray-100 rounded-full p-1 flex relative w-48 h-10 cursor-pointer",onClick:()=>Y(a=>a===1?0:1),children:[e.jsx("div",{className:`absolute top-1 bottom-1 w-[calc(50%-4px)] rounded-full transition-all duration-300 shadow-sm ${B===1?"left-1 bg-white":"left-[calc(50%+2px)] bg-white"}`}),e.jsx("div",{className:`flex-1 flex items-center justify-center z-10 text-xs font-bold transition-colors duration-300 ${B===1?"text-green-500":"text-gray-400"}`,children:"Active"}),e.jsx("div",{className:`flex-1 flex items-center justify-center z-10 text-xs font-bold transition-colors duration-300 ${B===0?"text-red-500":"text-gray-400"}`,children:"Inactive"})]})}),e.jsxs("div",{className:"flex gap-2 justify-end mt-5",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{V(null)},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:async()=>{try{await te.update(N.id,{isActive:B}),r(a=>a.map(f=>f.id===N.id?{...f,isActive:B}:f)),T("状态已更新")}catch{T("更新失败","error")}V(null)},children:"保存"})]})]})}),Q=M&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96",children:[e.jsxs("div",{className:"font-bold mb-6",children:["修改用户 ",M.username," 过期时间"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm text-gray-600 font-bold",children:"过期时间（分钟）"}),e.jsx("input",{type:"number",placeholder:"输入分钟数",className:"dream-input w-32 px-3 py-2 rounded-xl text-sm font-bold text-gray-700 text-center",value:H,onChange:a=>L(a.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{className:"text-sm text-gray-600 font-bold",children:"清除首次登录时间"}),e.jsxs("div",{className:"bg-gray-100 rounded-full p-1 flex relative w-32 h-8 cursor-pointer",onClick:()=>x(a=>!a),children:[e.jsx("div",{className:`absolute top-1 bottom-1 w-[calc(50%-4px)] rounded-full transition-all duration-300 shadow-sm ${w?"left-1 bg-white":"left-[calc(50%+2px)] bg-white"}`}),e.jsx("div",{className:`flex-1 flex items-center justify-center z-10 text-xs font-bold transition-colors duration-300 ${w?"text-green-500":"text-gray-400"}`,children:"是"}),e.jsx("div",{className:`flex-1 flex items-center justify-center z-10 text-xs font-bold transition-colors duration-300 ${w?"text-gray-400":"text-red-500"}`,children:"否"})]})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end mt-8",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{U(null),L(""),x(!1)},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:async()=>{try{const a=H?parseInt(H):null;await te.update(M.id,{expireAfterMinutes:a,resetFirstLogin:w}),r(f=>f.map(A=>A.id===M.id?{...A,expireMinutes:a}:A)),T("过期设置已更新")}catch{T("更新失败","error")}U(null),L(""),x(!1)},children:"保存"})]})]})}),le=C&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96",children:[e.jsxs("div",{className:"font-bold mb-3",children:["为用户 ",C.username," 修改密码"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"password",placeholder:"输入新密码",className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700",value:I,onChange:a=>_(a.target.value)}),e.jsx("input",{type:"password",placeholder:"再次输入新密码",className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700",value:u,onChange:a=>g(a.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end mt-5",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{k(null),_(""),g("")},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:async()=>{if(!I||I!==u){T("两次输入密码不一致","error");return}try{await te.changePassword(C.id,I),T("密码已更新")}catch{T("更新失败","error")}k(null),_(""),g("")},children:"确认修改"})]})]})}),ae=Array.isArray($)&&$.length>0&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96",children:[e.jsx("div",{className:"font-bold mb-3",children:"批量删除当前页选中用户"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-5",children:["共 ",$.length," 条，删除后不可恢复。"]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>R(null),children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-red-500 text-white",onClick:he,children:"确认删除"})]})]})}),Z=t.filter(a=>{const f=(s||"").trim().toLowerCase();if(!f)return!0;const A=String(a.username||"").toLowerCase(),G=String(a.email||"").toLowerCase(),ue=String(a.nickname||"").toLowerCase();return A.includes(f)||G.includes(f)||ue.includes(f)}),ee=Math.max(1,Math.ceil(Z.length/p)),ie=Z.slice(h*p,h*p+p),ke=a=>{const f=Math.max(1,Math.min(ee,parseInt(a)||1));m(f-1)};return Ge.useEffect(()=>{h>=ee&&m(Math.max(0,ee-1))},[ee]),i==="create"?e.jsx(us,{onCancel:()=>l("list"),onSave:O,notify:T}):i==="import"?e.jsx(gs,{onCancel:()=>{l("list"),te.list().then(r).catch(()=>{})},notify:T}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[W,ae,le,J,K,Q,e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"})," 用户管理"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"监控用户使用情况与限额"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"搜索用户名/邮箱...",className:"dream-input pl-10 pr-4 py-2 rounded-xl text-sm w-64",value:s,onChange:a=>{d(a.target.value),m(0)}}),e.jsx(It,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-pink-300"})]}),e.jsxs("button",{onClick:()=>l("import"),className:"bg-white text-pink-600 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:bg-pink-50 transition-colors flex items-center gap-2 text-sm",children:[e.jsx(Vt,{size:16})," 批量添加"]}),e.jsxs("button",{onClick:()=>l("create"),className:"bg-pink-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-colors flex items-center gap-2 text-sm",children:[e.jsx(ce,{size:16})," 添加用户"]})]})]}),e.jsxs("div",{className:"glass-card rounded-3xl overflow-hidden",children:[e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-pink-50/50 text-pink-900 font-cute text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-5 pl-8",children:"头像"}),e.jsx("th",{className:"p-5",children:"用户 ID"}),e.jsx("th",{className:"p-5",children:"用户名 / 邮箱"}),e.jsx("th",{className:"p-5",children:"昵称"}),e.jsx("th",{className:"p-5",children:"已用次数"}),e.jsx("th",{className:"p-5",children:"过期时间（分钟）"}),e.jsx("th",{className:"p-5",children:"状态"}),e.jsx("th",{className:"p-5 text-right pr-8",children:"操作"})]})}),e.jsx("tbody",{className:"text-sm divide-y divide-pink-50",children:ie.length>0?ie.map(a=>e.jsx(hs,{user:a,selected:z.has(a.id),onSelectChange:se,onDelete:()=>S(a),onChangePwd:()=>k(a),onEditNickname:f=>{o(f),c(f.nickname||"")},onEditStatus:f=>{V(f),Y(f.isActive===1||f.isActive===!0?1:0)},onEditExpire:f=>{U(f),L(f.expireMinutes||""),x(!1)}},a.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"p-10 text-center text-gray-400",children:"未找到匹配的用户。"})})})]}),e.jsxs("div",{className:"p-4 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["总计 ",t.length," 条"]}),e.jsx("label",{className:"text-xs text-gray-600",children:"每页"}),e.jsxs("div",{className:"relative z-[200]",children:[e.jsx("button",{onClick:()=>D(a=>!a),className:`px-2.5 py-1 rounded-md text-xs bg-white text-gray-700 border border-gray-200 ${P?"ring-4 ring-pink-100/50 border-pink-500":""}`,children:p}),P&&e.jsx("ul",{className:"absolute bottom-full mb-1 min-w-[4rem] bg-white border border-pink-200 rounded-xl shadow-xl z-[200]",children:[10,20,50].map(a=>e.jsx("li",{onClick:()=>{j(a),m(0),D(!1)},className:"px-3 py-1.5 text-xs text-gray-700 hover:bg-pink-50 cursor-pointer",children:a},a))})]}),e.jsx("button",{onClick:()=>m(Math.max(0,h-1)),disabled:h===0,className:`px-2.5 py-1 rounded-md text-xs ${h===0?"bg-gray-200 text-gray-400":"bg-white text-gray-600 hover:bg-gray-50"} border border-gray-200`,children:"上一页"}),e.jsx("button",{onClick:()=>m(Math.min(ee-1,h+1)),disabled:h>=ee-1,className:`px-2.5 py-1 rounded-md text-xs ${h>=ee-1?"bg-gray-200 text-gray-400":"bg-white text-gray-600 hover:bg-gray-50"} border border-gray-200`,children:"下一页"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"跳转"}),e.jsx("input",{type:"number",min:"1",max:ee,defaultValue:h+1,onKeyDown:a=>{a.key==="Enter"&&ke(a.currentTarget.value)},className:"dream-input px-2 py-1 rounded-md text-xs text-center"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["/ ",ee," 页"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:re,className:"px-2.5 py-1 rounded-md text-xs bg-white text-gray-700 hover:bg-gray-50 border border-gray-200",children:"全选当页"}),e.jsx("button",{onClick:pe,disabled:!ie.some(a=>z.has(a.id)),className:`px-2.5 py-1 rounded-md text-xs border border-gray-200 ${ie.some(a=>z.has(a.id))?"bg-red-500 text-white hover:bg-red-600":"bg-gray-200 text-gray-400"}`,children:"批量删除"}),e.jsx("button",{onClick:me,className:"px-2.5 py-1 rounded-md text-xs bg-white text-gray-700 hover:bg-gray-50 border border-gray-200",children:"清空选择"})]})]})]})]})},bs=()=>e.jsx(xe,{children:e.jsx(fs,{})}),_e=({value:t,onChange:r})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",min:"0",max:"2",step:"0.05",value:t,onChange:i=>r(i.target.value),className:"dream-input w-24 px-2 py-3 rounded-xl text-sm font-bold text-center"}),e.jsxs("div",{className:"relative group",children:[e.jsx(ze,{size:18,className:"text-pink-400 cursor-help"}),e.jsx("div",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-48 p-3 bg-white/90 backdrop-blur-sm border border-pink-100 text-pink-900 text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none text-center",children:"温度：高数值输出随机，低数值输出集中。"})]})]}),ys=()=>{const[t,r]=n.useState([]),[i,l]=n.useState(""),[s,d]=n.useState(!1),h=n.useRef(null),[m,p]=n.useState(""),[j,C]=n.useState(!1),k=n.useRef(null),[I,_]=n.useState(""),[u,g]=n.useState(!1),b=n.useRef(null),[S,E]=n.useState(.1),[o,v]=n.useState(.1),[c,N]=n.useState(.1),[V,B]=n.useState(null),{showToast:Y}=de(),M=y=>{const $=t.find(R=>R.model_id===y);return $?$.model_name||$.model_id:"-- 请选择 --"},U=async()=>{try{const y=await je.list();r(y.items||[])}catch{Y("模型列表加载失败","error")}};n.useEffect(()=>{U(),(async()=>{try{const y=await Ve.get();l(y.selected_model),p(y.selected_chat_model),_(y.selected_story_model),E(Number(y.model_temperature||.1)),v(Number(y.chat_temperature||.1)),N(Number(y.story_temperature||.1)),B(y.default_template_id||null)}catch{Y("加载设置失败","error")}})()},[]),n.useEffect(()=>{const y=$=>{s&&h.current&&!h.current.contains($.target)&&d(!1),j&&k.current&&!k.current.contains($.target)&&C(!1),u&&b.current&&!b.current.contains($.target)&&g(!1)};return document.addEventListener("mousedown",y),()=>document.removeEventListener("mousedown",y)},[s,j,u]);const H=[...t].sort((y,$)=>(y.model_name||y.model_id).localeCompare($.model_name||$.model_id)),L=M(i),w=M(m),x=M(I),z=async()=>{try{await Ve.save({selected_model:i,selected_chat_model:m,selected_story_model:I,model_temperature:Number(S),chat_temperature:Number(o),story_temperature:Number(c),default_template_id:V}),Y("设置已保存")}catch{Y("保存失败","error")}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"}),"模型设置"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"配置全局模型与温度参数"})]})}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"}),"模型配置"]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色提示词AI模型"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative w-full max-w-md",ref:h,children:[e.jsxs("button",{onClick:()=>d(!s),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${s?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${i?"text-gray-700":"text-gray-400 font-normal"}`,children:L}),e.jsx("div",{className:`text-pink-400 transition-transform ${s?"rotate-180":""}`,children:"▼"})]}),s&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:H.length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无模型，请先添加"}):H.map(y=>e.jsx("li",{onClick:()=>{l(y.model_id),d(!1)},className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${i===y.model_id?"bg-pink-100 font-bold text-pink-700":""}`,children:y.model_name||y.model_id},y.id))})]}),e.jsx(_e,{value:S,onChange:E}),e.jsxs("button",{onClick:z,className:"px-6 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all flex items-center gap-2",children:[e.jsx(fe,{size:16})," 确认"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"角色聊天AI模型"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative w-full max-w-md",ref:k,children:[e.jsxs("button",{onClick:()=>C(!j),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${j?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${m?"text-gray-700":"text-gray-400 font-normal"}`,children:w}),e.jsx("div",{className:`text-pink-400 transition-transform ${j?"rotate-180":""}`,children:"▼"})]}),j&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:H.length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无模型，请先添加"}):H.map(y=>e.jsx("li",{onClick:()=>{p(y.model_id),C(!1)},className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${m===y.model_id?"bg-pink-100 font-bold text-pink-700":""}`,children:y.model_name||y.model_id},y.id))})]}),e.jsx(_e,{value:o,onChange:v}),e.jsxs("button",{onClick:z,className:"px-6 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all flex items-center gap-2",children:[e.jsx(fe,{size:16})," 确认"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"故事生成AI模型"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative w-full max-w-md",ref:b,children:[e.jsxs("button",{onClick:()=>g(!u),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${u?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:`${I?"text-gray-700":"text-gray-400 font-normal"}`,children:x}),e.jsx("div",{className:`text-pink-400 transition-transform ${u?"rotate-180":""}`,children:"▼"})]}),u&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:H.length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无模型，请先添加"}):H.map(y=>e.jsx("li",{onClick:()=>{_(y.model_id),g(!1)},className:`px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors ${I===y.model_id?"bg-pink-100 font-bold text-pink-700":""}`,children:y.model_name||y.model_id},y.id))})]}),e.jsx(_e,{value:c,onChange:N}),e.jsxs("button",{onClick:z,className:"px-6 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all flex items-center gap-2",children:[e.jsx(fe,{size:16})," 确认"]})]})]})]})]})]})},js=()=>e.jsx(xe,{children:e.jsx(ys,{})}),vs=()=>{const{showToast:t}=de(),[r,i]=n.useState([]),[l,s]=n.useState(1),d=6,[h,m]=n.useState(!1),[p,j]=n.useState({model_id:"",model_name:"",model_nickname:""}),[C,k]=n.useState(null),I=async()=>{try{const E=await je.list();i(E.items||[])}catch{t("模型列表加载失败","error")}};n.useEffect(()=>{I()},[]);const _=E=>{if(!E)return"-";const o=new Date(E),v=o.getFullYear(),c=String(o.getMonth()+1).padStart(2,"0"),N=String(o.getDate()).padStart(2,"0"),V=String(o.getHours()).padStart(2,"0"),B=String(o.getMinutes()).padStart(2,"0");return`${v}/${c}/${N} ${V}:${B}`},u=Math.max(1,Math.ceil(r.length/d)),g=(l-1)*d,b=r.slice(g,g+d);n.useEffect(()=>{l>u&&s(u)},[r]);const S=async()=>{if(!p.model_id||!p.model_name){t("请填写完整信息","error");return}try{await je.create(p),t("模型添加成功"),m(!1),j({model_id:"",model_name:"",model_nickname:""}),I()}catch{t("添加失败","error")}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"}),"模型管理"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"维护可用的模型列表"})]}),e.jsxs("button",{onClick:()=>m(!0),className:"bg-pink-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-colors flex items-center gap-2 text-xs",children:[e.jsx(ce,{size:14})," 添加模型"]})]}),e.jsxs("div",{className:"glass-card rounded-2xl overflow-hidden border border-pink-100",children:[e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-pink-100 text-pink-900 font-cute text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 pl-6 w-16",children:"序号"}),e.jsx("th",{className:"p-3",children:"模型名称"}),e.jsx("th",{className:"p-3",children:"模型ID"}),e.jsx("th",{className:"p-3",children:"盲测模型昵称"}),e.jsx("th",{className:"p-3",children:"添加时间"}),e.jsx("th",{className:"p-3 text-right pr-6",children:"操作"})]})}),e.jsxs("tbody",{className:"text-sm divide-y divide-pink-100",children:[b.map((E,o)=>e.jsxs("tr",{className:"hover:bg-pink-50/30 transition-colors",children:[e.jsx("td",{className:"p-3 pl-6 text-gray-500 font-mono",children:g+o+1}),e.jsx("td",{className:"p-3 font-bold text-pink-700",children:E.model_name}),e.jsx("td",{className:"p-3 font-mono text-gray-600",children:E.model_id}),e.jsx("td",{className:"p-3 text-gray-600",children:E.model_nickname||"-"}),e.jsx("td",{className:"p-3 text-gray-500",children:_(E.created_at)}),e.jsx("td",{className:"p-3 text-right pr-6",children:e.jsx("button",{onClick:()=>k(E),className:"text-red-400 hover:text-red-600 p-1",children:e.jsx(Te,{size:16})})})]},E.id)),r.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"p-8 text-center text-gray-400 text-sm",children:"暂无模型数据"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["第 ",l," / ",u," 页"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:l===1,onClick:()=>s(E=>Math.max(1,E-1)),className:`px-3 py-1 rounded-lg text-xs font-bold ${l===1?"bg-gray-100 text-gray-400":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:"上一页"}),Array.from({length:u}).map((E,o)=>e.jsx("button",{onClick:()=>s(o+1),className:`w-8 h-8 rounded-lg text-xs font-bold ${l===o+1?"bg-pink-500 text-white":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:o+1},o)),e.jsx("button",{disabled:l===u,onClick:()=>s(E=>Math.min(u,E+1)),className:`px-3 py-1 rounded-lg text-xs font-bold ${l===u?"bg-gray-100 text-gray-400":"bg-white border border-gray-200 text-gray-600 hover:border-pink-300 hover:text-pink-600 hover:bg-pink-50"}`,children:"下一页"})]})]})]}),C&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 z-50",onClick:()=>k(null)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg白 rounded-3xl border border-pink-100 p-6 w-full max-w-md shadow-2xl",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900 mb-2",children:"删除模型"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["确定删除“",C.model_name,"”吗？此操作不可撤回。"]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>k(null),className:"px-5 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50",children:"取消"}),e.jsx("button",{onClick:async()=>{try{await je.remove(C.id),t("删除成功"),k(null),I()}catch{t("删除失败","error")}},className:"px-5 py-2 rounded-xl bg-red-500 text-white font-bold text-sm shadow-sm hover:bg-red-600",children:"确认删除"})]})]})})]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50 backdrop-blur-sm",onClick:()=>m(!1)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg白 rounded-3xl border border-pink-100 shadow-2xl p-6 animate-fade-in w-full max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"font-cute text-xl text-pink-900",children:"添加新模型"}),e.jsx("button",{onClick:()=>m(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ne,{size:20})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-pink-800 mb-1.5",children:["模型ID ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:p.model_id,onChange:E=>j({...p,model_id:E.target.value}),placeholder:"例如: gpt-4-turbo",className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-pink-800 mb-1.5",children:["模型名称 ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:p.model_name,onChange:E=>j({...p,model_name:E.target.value}),placeholder:"例如: GPT-4 Turbo",className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-1.5",children:"盲测模型昵称"}),e.jsx("input",{type:"text",value:p.model_nickname,onChange:E=>j({...p,model_nickname:E.target.value}),placeholder:"例如: 智慧之星",className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>m(!1),className:"px-5 py-2.5 rounded-xl bg-gray-50 text-gray-600 font-bold text-sm hover:bg-gray-100 transition-colors",children:"取消"}),e.jsx("button",{onClick:S,className:"px-6 py-2.5 rounded-xl bg-pink-500 text白 font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all",children:"保存模型"})]})]})})]})]})},ws=()=>e.jsx(xe,{children:e.jsx(vs,{})}),Ns=()=>{const{showToast:t}=de(),[r,i]=n.useState([]),[l,s]=n.useState("list"),[d,h]=n.useState({username:"",email:"",password:""}),[m,p]=n.useState(null),[j,C]=n.useState(""),k=async()=>{try{const b=await oe.list();i(b)}catch{t("加载失败","error")}};n.useEffect(()=>{k()},[]);const I=async()=>{if(!d.username||!d.password){t("请填写必填项","error");return}try{const{id:b}=await oe.create(d);i(S=>[...S,{id:b,username:d.username,email:d.email||"",isActive:1}]),s("list"),h({username:"",email:"",password:""}),t("管理员添加成功")}catch{t("添加失败","error")}},_=async(b,S)=>{try{await oe.update(b,{isActive:S}),i(E=>E.map(o=>o.id===b?{...o,isActive:S}:o)),t(S?"已启用":"已禁用")}catch{t("更新失败","error")}},u=async b=>{try{await oe.remove(b),i(S=>S.filter(E=>E.id!==b)),t("删除成功")}catch{t("删除失败","error")}},g=async()=>{if(!j){t("请输入新密码","error");return}try{await oe.changePassword(m.id,j),p(null),C(""),t("密码已更新")}catch{t("更新失败","error")}};return l==="create"?e.jsxs("div",{className:"animate-fade-in pb-10",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>s("list"),className:"px-5 py-2.5 rounded-xl bg-white text-gray-600 font-bold text-sm shadow-sm hover:bg-gray-50",children:"返回"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:"添加管理员"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"创建新的后台管理员账号"})]}),e.jsxs("div",{className:"ml-auto flex gap-3",children:[e.jsx("button",{onClick:()=>s("list"),className:"px-6 py-2.5 rounded-xl bg-white text-gray-500 font-bold text-sm shadow-sm hover:bg-gray-50",children:"取消"}),e.jsxs("button",{onClick:I,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(ce,{size:16})," 创建管理员"]})]})]}),e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6 max-w-2xl mx-auto",children:[e.jsxs("h3",{className:"font-cute text-lg text-pink-900 flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"w-1.5 h-4 bg-yellow-400 rounded-full"})," 管理员信息"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"用户名"}),e.jsx("input",{type:"text",value:d.username,onChange:b=>h({...d,username:b.target.value}),className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"邮箱"}),e.jsx("input",{type:"email",value:d.email,onChange:b=>h({...d,email:b.target.value}),className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"初始密码"}),e.jsx("input",{type:"password",value:d.password,onChange:b=>h({...d,password:b.target.value}),className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]})]})]}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"}),"管理员账号"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"管理后台管理员列表、禁用与密码修改"})]}),e.jsxs("button",{onClick:()=>s("create"),className:"bg-pink-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-colors flex items-center gap-2 text-xs",children:[e.jsx(ce,{size:14})," 添加管理员"]})]}),e.jsx("div",{className:"glass-card rounded-2xl overflow-hidden border border-pink-100",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-pink-100 text-pink-900 font-cute text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 pl-6 w-20",children:"头像"}),e.jsx("th",{className:"p-3 w-20",children:"ID"}),e.jsx("th",{className:"p-3",children:"用户名"}),e.jsx("th",{className:"p-3",children:"昵称"}),e.jsx("th",{className:"p-3",children:"邮箱"}),e.jsx("th",{className:"p-3",children:"状态"}),e.jsx("th",{className:"p-3 text-right pr-6",children:"操作"})]})}),e.jsxs("tbody",{className:"text-sm divide-y divide-pink-100",children:[r.map(b=>e.jsxs("tr",{className:"hover:bg-pink-50/30 transition-colors",children:[e.jsx("td",{className:"p-3 pl-6",children:e.jsx("img",{src:b.avatar||"/uploads/avatars/default_admin.jpg",alt:b.username,className:"w-8 h-8 rounded-full object-cover shadow-sm"})}),e.jsx("td",{className:"p-3 text-gray-500 font-mono",children:b.id.toString().padStart(4,"0")}),e.jsx("td",{className:"p-3 font-bold text-pink-700",children:b.username}),e.jsx("td",{className:"p-3 text-gray-700",children:b.nickname||"-"}),e.jsx("td",{className:"p-3 text-gray-600",children:b.email||"-"}),e.jsx("td",{className:"p-3",children:b.isActive===1?"启用":"禁用"}),e.jsx("td",{className:"p-3 text-right pr-6",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx("button",{onClick:()=>p(b),className:"px-3 py-1 rounded bg-white border border-gray-200 text-gray-600 text-xs hover:bg-gray-50",children:"改密"}),e.jsx("button",{onClick:()=>_(b.id,b.isActive===1?0:1),className:`px-3 py-1 rounded text-xs font-bold ${b.isActive===1?"bg-yellow-100 text-yellow-700":"bg-green-100 text-green-700"}`,children:b.isActive===1?"禁用":"启用"}),e.jsx("button",{onClick:()=>u(b.id),className:"px-3 py-1 rounded bg-red-500 text-white text-xs hover:bg-red-600",children:"删除"})]})})]},b.id)),r.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"p-8 text-center text-gray-400 text-sm",children:"暂无管理员"})})]})]})}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 z-50",onClick:()=>p(null)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-pink-100 p-6 w-full max-w-md shadow-2xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900",children:"修改密码"}),e.jsx("button",{onClick:()=>p(null),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ne,{size:20})})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-1.5",children:"新密码"}),e.jsx("input",{type:"password",value:j,onChange:b=>C(b.target.value),className:"dream-input w-full px-4 py-2.5 rounded-xl text-sm"})]})}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>p(null),className:"px-5 py-2.5 rounded-xl bg-gray-50 text-gray-600 font-bold text-sm hover:bg-gray-100 transition-colors",children:"取消"}),e.jsx("button",{onClick:g,className:"px-6 py-2.5 rounded-xl bg-pink-500 text-white font-bold text-sm shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all",children:"确认修改"})]})]})})]})]})},ks=()=>e.jsx(xe,{children:e.jsx(Ns,{})}),Ss=t=>new Promise(r=>{const i=new FileReader;i.addEventListener("load",()=>r(i.result),!1),i.readAsDataURL(t)}),Cs=t=>new Promise((r,i)=>{const l=new Image;l.addEventListener("load",()=>r(l)),l.addEventListener("error",s=>i(s)),l.setAttribute("crossOrigin","anonymous"),l.src=t});function Ms({initialImage:t,onSave:r,onCancel:i}){const[l,s]=n.useState(t?"edit":"upload"),[d,h]=n.useState(t||null),m=async p=>{if(p.target.files&&p.target.files.length>0){const j=p.target.files[0],C=await Ss(j);h(C),s("edit")}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200",children:e.jsxs("div",{className:"relative w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-200",children:[e.jsx(_s,{step:l,onBack:()=>s("upload"),onClose:i}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[l==="upload"&&e.jsx(zs,{onFileChange:m}),l==="edit"&&d&&e.jsx($s,{imageSrc:d,onSave:r,onCancel:()=>s("upload")})]})]})})}function _s({step:t,onBack:r,onClose:i}){const l=t==="upload"?"上传封面":"裁剪封面";return e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t==="edit"&&e.jsx("button",{onClick:r,className:"p-2 -ml-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),e.jsx("h2",{className:"text-lg font-cute text-pink-900",children:l})]}),e.jsx("button",{onClick:i,className:"p-2 -mr-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(ne,{size:20})})]})}function zs({onFileChange:t}){const[r,i]=n.useState(!1),l=n.useRef(null);return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 p-8 flex flex-col items-center justify-center",children:e.jsxs("div",{onDragOver:s=>{s.preventDefault(),i(!0)},onDragLeave:s=>{s.preventDefault(),i(!1)},onDrop:s=>{s.preventDefault(),i(!1),s.dataTransfer.files&&s.dataTransfer.files.length>0&&t({target:{files:s.dataTransfer.files}})},onClick:()=>l.current.click(),className:`w-full max-w-xl aspect-[2/1] rounded-3xl flex flex-col items-center justify-center transition-all duration-300 cursor-pointer border-2 border-dashed ${r?"bg-pink-50 border-pink-400 scale-105":"bg-gray-50 border-gray-200 hover:border-pink-300 hover:bg-pink-50/30"}`,children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-white shadow-sm flex items-center justify-center mb-4 text-pink-500",children:e.jsx(Ee,{size:32})}),e.jsx("p",{className:"text-gray-600 font-bold mb-1",children:"点击或拖拽上传封面"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"输出尺寸 800×400，比例 2:1"})]})}),e.jsx("input",{type:"file",ref:l,onChange:t,className:"hidden",accept:"image/*"})]})}function $s({imageSrc:t,onSave:r,onCancel:i}){const l=n.useRef(null),[s,d]=n.useState(null),[h,m]=n.useState(!1),[p,j]=n.useState(0),[C,k]=n.useState({x:0,y:0}),[I,_]=n.useState(!1),[u,g]=n.useState({x:0,y:0}),[b,S]=n.useState(1),[E,o]=n.useState(1),v=800,c=800,N=400;n.useEffect(()=>{(async()=>{try{const x=await Cs(t);d(x);const z=v/x.width,y=v/x.height,$=Math.max(z,y);S($),o(1)}catch{}})()},[t]);const V=w=>{w.preventDefault();const x=w.deltaY*-.001;o(z=>Math.max(.5,Math.min(z+x,3)))},B=n.useCallback(()=>{if(!s||!l.current)return;const x=l.current.getContext("2d");x.clearRect(0,0,v,v),x.fillStyle="#18181b",x.fillRect(0,0,v,v),x.save(),x.translate(v/2,v/2),x.rotate(p*Math.PI/180),x.translate(-v/2,-v/2);const z=p*Math.PI/180,y=C.x*Math.cos(-z)-C.y*Math.sin(-z),$=C.x*Math.sin(-z)+C.y*Math.cos(-z),R=b*E,T=s.width*R,P=s.height*R,D=v/2,O=v/2;x.drawImage(s,D-T/2+y,O-P/2+$,T,P),x.restore();const X=(v-N)/2;x.fillStyle="rgba(0, 0, 0, 0.6)",x.beginPath(),x.rect(0,0,v,v),x.rect(0,X,c,N),x.fill("evenodd")},[s,p,C,b,E]);n.useEffect(()=>{B()},[B]);const Y=w=>{var $,R,T,P;_(!0);const x=l.current.getBoundingClientRect(),z=w.clientX||((R=($=w.touches)==null?void 0:$[0])==null?void 0:R.clientX),y=w.clientY||((P=(T=w.touches)==null?void 0:T[0])==null?void 0:P.clientY);g({x:z-x.left,y:y-x.top})},M=w=>{if(!I)return;const x=l.current.getBoundingClientRect(),z=w.clientX||(w.touches?w.touches[0].clientX:0),y=w.clientY||(w.touches?w.touches[0].clientY:0),$=z-x.left,R=y-x.top,T=$-u.x,P=R-u.y;k(D=>({x:D.x+T,y:D.y+P})),g({x:$,y:R})},U=()=>_(!1),H=()=>j(w=>(w+90)%360),L=async()=>{if(!(!l.current||h)){m(!0);try{const w=document.createElement("canvas");w.width=c,w.height=N;const x=w.getContext("2d"),z=(v-N)/2;x.drawImage(l.current,0,z,c,N,0,0,c,N);const y=await new Promise((T,P)=>{w.toBlob(D=>D?T(D):P(new Error("blob_failed")),"image/jpeg",.92)}),$=new File([y],`cover_${Date.now()}.jpg`,{type:"image/jpeg"}),R=await Pe.cover($);r(R.url)}catch{}finally{m(!1)}}};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 relative flex items-center justify-center bg-gray-900 overflow-hidden",children:e.jsx("canvas",{ref:l,width:v,height:v,onMouseDown:Y,onMouseMove:M,onMouseUp:U,onMouseLeave:U,onTouchStart:Y,onTouchMove:M,onTouchEnd:U,onWheel:V,className:"cursor-move max-w-full max-h-full",style:{width:"100%",height:"auto",maxHeight:"520px"}})}),e.jsxs("div",{className:"p-4 bg-white flex items-center justify-between border-t border-gray-100 gap-4",children:[e.jsx("button",{onClick:H,className:"px-2 py-2 rounded-xl text-pink-600 hover:text-pink-700 text-xs font-bold hover:bg-pink-50",children:e.jsx(tt,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 max-w-[240px]",children:[e.jsx(at,{size:16,className:"text-gray-400"}),e.jsx("input",{type:"range",min:"0.5",max:"3",step:"0.1",value:E,onChange:w=>o(parseFloat(w.target.value)),className:"w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-500"}),e.jsx(st,{size:16,className:"text-gray-400"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:i,className:"px-4 py-2 rounded-xl text-gray-500 font-bold text-sm hover:bg-gray-100",children:"取消"}),e.jsx("button",{onClick:L,disabled:h,className:`px-5 py-2 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 ${h?"opacity-60 cursor-not-allowed":"hover:opacity-90"}`,children:h?"上传中...":"完成"})]})]})]})}const Ts=({initialData:t,onCancel:r,notify:i})=>{const[l,s]=n.useState({title:"",description:"",image:"",tags:[],author:"",likes:"",content:"",publishDate:""}),[d,h]=n.useState([]),[m,p]=n.useState([]),[j,C]=n.useState(!1),k=Ge.useRef(null);n.useEffect(()=>{t&&(s({title:t.title||"",description:t.description||"",image:t.image||"",tags:Array.isArray(t.tags)?t.tags:[],author:t.author||"",likes:t.likes||"",content:t.content||"",publishDate:t.publish_date||""}),Array.isArray(t.character_ids)&&h(t.character_ids.map(o=>Number(o))))},[t]),n.useEffect(()=>{(async()=>{try{const o=await be.list({creator_role:"admin_role"}),c=(Array.isArray(o==null?void 0:o.items)?o.items:[]).filter(N=>N.status==="published");p(c.map(N=>({id:Number(N.id),name:N.name})))}catch{}})()},[]),n.useEffect(()=>{const o=v=>{j&&k.current&&!k.current.contains(v.target)&&C(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[j]);const[I,_]=n.useState(""),[u,g]=n.useState(!1),b=()=>{const o=I.trim();o&&(s(v=>({...v,tags:v.tags.includes(o)?v.tags:[...v.tags,o]})),_(""))},S=o=>s(v=>({...v,tags:v.tags.filter(c=>c!==o)})),E=async()=>{if(!l.title.trim()||!l.content.trim()){i&&i("请输入标题与内容","error");return}const o={title:l.title.trim(),description:l.description||null,image:l.image||null,author:l.author||null,likes:l.likes||null,content:l.content,tags:l.tags,character_ids:d};try{t!=null&&t.id?(await ve.update(t.id,o),i&&i("保存成功：故事已更新")):(await ve.create(o),i&&i("保存成功：故事已创建")),r&&r()}catch{i&&i("保存失败","error")}};return e.jsxs("div",{className:"animate-fade-in pb-20",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:r,className:"w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-500 hover:text-pink-600 transition-colors",children:e.jsx(ye,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:t?"编辑故事":"创建故事"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"填写并保存故事内容"})]}),e.jsx("div",{className:"ml-auto",children:e.jsxs("button",{onClick:E,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(fe,{size:16})," 保存"]})})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"标题"}),e.jsx("input",{value:l.title,onChange:o=>s({...l,title:o.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"描述"}),e.jsx("textarea",{value:l.description,onChange:o=>s({...l,description:o.target.value}),rows:"3",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"封面图片"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{onClick:()=>g(!0),className:"w-full aspect-[2/1] bg-gray-100 rounded-2xl overflow-hidden border-4 border-white shadow-xl cursor-pointer",children:l.image?e.jsx("img",{src:l.image,alt:"cover",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-300 font-bold",children:"点击上传并裁剪 (800×400)"})}),e.jsx("input",{value:l.image,onChange:o=>s({...l,image:o.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"或直接粘贴图片 URL"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"作者"}),e.jsx("input",{value:l.author,onChange:o=>s({...l,author:o.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"点赞数（文本）"}),e.jsx("input",{value:l.likes,onChange:o=>s({...l,likes:o.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"标签"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:I,onChange:o=>_(o.target.value),onKeyDown:o=>{o.key==="Enter"&&(o.preventDefault(),b())},className:"dream-input flex-1 px-4 py-3 rounded-xl text-sm",placeholder:"输入标签并回车"}),e.jsx("button",{onClick:b,className:"px-4 rounded-xl bg-pink-500 text-white text-sm font-bold",children:"添加"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:l.tags.map(o=>e.jsxs("button",{onClick:()=>S(o),className:"bg-pink-50 text-pink-600 px-3 py-1.5 rounded-xl text-xs font-bold border border-pink-100",children:["#",o," ×"]},o))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"正文"}),e.jsx("textarea",{value:l.content,onChange:o=>s({...l,content:o.target.value}),rows:"14",className:"dream-input w-full px-5 py-4 rounded-xl text-sm leading-relaxed font-mono text-gray-700 bg-white focus:bg-white resize-y shadow-inner"})]})]})}),e.jsxs("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:[e.jsx("div",{className:"glass-card p-6 rounded-3xl text-sm text-gray-500",children:"在右侧填写故事信息并点击保存。"}),e.jsxs("div",{className:"solid-card p-6 rounded-3xl space-y-4",children:[e.jsx("div",{className:"text-xs font-bold text-pink-800",children:"登场角色（管理员且已发布）"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative w-full max-w-md",ref:k,children:[e.jsxs("button",{onClick:()=>C(!j),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${j?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:"text-gray-700",children:"选择角色"}),e.jsx("div",{className:`text-pink-400 transition-transform ${j?"rotate-180":""}`,children:"▼"})]}),j&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:m.filter(o=>!d.includes(o.id)).length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无可选角色"}):m.filter(o=>!d.includes(o.id)).map(o=>e.jsx("li",{onClick:()=>{h(v=>v.includes(o.id)?v:[...v,o.id]),C(!1)},className:"px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors",children:o.name},o.id))})]}),e.jsx("button",{className:"px-3 py-2 bg-pink-500 text-white rounded-xl text-xs font-bold",onClick:()=>C(!0),children:"添加"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.map(o=>{var c;const v=((c=m.find(N=>N.id===o))==null?void 0:c.name)||o;return e.jsxs("span",{className:"bg-pink-50 text-pink-600 px-3 py-1.5 rounded-xl text-xs font-bold border border-pink-100",children:[v,e.jsx("button",{className:"ml-2 text-pink-500",onClick:()=>h(N=>N.filter(V=>V!==o)),children:"×"})]},o)})})]})]})]}),u&&e.jsx(Ms,{initialImage:l.image||null,onSave:async o=>{s(v=>({...v,image:o})),g(!1)},onCancel:()=>g(!1)})]})},Es=()=>{const[t,r]=n.useState("list"),[i,l]=n.useState(null),{showToast:s}=de(),[d,h]=n.useState([]),[m,p]=n.useState(null),j=async()=>{try{const u=await ve.list();h(u.items||[])}catch{s("加载失败","error")}};n.useEffect(()=>{j()},[]);const C=()=>{l(null),r("create")},k=u=>{l(u),r("create")},I=async u=>{try{await ve.remove(u),s("删除成功"),j()}catch{s("删除失败","error")}},_=async(u,g)=>{try{await ve.setStatus(u,g==="published"?"draft":"published"),s(g==="published"?"已回收为草稿":"已发布"),j()}catch{s("操作失败","error")}};return t==="create"?e.jsx(Ts,{initialData:i,onCancel:()=>{r("list"),j()},notify:s}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"})," 故事管理"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"查看与编辑故事内容"})]}),e.jsxs("button",{onClick:C,className:"bg-gradient-to-r from-pink-500 to-pink-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-pink-200 hover:opacity-90 transition-all flex items-center gap-2 text-sm",children:[e.jsx(ce,{size:16})," 创建故事"]})]}),e.jsx("div",{className:"grid gap-6",style:{gridTemplateColumns:"repeat(auto-fit, minmax(320px, 360px))"},children:d.map(u=>e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"glass-card p-4 rounded-3xl hover:shadow-xl transition-all group relative overflow-hidden h-[220px] flex flex-col",children:[e.jsx("div",{className:`absolute top-4 right-4 text-xs px-2 py-0.5 rounded-md font-bold ${u.status==="published"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-500"}`,children:u.status==="published"?"已发布":"草稿"}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-pink-200 to-pink-300 flex items-center justify-center text-white text-xl font-bold shadow-inner border-2 border-white overflow-hidden flex-shrink-0",children:u.image?e.jsx("img",{src:u.image,alt:"cover",className:"w-full h-full object-cover"}):e.jsx("span",{children:u.title?u.title[0]:"?"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 truncate",children:u.title}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:u.author||""})]}),e.jsx("div",{className:"flex gap-1 mt-2 flex-nowrap whitespace-nowrap overflow-hidden",style:{maxWidth:300},children:(u.tags||[]).map(g=>e.jsxs("span",{className:"text-[10px] bg-pink-50 text-pink-600 px-1.5 py-0.5 rounded border border-pink-100",children:["#",g]},g))})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("p",{className:"text-gray-600 text-sm leading-relaxed break-words",children:u.description||"暂无描述"})}),e.jsxs("div",{className:"mt-auto flex gap-2 pt-3 border-t border-white/50",children:[e.jsxs("button",{onClick:()=>k(u),className:"flex-1 py-2 text-xs font-bold text-pink-600 bg-pink-50 hover:bg-pink-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Ie,{size:12})," 编辑"]}),u.status==="published"?e.jsxs("button",{onClick:()=>_(u.id,u.status),className:"flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Qe,{size:12})," 回收"]}):e.jsxs("button",{onClick:()=>_(u.id,u.status),className:"flex-1 py-2 text-xs font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(Ze,{size:12})," 发布"]})]})]}),e.jsx("button",{onClick:()=>p(u),className:"absolute -top-2 -right-2 z-10 w-8 h-8 rounded-full bg-white/60 backdrop-blur-md shadow-lg border border-pink-100 flex items-center justify-center text-gray-400 hover:text-red-500 transition",children:e.jsx(ne,{size:12})})]},u.id))}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50",onClick:()=>p(null)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-pink-50 p-6 w-full max-w-md shadow-2xl",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900 mb-2",children:"删除故事"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["确定删除“",m.title,"”吗？此操作不可撤回。"]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>p(null),className:"px-5 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50",children:"取消"}),e.jsx("button",{onClick:()=>{I(m.id),p(null)},className:"px-5 py-2 rounded-xl bg-red-500 text-white font-bold text-sm shadow-sm hover:bg-red-600",children:"确认删除"})]})]})})]})]})},Is=()=>e.jsx(xe,{children:e.jsx(Es,{})}),Ls=()=>{const[t,r]=n.useState(!1),[i,l]=n.useState("templates"),[s,d]=n.useState(""),[h,m]=n.useState(!1),[p,j]=n.useState(""),[C,k]=n.useState(""),[I,_]=n.useState(""),u=async()=>{const S={};if(p&&p.trim()&&(S.nickname=p.trim()),C){if(C!==I)return;S.password=C}try{await oe.updateMe(S),m(!1),j(""),k(""),_("")}catch{}},g=S=>{window.history&&window.history.replaceState&&window.history.replaceState(null,"",S)},b=S=>{switch(S){case"templates":return"/super-admin/sysprompt";case"stories":return"/super-admin/stories";case"characters":case"official_characters":return"/super-admin/characters/official";case"user_characters":return"/super-admin/characters/user";case"users":return"/super-admin/users";case"model_settings":return"/super-admin/settings/model";case"model_manage":return"/super-admin/settings/models";case"admin_accounts":return"/super-admin/settings/admins";default:return"/super-admin/stories"}};return n.useEffect(()=>{const S=localStorage.getItem("admin_access_token"),E=localStorage.getItem("admin_username"),o=window.location.pathname;S?(r(!0),E&&d(E),o.startsWith("/super-admin/stories")?l("stories"):o.startsWith("/super-admin/characters/official")?l("official_characters"):o.startsWith("/super-admin/characters/user")?l("user_characters"):o.startsWith("/super-admin/users")?l("users"):o.startsWith("/super-admin/settings/model")?l("model_settings"):o.startsWith("/super-admin/settings/models")?l("model_manage"):o.startsWith("/super-admin/settings/admins")?l("admin_accounts"):(l("templates"),o!=="/super-admin/sysprompt"&&g("/super-admin/sysprompt"))):(r(!1),o!=="/super-admin/login"&&g("/super-admin/login"))},[]),t?e.jsxs("div",{className:"flex min-h-screen bg-white",children:[e.jsx(He,{}),e.jsx(ts,{activeTab:i,setActiveTab:S=>{l(S),g(b(S))},onLogout:()=>{r(!1),localStorage.removeItem("admin_access_token"),localStorage.removeItem("admin_refresh_token"),localStorage.removeItem("admin_username"),g("/super-admin/login")},username:s,onEditProfile:()=>m(!0)}),e.jsxs("main",{className:"flex-1 ml-16 xl:ml-56 p-8 relative z-10 transition-all duration-300 h-screen overflow-y-auto",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 pointer-events-none opacity-20",children:e.jsx(Ce,{size:120,className:"text-pink-300"})}),i==="templates"&&e.jsx(ls,{}),i==="stories"&&e.jsx(Is,{}),(i==="characters"||i==="official_characters")&&e.jsx(qe,{creatorRole:"admin_role"}),i==="user_characters"&&e.jsx(qe,{creatorRole:"user_role"}),i==="users"&&e.jsx(bs,{}),i==="model_settings"&&e.jsx(js,{}),i==="model_manage"&&s==="admin"&&e.jsx(ws,{}),i==="admin_accounts"&&s==="admin"&&e.jsx(ks,{})]}),e.jsx("div",{className:"ambient-bg"}),h&&e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-2xl p-6 w-96 shadow-2xl",children:[e.jsx("div",{className:"font-bold mb-4 text-pink-900",children:"修改资料"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{children:e.jsx("input",{type:"text",placeholder:`昵称（当前：${s}）`,value:p,onChange:S=>j(S.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})}),e.jsx("div",{children:e.jsx("input",{type:"password",placeholder:"新密码",value:C,onChange:S=>k(S.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})}),e.jsx("div",{children:e.jsx("input",{type:"password",placeholder:"再次输入新密码",value:I,onChange:S=>_(S.target.value),className:"dream-input w-full px-4 py-3 rounded-2xl text-sm font-bold text-gray-700"})})]}),e.jsxs("div",{className:"flex gap-2 justify-end mt-5",children:[e.jsx("button",{className:"px-4 py-2 rounded-xl bg-gray-100 text-gray-600",onClick:()=>{m(!1),j(""),k(""),_("")},children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-xl bg-pink-500 text-white",onClick:u,disabled:!p.trim()&&!C,children:"保存"})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{}),e.jsx(xe,{children:e.jsx(es,{onLogin:()=>{r(!0);const S=localStorage.getItem("admin_username");S&&d(S),l("templates"),g("/super-admin/sysprompt")}})})]})};export{Ls as default};
//# sourceMappingURL=AdminDashboard-Ig4VCyPk.js.map
