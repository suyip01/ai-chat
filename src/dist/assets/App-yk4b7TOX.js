const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/user-services-BjP0463N.js","assets/user-components-BCzIkXTb.js","assets/vendor-react-C8XDWPrG.js","assets/vendor-jsJWjJTf.js","assets/vendor-icons-BT5Yb3Aw.js","assets/vendor-motion-DNjvvKGV.js"])))=>i.map(i=>d[i]);
import{N as l,_ as me,C as $,T as G,L as he,a as ue,U as pe,b as ge,c as Q,d as xe,e as fe,f as ve,M as N,g as we,h as ye}from"./user-components-BCzIkXTb.js";import{r,j as a}from"./vendor-react-C8XDWPrG.js";import{n as be,o as Y,b as je}from"./user-services-BjP0463N.js";import{A as B}from"./vendor-motion-DNjvvKGV.js";import"./vendor-icons-BT5Yb3Aw.js";import"./vendor-jsJWjJTf.js";const Se=[],Ce=[{id:1,title:"命运的邂逅",description:"在樱花盛开的坂道上，你撞到了那个改变你一生的人...",image:"https://image.pollinations.ai/prompt/anime%20scenery%20cherry%20blossom%20school%20romantic%20soft%20pastel?width=600&height=300&seed=10",tags:["浪漫","校园"]},{id:2,title:"当你被阴湿男鬼盯上",description:"我搬到了她家对面，每天躲在窗帘后面看着她在阳台上......",image:"https://image.pollinations.ai/prompt/anime%20scenery%20magic%20library%20night%20mysterious%20glowing%20books?width=600&height=300&seed=20",tags:["阴湿男鬼","暗恋","bg","甜文"]},{id:3,title:"追到高岭之花后，我跑路了（2）",description:"原来我的每一次自持，都是下意识地相信你不会离开",image:"https://image.pollinations.ai/prompt/anime%20stage%20lights%20concert%20colorful%20sparkles?width=600&height=300&seed=30",tags:["高岭之花","高冷","傲娇","追妻火葬场","bg"]}],Le=()=>{const[p,f]=r.useState(l.HOME),[E,g]=r.useState(Se),[T,V]=r.useState([]),[k,R]=r.useState(!1),[d,h]=r.useState(null),[x,c]=r.useState(null),[u,z]=r.useState("stories"),[v,X]=r.useState(!1),[q,L]=r.useState(void 0),[w,y]=r.useState(!1),[P,A]=r.useState(null),[C,I]=r.useState(null),[M,J]=r.useState(!!localStorage.getItem("user_access_token")),[D,K]=r.useState(()=>{const t=localStorage.getItem("user_nickname")||"我",s=localStorage.getItem("user_email")||"me@example.com",e=localStorage.getItem("user_avatar")||"";return{nickname:t,email:s,avatar:e}}),[Z,O]=r.useState(!1),[ee,H]=r.useState(!1),[te,_]=r.useState([]),[W,b]=r.useState(!1),ae=()=>{localStorage.removeItem("user_access_token"),localStorage.removeItem("user_refresh_token"),localStorage.removeItem("user_nickname"),localStorage.removeItem("user_email"),localStorage.removeItem("user_avatar"),L(void 0),h(null),c(null),f(l.HOME),J(!1)};if(r.useEffect(()=>{M&&((async()=>{try{const{authFetch:t}=await me(async()=>{const{authFetch:e}=await import("./user-services-BjP0463N.js").then(i=>i.p);return{authFetch:e}},__vite__mapDeps([0,1,2,3,4,5])),s=await t("/user/profile");if(s&&s.ok){const e=await s.json(),i=e?.nickname||"我",n=e?.email||"me@example.com",o=e?.avatar||"",m=typeof e?.used_count=="number"?e.used_count:0;K({nickname:i,email:n,avatar:o,usedCount:m});try{localStorage.setItem("user_nickname",i),localStorage.setItem("user_email",n),o&&localStorage.setItem("user_avatar",o)}catch{}}}catch{}})(),R(!0),be({limit:24}).then(t=>{const s=t.map(e=>({id:String(e.id),name:e.name||"未知",avatar:e.avatar||"",profileImage:e.profileImage||"",status:$.ONLINE,bio:e.bio||"",tags:Array.isArray(e.tags)?e.tags:[],creator:e.creator||"",oneLinePersona:e.oneLinePersona||"",personality:e.personality||"",profession:e.profession||"",age:e.age||"",roleType:e.roleType||"",currentRelationship:e.currentRelationship||"",plotTheme:e.plotTheme||"",plotDescription:e.plotDescription||"",openingLine:e.openingLine||""}));V(s);try{const e=[];Object.keys(localStorage).filter(n=>n.startsWith("chat_history_")).forEach(n=>{const o=n.replace("chat_history_",""),m=s.find(de=>String(de.id)===String(o));if(!m)return;const j=localStorage.getItem(n);if(!j)return;const F=JSON.parse(j);if(!F.length)return;const S=F[F.length-1],ce={id:S.id,senderId:S.senderId,text:S.text,timestamp:new Date(S.ts),type:S.type};e.push({characterId:String(o),character:m,lastMessage:ce,unreadCount:0})}),e.length&&g(e)}catch{}}).catch(()=>V([])).finally(()=>R(!1)),(async()=>{try{const s=(await Y()).map(e=>({id:String(e.id),name:e.name||"未知",avatar:e.avatar||"",profileImage:"",status:$.ONLINE,bio:e.plot_summary||"",tags:Array.isArray(e.tags)?e.tags:[],creator:D.nickname||"我",oneLinePersona:e.tagline||"",personality:e.personality||"",profession:e.occupation||"",age:e.age?String(e.age):"",roleType:"",gender:e.gender||"",currentRelationship:e.relationship||"",plotTheme:e.plot_theme||"",plotDescription:"",openingLine:e.opening_line||"",styleExamples:Array.isArray(e.styleExamples)?e.styleExamples:[],hobbies:e.hobbies||"",experiences:e.experiences||"",isPublic:e.visibility?e.visibility==="public":!1}));_(s)}catch{_([])}})())},[M]),r.useEffect(()=>{if(!(navigator?.maxTouchPoints>0))return;const s=document.querySelector('meta[name="viewport"]'),e=s?.getAttribute("content")||"";s&&s.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no");let n=0;const o=m=>{const j=Date.now();j-n<=300&&m.preventDefault(),n=j};return document.addEventListener("touchend",o,{passive:!1}),document.body.style.touchAction="manipulation",()=>{s&&s.setAttribute("content",e),document.removeEventListener("touchend",o),document.body.style.touchAction=""}},[]),r.useEffect(()=>{const t=()=>{const e=window.visualViewport&&window.visualViewport.height?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--vh",`${e*.01}px`)};t();const s=()=>t();return window.addEventListener("resize",s),window.visualViewport&&window.visualViewport.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),window.visualViewport&&window.visualViewport.removeEventListener("resize",s)}},[]),!M)return a.jsx(G,{children:a.jsx("div",{className:"fixed inset-0 w-full bg-primary-50 overflow-hidden",style:{height:"calc(var(--vh) * 100)",overscrollBehavior:"none"},children:a.jsx("div",{className:"h-full w-full max-w-md mx-auto bg白 relative shadow-2xl rounded-none md:rounded-3xl md:overflow-hidden flex",children:a.jsx(he,{onLogin:()=>J(!0)})})})});const se=t=>{try{const s=localStorage.getItem(`chat_history_${t.characterId}`);if(s){const i=JSON.parse(s).map(n=>({id:n.id,senderId:n.senderId,text:n.text,timestamp:new Date(n.ts),type:n.type,quote:n.quote,read:n.read}));if(i.length)return i}}catch{}return t.character.openingLine?[{id:`m_${Date.now()}`,senderId:t.characterId,text:t.character.openingLine.replace(/^['"“]|['"”]$/g,""),timestamp:new Date,type:N.TEXT}]:[{id:"m0",senderId:t.characterId,text:"很高兴认识你！",timestamp:new Date(new Date().setDate(new Date().getDate()-2)),type:N.TEXT},t.lastMessage]},re=t=>{d&&g(s=>s.map(e=>e.characterId===d.characterId?{...e,lastMessage:t,unreadCount:0}:e))},ne=t=>{g(s=>s.map(e=>e.characterId===t?{...e,character:{...e.character,isPinned:!e.character.isPinned}}:e))},U=async t=>{const s=E.find(e=>e.characterId===t.id);if(s){c(null),b(!1),h(s),f(l.CHAT);return}try{const e=`chat_session_${t.id}`;let i=localStorage.getItem(e)||"";i||(i=(await je(t.id)).sessionId,localStorage.setItem(e,i));const n={id:`msg_${Date.now()}`,senderId:t.id,text:t.openingLine?t.openingLine.replace(/^['"“]|['"”]$/g,""):"你好...",timestamp:new Date,type:N.TEXT},o={characterId:t.id,character:t,lastMessage:n,unreadCount:0};g(m=>[o,...m]),c(null),b(!1),h(o),f(l.CHAT)}catch{const e={characterId:t.id,character:t,lastMessage:{id:`msg_${Date.now()}`,senderId:t.id,text:t.openingLine?t.openingLine.replace(/^['"“]|['"”]$/g,""):"你好...",timestamp:new Date,type:N.TEXT},unreadCount:0};g(i=>[e,...i]),c(null),b(!1),h(e),f(l.CHAT)}},ie=t=>{y(!1),I({character:t,id:String(t.id)})},oe=()=>a.jsxs("div",{className:"flex items-center gap-5",children:[a.jsxs("button",{onClick:()=>z("stories"),className:`relative transition-all duration-300 ${u==="stories"?"text-slate-800 font-extrabold text-2xl scale-105":"text-slate-400 font-semibold text-lg hover:text-slate-600"}`,children:["故事",u==="stories"&&a.jsx("span",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-4 h-1 bg-primary-500 rounded-full"})]}),a.jsx("div",{className:"h-5 w-[1px] bg-slate-300/50 rounded-full"}),a.jsxs("button",{onClick:()=>z("characters"),className:`relative transition-all duration-300 ${u==="characters"?"text-slate-800 font-extrabold text-2xl scale-105":"text-slate-400 font-semibold text-lg hover:text-slate-600"}`,children:["角色",u==="characters"&&a.jsx("span",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-4 h-1 bg-primary-500 rounded-full"})]})]}),le=()=>{switch(p){case l.HOME:return a.jsx("div",{className:"px-6 pb-24 animate-in fade-in slide-in-from-bottom-4 duration-500",children:u==="stories"?a.jsx("div",{className:"space-y-6 mt-2",children:Ce.map(t=>a.jsxs("div",{className:"group relative bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-lg transition-all cursor-pointer",children:[a.jsxs("div",{className:"h-40 overflow-hidden relative",children:[a.jsx("img",{src:t.image,alt:t.title,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"}),a.jsx("div",{className:"absolute bottom-4 left-4 text-white",children:a.jsx("h3",{className:"text-xl font-bold",children:t.title})})]}),a.jsxs("div",{className:"p-5",children:[a.jsx("p",{className:"text-slate-500 text-sm leading-relaxed mb-4 line-clamp-2",children:t.description}),a.jsx("div",{className:"flex justify-between items-center",children:a.jsx("div",{className:"flex gap-2 flex-wrap",children:t.tags.map(s=>a.jsxs("span",{className:"text-[10px] font-bold text-primary-600 bg-primary-50 px-2 py-1 rounded-full",children:["#",s]},s))})})]})]},t.id))}):a.jsxs("div",{className:"flex flex-col gap-4 mt-2",children:[k&&a.jsx("div",{className:"text-center text-xs text-slate-400",children:"加载中..."}),!k&&T.map(t=>a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm flex gap-4 hover:shadow-md transition-all cursor-pointer border border-transparent hover:border-primary-100",onClick:()=>{O(!1),H(!1),c(t)},children:[a.jsx("div",{className:"w-20 h-28 flex-shrink-0 rounded-xl overflow-hidden bg-slate-100 relative group",children:a.jsx("img",{src:t.avatar,alt:t.name,className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"})}),a.jsxs("div",{className:"flex-1 flex flex-col justify-between py-1 min-w-0",children:[a.jsxs("div",{children:[a.jsx("div",{className:"flex justify-between items-start",children:a.jsx("h3",{className:"font-bold text-slate-800 text-lg leading-tight",children:t.name})}),a.jsx("div",{className:"flex flex-wrap gap-1.5 mt-2 mb-2",children:t.tags?.slice(0,4).map(s=>a.jsx("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-pink-50 text-pink-500",children:s},s))}),a.jsx("p",{className:"text-xs text-slate-500 line-clamp-2 leading-relaxed mb-2",children:t.oneLinePersona||t.bio})]}),a.jsx("div",{className:"flex items-center justify-end mt-1 border-t border-slate-50 pt-2",children:a.jsxs("div",{className:"text-[10px] text-slate-400",children:["by ",t.creator||"未知"]})})]})]},t.id)),!k&&T.length===0&&a.jsx("div",{className:"mt-2 text-center",children:a.jsx("p",{className:"text-xs text-slate-300",children:"没有更多了 ~"})})]})});case l.ME:return a.jsx(ye,{userProfile:D,myCharacters:T,myUserCharacters:te,myStories:[],onUpdateProfile:t=>{K(t);try{localStorage.setItem("user_nickname",t.nickname||"我"),localStorage.setItem("user_email",t.email||"me@example.com"),t.avatar&&localStorage.setItem("user_avatar",t.avatar)}catch{}},onCharacterClick:t=>{O(!1),H(!0),c(t)},onLogout:ae});case l.CHAT:default:return a.jsx(a.Fragment,{children:(!d||W)&&a.jsx(we,{chats:E,onChatClick:t=>{b(!0),h(t)},onTogglePin:ne,onDeleteChat:t=>{g(s=>s.filter(e=>e.characterId!==t)),localStorage.removeItem(`chat_session_${t}`),localStorage.removeItem(`chat_history_${t}`),d?.characterId===t&&h(null)},isDetailOpen:W&&!!d})})}};return a.jsx(G,{children:a.jsx("div",{className:"fixed inset-0 w-full bg-primary-50 overflow-hidden",style:{height:"calc(var(--vh) * 100)",overscrollBehavior:"none"},children:a.jsxs("div",{className:"h-full w-full max-w-md mx-auto bg白 relative shadow-2xl rounded-none md:rounded-3xl md:overflow-hidden flex flex-col",children:[w&&a.jsx(ue,{onBack:()=>{y(!1),A(null)},onCreate:ie,isEdit:!!P?.isEdit,characterId:P?.id,initial:P?.initial,onUpdated:t=>{y(!1),A(null),c(t)}}),v&&a.jsx(pe,{currentPersona:q,onBack:()=>X(!1),onSave:t=>L(t)}),a.jsx(B,{initial:!1,children:d&&!v&&!w&&a.jsx(ge,{character:d.character,initialMessages:se(d),userPersona:q,onBack:()=>{h(null),b(!1)},onUpdateLastMessage:re,onOpenUserSettings:()=>X(!0),onUpdateUserPersona:t=>L(t),onShowProfile:()=>{O(!0),H(!1),I(null),c(d.character)}})}),a.jsx(B,{initial:!1,children:x&&!v&&!w&&!C&&(ee?a.jsx(Q,{character:x,createdId:x.id,onBack:()=>c(null),onStartChat:t=>U(t),onEdit:t=>{A({initial:t,id:t.id,isEdit:!0}),y(!0)},onDeleted:async()=>{c(null);try{const s=(await Y()).map(e=>({id:String(e.id),name:e.name||"未知",avatar:e.avatar||"",profileImage:"",status:$.ONLINE,bio:e.plot_summary||"",tags:Array.isArray(e.tags)?e.tags:[],creator:D.nickname||"我",oneLinePersona:e.tagline||"",personality:e.personality||"",profession:e.occupation||"",age:e.age?String(e.age):"",roleType:"",gender:e.gender||"",currentRelationship:e.relationship||"",plotTheme:e.plot_theme||"",plotDescription:"",openingLine:e.opening_line||"",styleExamples:Array.isArray(e.styleExamples)?e.styleExamples:[],hobbies:e.hobbies||"",experiences:e.experiences||"",isPublic:e.visibility?e.visibility==="public":!1}));_(s)}catch{_([])}}}):a.jsx(xe,{character:x,onBack:()=>c(null),onStartChat:()=>U(x),isFromChat:Z,isExistingChat:!!E.find(t=>t.characterId===x.id)}))}),C&&!v&&!w&&a.jsx(Q,{character:C.character,createdId:C.id,onBack:()=>I(null),onStartChat:t=>{I(null),U(t)}}),!v&&!w&&a.jsxs(a.Fragment,{children:[a.jsx(fe,{title:p===l.HOME?oe():p===l.CHAT?"聊天":"我的",onFilterClick:()=>{p===l.HOME&&u==="characters"&&y(!0)},showAdd:p===l.HOME&&u==="characters"}),a.jsx(B,{initial:!1,children:a.jsx("div",{className:"flex-1 overflow-y-auto no-scrollbar scroll-smooth min-h-0",children:le()})}),a.jsx(ve,{activeTab:p,onTabChange:f})]})]})})})};export{Le as default};
