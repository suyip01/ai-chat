import{j as e,r as n,R as O}from"./vendor-react-C8XDWPrG.js";import{P as ie,H as Be,M as fe,U as oe,t as Ye,X as le,u as Te,v as He,g as ce,m as Xe,i as ze,w as be,E as We,r as Je,f as ne,C as qe,x as Ie,y as ge,e as re,z as Ee,G as $e,T as Ke,J as Ae,I as Ve,K as Ge,N as Ze,O as Qe,Q as et,V as tt,Y as st,L as Ne}from"./vendor-icons-BT5Yb3Aw.js";import{m as Z,A as je}from"./vendor-motion-DNjvvKGV.js";import{u as at,e as lt,f as nt,l as rt,a as ye,g as it,c as pe,b as ke,d as ot,h as ue,i as ct,j as dt,k as xt,m as mt}from"./user-services-BjP0463N.js";const pt="modulepreload",ut=function(s){return"/"+s},Se={},Ce=function(f,d,v){let o=Promise.resolve();if(d&&d.length>0){let N=function(m){return Promise.all(m.map(l=>Promise.resolve(l).then(j=>({status:"fulfilled",value:j}),j=>({status:"rejected",reason:j}))))};document.getElementsByTagName("link");const t=document.querySelector("meta[property=csp-nonce]"),r=t?.nonce||t?.getAttribute("nonce");o=N(d.map(m=>{if(m=ut(m),m in Se)return;Se[m]=!0;const l=m.endsWith(".css"),j=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${j}`))return;const c=document.createElement("link");if(c.rel=l?"stylesheet":pt,l||(c.as="script"),c.crossOrigin="",c.href=m,r&&c.setAttribute("nonce",r),document.head.appendChild(c),l)return new Promise((S,y)=>{c.addEventListener("load",S),c.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${m}`)))})}))}function h(t){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=t,window.dispatchEvent(r),!r.defaultPrevented)throw t}return o.then(t=>{for(const r of t||[])r.status==="rejected"&&h(r.reason);return f().catch(h)})},kt=({title:s,onFilterClick:f,showAdd:d=!0})=>e.jsxs("div",{className:"sticky top-0 z-20 px-6 py-4 bg-primary-50/80 backdrop-blur-md flex justify-between items-center transition-all",children:[e.jsx("div",{className:"text-2xl font-bold text-slate-800 tracking-tight flex items-center",children:s}),e.jsx("div",{className:"flex gap-4",children:d&&e.jsx("button",{onClick:f,className:"p-2 rounded-full bg-white text-primary-500 shadow-sm hover:shadow-md transition-all active:scale-95","aria-label":"æ·»åŠ ",children:e.jsx(ie,{size:20})})})]});var Re=(s=>(s.ONLINE="åœ¨çº¿",s.OFFLINE="ç¦»çº¿",s.BUSY="å¿™ç¢Œ",s))(Re||{}),he=(s=>(s.TEXT="text",s.SYSTEM="system",s))(he||{}),te=(s=>(s.HOME="home",s.CHAT="chat",s.ME="me",s))(te||{});const St=({activeTab:s,onTabChange:f})=>{const d=v=>`flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${s===v?"text-primary-600 scale-105":"text-slate-400 hover:text-primary-400"}`;return e.jsx("div",{className:"fixed bottom-0 inset-x-0 z-30",children:e.jsxs("div",{className:"mx-auto w-full max-w-md h-20 bg-white/90 backdrop-blur-lg border-t border-primary-100 shadow-[0_-4px_20px_rgba(0,0,0,0.02)] flex justify-around items-center px-4 rounded-none md:rounded-b-3xl md:shadow-2xl",children:[e.jsxs("button",{className:d(te.HOME),onClick:()=>f(te.HOME),children:[e.jsx(Be,{size:24,strokeWidth:s===te.HOME?2.5:2}),e.jsx("span",{className:"text-xs mt-1 font-semibold",children:"ä¸»é¡µ"})]}),e.jsxs("button",{className:d(te.CHAT),onClick:()=>f(te.CHAT),children:[e.jsxs("div",{className:"relative",children:[e.jsx(fe,{size:24,strokeWidth:s===te.CHAT?2.5:2}),e.jsx("span",{className:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-white"})]}),e.jsx("span",{className:"text-xs mt-1 font-semibold",children:"èŠå¤©"})]}),e.jsxs("button",{className:d(te.ME),onClick:()=>f(te.ME),children:[e.jsx(oe,{size:24,strokeWidth:s===te.ME?2.5:2}),e.jsx("span",{className:"text-xs mt-1 font-semibold",children:"æˆ‘çš„"})]})]})})},_e=({chat:s,onClick:f,onTogglePin:d,roundedClass:v})=>{const o=t=>t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1}),h=t=>{t.stopPropagation(),d()};return e.jsxs("div",{onClick:f,className:`group relative flex items-center gap-4 p-4 bg-white ${v||"rounded-2xl"} shadow-[0_6px_14px_rgba(0,0,0,0.06)] hover:shadow-[0_8px_18px_rgba(0,0,0,0.08)] active:shadow-[0_12px_28px_rgba(0,0,0,0.12)] border border-transparent hover:border-primary-100 active:scale-[0.99] transition-all duration-200 cursor-pointer w-full max-w-md mx-auto`,children:[e.jsx("div",{className:"relative flex-shrink-0",children:e.jsx("div",{className:"w-14 h-14 rounded-full p-0.5 bg-gradient-to-tr from-primary-300 to-accent-pink",children:e.jsx("img",{src:s.character.avatar,alt:s.character.name,className:"w-full h-full rounded-full object-cover border-2 border-white"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"font-bold text-slate-800 text-lg truncate",children:s.character.name})}),e.jsx("span",{className:"text-xs text-slate-400 font-medium whitespace-nowrap ml-2",children:o(s.lastMessage.timestamp)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-slate-500 text-sm truncate pr-4 leading-relaxed",children:[s.lastMessage.senderId==="user"&&e.jsx("span",{className:"text-slate-400",children:"ä½ : "}),s.lastMessage.text]}),e.jsxs("div",{className:"flex gap-2 items-center flex-shrink-0",children:[e.jsx("button",{onClick:h,className:`w-6 h-6 flex items-center justify-center rounded-full transition-all ${s.character.isPinned?"bg-primary-50 text-primary-400":"text-slate-200 hover:text-primary-300"}`,children:e.jsx(Ye,{size:14,className:`transform rotate-45 ${s.character.isPinned?"fill-primary-400":""}`})}),s.unreadCount>0&&e.jsx("span",{className:"flex items-center justify-center min-w-[20px] h-5 px-1.5 bg-red-400 text-white text-[10px] font-bold rounded-full",children:s.unreadCount})]})]})]})]})},Ct=({chats:s,onChatClick:f,onTogglePin:d,onDeleteChat:v,isDetailOpen:o=!1})=>{const h=s.filter(x=>x.character.isPinned),t=s.filter(x=>!x.character.isPinned),[r,N]=n.useState({}),[m,l]=n.useState(null),j=n.useRef(0),c=n.useRef(null),S=(x,u)=>{j.current=x.touches[0].clientX,c.current=u},y=(x,u)=>{if(c.current!==u)return;const k=x.touches[0].clientX-j.current,z=Math.max(-96,Math.min(0,k));N(C=>({...C,[u]:z}))},R=x=>{if(c.current!==x)return;const k=(r[x]||0)<-60?-96:0;N(z=>({...z,[x]:k})),c.current=null},U=x=>N(u=>({...u,[x]:0}));return e.jsxs(Z.div,{className:"px-6 pb-24 animate-in fade-in slide-in-from-bottom-4 duration-700",initial:{x:0},animate:o?{x:"-100%"}:{x:0},transition:o?{duration:.3,ease:"linear"}:{duration:0},children:[h.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1",children:"ç½®é¡¶"}),h.map(x=>e.jsxs("div",{className:"relative overflow-hidden mb-3 rounded-2xl",children:[(()=>{const u=Math.min(96,Math.max(0,-(r[x.characterId]||0)));return e.jsx("div",{className:"absolute right-0 top-0 bottom-0 bg-red-500 flex items-center justify-center rounded-r-2xl",style:{width:`${u}px`,transition:"width 120ms ease"},children:e.jsx("button",{onClick:()=>l(x.characterId),className:"text-white font-bold",children:"åˆ é™¤"})})})(),e.jsx("div",{onTouchStart:u=>S(u,x.characterId),onTouchMove:u=>y(u,x.characterId),onTouchEnd:()=>R(x.characterId),style:{transform:`translateX(${r[x.characterId]||0}px)`,transition:"transform 180ms ease"},children:e.jsx(_e,{chat:x,onClick:()=>f(x),onTogglePin:()=>d(x.characterId),roundedClass:(r[x.characterId]||0)<0?"rounded-l-2xl rounded-r-none":"rounded-2xl"})})]},x.characterId))]}),t.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1",children:"æ¶ˆæ¯"}),t.map(x=>e.jsxs("div",{className:"relative overflow-hidden mb-3 rounded-2xl",children:[(()=>{const u=Math.min(96,Math.max(0,-(r[x.characterId]||0)));return e.jsx("div",{className:"absolute right-0 top-0 bottom-0 bg-red-500 flex items-center justify-center rounded-r-2xl",style:{width:`${u}px`,transition:"width 120ms ease"},children:e.jsx("button",{onClick:()=>l(x.characterId),className:"text-white font-bold",children:"åˆ é™¤"})})})(),e.jsx("div",{onTouchStart:u=>S(u,x.characterId),onTouchMove:u=>y(u,x.characterId),onTouchEnd:()=>R(x.characterId),style:{transform:`translateX(${r[x.characterId]||0}px)`,transition:"transform 180ms ease"},children:e.jsx(_e,{chat:x,onClick:()=>f(x),onTogglePin:()=>d(x.characterId),roundedClass:(r[x.characterId]||0)<0?"rounded-l-2xl rounded-r-none":"rounded-2xl"})})]},x.characterId))]}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[80] bg-black/20 animate-[fadeBg_200ms_ease]"}),e.jsx("div",{className:"fixed inset-0 z-[90] flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-slate-200 w-[85%] max-w-sm animate-[fadeCard_200ms_ease]",children:[e.jsx("div",{className:"px-6 py-5 text-center text-slate-800 font-bold",children:"ç¡®è®¤åˆ é™¤æ­¤ä¼šè¯ï¼Ÿ"}),e.jsx("div",{className:"h-[1px] bg-slate-100"}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"flex-1 py-4 text-slate-600 active:opacity-70",onClick:()=>{U(m),l(null)},children:"å–æ¶ˆ"}),e.jsx("div",{className:"w-[1px] bg-slate-100"}),e.jsx("button",{className:"flex-1 py-4 text-red-600 font-bold active:opacity-70",onClick:()=>{const x=m;l(null),v(x)},children:"ç¡®è®¤åˆ é™¤"})]})]})}),e.jsx("style",{children:`
        @keyframes fadeCard { from { opacity: 0; transform: translateY(-6px) } to { opacity: 1; transform: translateY(0) } }
        @keyframes fadeBg { from { opacity: 0 } to { opacity: 1 } }
      `})]}),s.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-primary-100 rounded-full flex items-center justify-center mb-4 text-4xl",children:"ğŸŒ¸"}),e.jsx("p",{className:"text-slate-500 font-medium",children:"æš‚æ— æ¶ˆæ¯"}),e.jsx("p",{className:"text-slate-400 text-sm mt-1",children:"å¿«å»å’Œè§’è‰²èŠå¤©å§ï¼"})]})]})},ht={type:"tween",ease:"easeInOut",duration:.28},ve={type:"tween",ease:"linear",duration:.28},de={duration:.18},ft="/api",bt={async login(s,f){const d=await fetch(`${ft}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,password:f})});if(!d.ok)throw new Error("login_failed");return d.json()}},we=({imageSrc:s,onCrop:f,onCancel:d})=>{const[v,o]=n.useState(1),[h,t]=n.useState({x:0,y:0}),[r,N]=n.useState(!1),[m,l]=n.useState({x:0,y:0}),j=n.useRef(null),c=n.useRef(null),S=n.useRef(null),y=300,R=k=>{N(!0);const z="touches"in k?k.touches[0].clientX:k.clientX,C="touches"in k?k.touches[0].clientY:k.clientY;l({x:z-h.x,y:C-h.y})},U=k=>{if(!r)return;k.preventDefault();const z="touches"in k?k.touches[0].clientX:k.clientX,C="touches"in k?k.touches[0].clientY:k.clientY;t({x:z-m.x,y:C-m.y})},x=()=>{N(!1)},u=()=>{const k=S.current,z=j.current;if(!k||!z)return;const C=k.getContext("2d");if(!C)return;const D=200;k.width=D,k.height=D;const W=z.naturalWidth,g=z.naturalHeight,I=Math.min(W,g),E=y/I,_=D/y;C.fillStyle="#000",C.fillRect(0,0,D,D),C.translate(D/2,D/2),C.translate(h.x*_,h.y*_),C.scale(v*_,v*_),C.scale(E,E),C.drawImage(z,-W/2,-g/2),f(k.toDataURL("image/jpeg",.9))};return e.jsxs("div",{className:"fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center animate-in fade-in duration-300",children:[e.jsxs("div",{className:"absolute top-0 w-full p-4 flex justify-between items-center z-20 text-white",children:[e.jsx("button",{onClick:d,className:"p-2 bg-white/10 rounded-full backdrop-blur-md",children:e.jsx(le,{size:24})}),e.jsx("h3",{className:"font-bold text-lg tracking-wider",children:"è°ƒæ•´å›¾ç‰‡"}),e.jsx("button",{onClick:u,className:"p-2 bg-purple-500 rounded-full text-white shadow-lg shadow-purple-500/30",children:e.jsx(Te,{size:24})})]}),e.jsxs("div",{ref:c,className:"relative w-full h-full overflow-hidden bg-black flex items-center justify-center touch-none select-none",onMouseDown:R,onMouseMove:U,onMouseUp:x,onMouseLeave:x,onTouchStart:R,onTouchMove:U,onTouchEnd:x,children:[e.jsx("img",{ref:j,src:s,alt:"Crop target",className:"absolute max-w-none transition-transform duration-75 ease-linear pointer-events-none",style:{transform:`translate(${h.x}px, ${h.y}px) scale(${v})`,height:y,width:"auto"},draggable:!1}),e.jsx("div",{className:"absolute inset-0 pointer-events-none z-10 flex items-center justify-center",children:e.jsx("div",{className:"absolute border-2 border-white box-content shadow-[0_0_0_9999px_rgba(0,0,0,0.8)]",style:{width:y,height:y},children:e.jsxs("div",{className:"absolute inset-0 grid grid-cols-3 grid-rows-3 opacity-30",children:[e.jsx("div",{className:"border-r border-white"}),e.jsx("div",{className:"border-r border-white"}),e.jsx("div",{className:"border-b border-white col-span-3 row-start-1"}),e.jsx("div",{className:"border-b border-white col-span-3 row-start-2"})]})})})]}),e.jsx("div",{className:"absolute bottom-0 w-full bg-slate-900/80 backdrop-blur-md p-6 pb-10 flex flex-col gap-4 z-20",children:e.jsxs("div",{className:"flex items-center gap-4 text-white justify-center",children:[e.jsx(He,{size:20,className:"text-slate-400"}),e.jsx("input",{type:"range",min:"0.5",max:"3",step:"0.05",value:v,onChange:k=>o(parseFloat(k.target.value)),className:"w-64 h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-purple-500"}),e.jsx(ie,{size:20,className:"text-slate-400"})]})}),e.jsx("canvas",{ref:S,className:"hidden"})]})},Me=({currentPersona:s,roleId:f,onBack:d,onSave:v,withinContainer:o=!1})=>{const[h,t]=n.useState(s?.gender||"female"),[r,N]=n.useState(s?.name||""),[m,l]=n.useState(s?.age||""),[j,c]=n.useState(s?.profession||""),[S,y]=n.useState(s?.basicInfo||""),[R,U]=n.useState(s?.personality||""),[x,u]=n.useState(s?.avatar),[k,z]=n.useState(null),C=n.useRef(null),D=E=>{const _=E.split(","),J=_[0].match(/:(.*?);/)?.[1]||"image/jpeg",q=atob(_[1]);let w=q.length;const $=new Uint8Array(w);for(;w--;)$[w]=q.charCodeAt(w);return new Blob([$],{type:J})},W=async()=>{const E=localStorage.getItem("user_access_token");let _=x;try{if(x&&x.startsWith("data:image")){const q=D(x),w=new FormData,$=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;w.append("avatar",q,"avatar.jpg"),w.append("filename",$),_=`/uploads/users/avatars/${$}`,fetch("/api/uploads/avatar",{method:"POST",headers:{Authorization:E?`Bearer ${E}`:""},body:w}).catch(()=>{})}const J={gender:h,name:r,age:m,profession:j,basicInfo:S,personality:R,avatar:_||void 0};typeof f=="number"?await at(f,J):await lt(J)}catch{}v({gender:h,name:r,age:m,profession:j,basicInfo:S,personality:R,avatar:_}),d()},g=()=>{C.current?.click()},I=E=>{const _=E.target.files?.[0];if(_){const J=new FileReader;J.onloadend=()=>{z(J.result)},J.readAsDataURL(_)}C.current&&(C.current.value="")};return e.jsxs("div",{className:`${o?"absolute":"fixed"} inset-0 z-[80]`,children:[e.jsx(Z.div,{className:"absolute inset-0 bg-[#F8F9FA]",initial:{opacity:0},animate:{opacity:1},transition:de}),e.jsxs(Z.div,{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-[0_-10px_30px_rgba(0,0,0,0.08)] flex flex-col h-[92vh] w-full overflow-y-auto no-scrollbar",initial:{y:"100%"},animate:{y:0},transition:ve,children:[k&&e.jsx(we,{imageSrc:k,onCancel:()=>z(null),onCrop:E=>{u(E),z(null)}}),e.jsxs("div",{className:"mx-auto w-full max-w-md bg-white/90 backdrop-blur-md px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm border-b border-slate-100 rounded-none md:rounded-t-3xl",children:[e.jsx("button",{onClick:d,className:"p-2 -ml-2 text-slate-800 hover:bg-slate-50 rounded-full transition-colors",children:e.jsx(ce,{size:24})}),e.jsx("button",{onClick:W,className:"bg-purple-50 text-purple-600 px-4 py-1.5 rounded-lg text-sm font-bold active:scale-95 transition-transform",children:"å®Œæˆ"})]}),e.jsxs("div",{className:"mx-auto w-full max-w-md bg-white p-4 space-y-3 pb-10 rounded-none md:rounded-b-3xl md:shadow-2xl",children:[e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{onClick:g,className:"relative group cursor-pointer active:scale-95 transition-transform",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-pink-200 flex items-center justify-center text-white shadow-sm border-4 border-white overflow-hidden",children:x?e.jsx("img",{src:x,alt:"User Avatar",className:"w-full h-full object-cover"}):e.jsx(oe,{size:48,fill:"currentColor"})}),e.jsx("div",{className:"absolute bottom-0 right-0 bg-white p-2 rounded-full shadow-md border border-slate-100",children:e.jsx(Xe,{size:14,className:"text-slate-400"})}),e.jsx("input",{type:"file",ref:C,className:"hidden",accept:"image/*",onChange:I})]})}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-4",children:"æ€§åˆ«"}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer group",children:[e.jsx("div",{className:`w-4 h-4 rounded-full border flex items-center justify-center ${h==="male"?"border-blue-500":"border-slate-300"}`,children:h==="male"&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"})}),e.jsx("input",{type:"radio",name:"gender",value:"male",checked:h==="male",onChange:()=>t("male"),className:"hidden"}),e.jsx("span",{className:"text-sm text-slate-700 group-hover:text-slate-900",children:"ç”·æ€§"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer group",children:[e.jsx("div",{className:`w-4 h-4 rounded-full border flex items-center justify-center ${h==="female"?"border-blue-500":"border-slate-300"}`,children:h==="female"&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"})}),e.jsx("input",{type:"radio",name:"gender",value:"female",checked:h==="female",onChange:()=>t("female"),className:"hidden"}),e.jsx("span",{className:"text-sm text-slate-700 group-hover:text-slate-900",children:"å¥³æ€§"})]}),e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer group",children:[e.jsx("div",{className:`w-4 h-4 rounded-full border flex items-center justify-center ${h==="secret"?"border-blue-500":"border-slate-300"}`,children:h==="secret"&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"})}),e.jsx("input",{type:"radio",name:"gender",value:"secret",checked:h==="secret",onChange:()=>t("secret"),className:"hidden"}),e.jsx("span",{className:"text-sm text-slate-700 group-hover:text-slate-900",children:"æœªé€éœ²"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-2",children:"åå­— (å¿…å¡«)"}),e.jsx("input",{type:"text",placeholder:"è¯·è¾“å…¥æ‚¨çš„åå­—",className:"w-full text-sm outline-none placeholder:text-slate-300 py-1",value:r,onChange:E=>N(E.target.value)})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-2",children:"å¹´é¾„"}),e.jsx("input",{type:"text",placeholder:"è¯·è¾“å…¥è§’è‰²å¹´é¾„",className:"w-full text-sm outline-none placeholder:text-slate-300 py-1",value:m,onChange:E=>l(E.target.value)})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-2",children:"èŒä¸š"}),e.jsx("input",{type:"text",placeholder:"è¯·è¾“å…¥è§’è‰²èŒä¸š",className:"w-full text-sm outline-none placeholder:text-slate-300 py-1",value:j,onChange:E=>c(E.target.value)})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-2",children:"åŸºæœ¬ä¿¡æ¯"}),e.jsx("textarea",{placeholder:"è§’è‰²èº«ä»½èƒŒæ™¯å’Œå¤–è²Œç‰¹å¾...",className:"w-full text-sm outline-none placeholder:text-slate-300 py-1 resize-none h-20",value:S,onChange:E=>y(E.target.value)})]}),e.jsxs("div",{className:"bgç™½ rounded-xl p-5 shadow-sm",children:[e.jsx("label",{className:"block font-bold text-slate-800 text-sm mb-2",children:"æ€§æ ¼æè¿°"}),e.jsx("textarea",{placeholder:"è¯·è¾“å…¥æ€§æ ¼æè¿°...",className:"w-full text-sm outline-none placeholder:text-slate-300 py-1 resize-none h-20",value:R,onChange:E=>U(E.target.value)})]})]})]})]})},gt=s=>s==="ç”·"?"male":s==="å¥³"?"female":"secret",Le=({isOpen:s,currentPersona:f,onClose:d,onAdd:v,onSelect:o})=>{const[h,t]=n.useState([]),[r,N]=n.useState(null);n.useEffect(()=>{s&&(async()=>{try{const j=await nt();t(j)}catch{}})()},[s]),n.useEffect(()=>{if(f){const l=h.find(j=>j.name===f.name);l&&N(l.id)}},[h,f]);const m=l=>{N(l.id);const j={name:l.name||"",gender:gt(l.gender),age:l.age?String(l.age):"",profession:l.profession||"",basicInfo:l.basic_info||"",personality:l.personality||"",avatar:l.avatar||void 0};try{localStorage.setItem("user_chat_role_id",String(l.id))}catch{}o(j,l.id),d()};return e.jsx("div",{className:`fixed inset-0 z-[90] ${s?"":"pointer-events-none"}`,children:e.jsx(je,{children:s&&e.jsxs(e.Fragment,{children:[e.jsx(Z.div,{className:"absolute inset-0 bg-black/30 will-change-opacity",onClick:d,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:de},"backdrop"),e.jsxs(Z.div,{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-[0_-10px_30px_rgba(0,0,0,0.08)] will-change-transform transform-gpu",initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:ve,children:[e.jsxs("div",{className:"sticky top-0 bg-white/95 backdrop-blur-md p-3 border-b border-slate-100 flex justify-between items-center z-10",children:[e.jsxs("button",{onClick:d,className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-6 h-6"}),e.jsx("span",{className:"font-bold text-lg",children:"æˆ‘çš„å¤šé‡ä¸ªäººèµ„æ–™"})]}),e.jsx("button",{onClick:v,className:"w-9 h-9 rounded-full bg-purple-50 text-[#A855F7] flex items-center justify-center active:scale-90 transition-transform",children:e.jsx(ie,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-4 flex flex-col gap-3 max-h-[70vh] overflow-y-auto",children:[h.map(l=>e.jsxs("div",{onClick:()=>m(l),className:`p-4 bg-white rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 active:scale-[0.98] transition-transform ${r===l.id?"border-[#A855F7] bg-[#FBF5FF]":""}`,children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-slate-200 flex items-center justify-center text-slate-600 font-bold",children:l.avatar?e.jsx("img",{src:l.avatar,alt:l.name,className:"w-full h-full object-cover"}):(l.name||"æˆ‘")[0]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-slate-800 truncate",children:l.name}),e.jsxs("div",{className:"text-xs text-slate-500 truncate",children:[l.profession||"",l.age?` Â· ${l.age}`:""]})]}),r===l.id&&e.jsx(ze,{className:"w-5 h-5 text-[#A855F7]"})]},l.id)),!h.length&&e.jsxs("div",{className:"p-6 text-center text-slate-500",children:[e.jsx("div",{className:"text-sm",children:"æš‚æ— è§’è‰²"}),e.jsx("div",{className:"mt-3",children:e.jsx("button",{onClick:v,className:"px-3 py-1.5 bg-[#A855F7] text-white rounded-lg text-sm font-bold",children:"æ·»åŠ è§’è‰²"})})]})]})]},"sheet")]})})})},jt=({isOpen:s,currentModelId:f,onClose:d,onSelect:v,temperature:o,onTempChange:h})=>{const[t,r]=n.useState([]),[N,m]=n.useState(f),[l,j]=n.useState(typeof o=="number"?o:.1);return n.useEffect(()=>{m(f)},[f]),n.useEffect(()=>{typeof o=="number"&&j(o)},[o]),n.useEffect(()=>{if(!s)return;(async()=>{try{const y=[...await rt()].sort((R,U)=>(R.nickname||R.id).localeCompare(U.nickname||U.id,"zh-CN",{sensitivity:"base"}));r(y)}catch{}})()},[s]),e.jsx("div",{className:`fixed inset-0 z-[90] ${s?"":"pointer-events-none"}`,children:e.jsx(je,{children:s&&e.jsxs(e.Fragment,{children:[e.jsx(Z.div,{className:"absolute inset-0 bg-black/30 will-change-opacity",onClick:d,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:de},"backdrop"),e.jsxs(Z.div,{className:"absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-[0_-10px_30px_rgba(0,0,0,0.08)] will-change-transform transform-gpu",initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:ve,children:[e.jsxs("div",{className:"sticky top-0 bg-white/95 backdrop-blur-md p-3 border-b border-slate-100 flex justify-between items-center z-10",children:[e.jsxs("button",{onClick:d,className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-6 h-6"}),e.jsx("span",{className:"font-bold text-lg",children:"æˆ‘çš„æ¨¡å‹"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-bold text-slate-700",children:"æ¸©åº¦"}),e.jsx("input",{value:l,onChange:c=>{const S=parseFloat(c.target.value||"0");j(isNaN(S)?0:S),h?.(isNaN(S)?0:S)},type:"number",step:"0.1",min:"0",max:"2",className:"w-16 px-2 py-1 border border-slate-200 rounded-lg text-sm"})]})]}),e.jsxs("div",{className:"p-4 flex flex-col gap-3 max-h-[70vh] overflow-y-auto",children:[t.map(c=>e.jsxs("div",{onClick:()=>{m(c.id),v(c.id,c.nickname),d()},className:`relative p-4 rounded-xl shadow-sm border active:scale-[0.98] transition-transform flex items-center justify-center ${N===c.id?"bg-[#F3E8FF] border-[#A855F7]":"bg-white border-slate-100"}`,children:[e.jsx("div",{className:"w-full text-center font-bold text-slate-800 truncate",children:c.nickname||c.id}),N===c.id&&e.jsx(ze,{className:"w-5 h-5 text-[#A855F7] absolute right-4 top-1/2 -translate-y-1/2"})]},c.id)),!t.length&&e.jsx("div",{className:"p-6 text-center text-slate-500",children:e.jsx("div",{className:"text-sm",children:"æš‚æ— æ¨¡å‹"})})]})]},"sheet")]})})})},_t=({character:s,initialMessages:f,userPersona:d,onBack:v,onUpdateLastMessage:o,onOpenUserSettings:h,onShowProfile:t,onUpdateUserPersona:r})=>{const[N,m]=n.useState(f),[l,j]=n.useState("scene"),[c,S]=n.useState("ï¼ˆï¼‰"),[y,R]=n.useState(!1),[U,x]=n.useState(!1),[u,k]=n.useState(!1),[z,C]=n.useState(!1),[D,W]=n.useState(!1),[g,I]=n.useState(void 0),[E,_]=n.useState(.1),[J,q]=n.useState(void 0),w=n.useRef(null),$=n.useRef(null),H=n.useRef(null),K=r??(p=>{}),[Y,G]=n.useState(null),Q=n.useRef(null),X=`chat_history_${s.id}`,a=`chat_config_${s.id}`,i=`chat_model_${s.id}`,b=`chat_temp_${s.id}`,F=`chat_model_name_${s.id}`,A=(p,T,L)=>{m(B=>{const M=[...B];for(let V=M.length-1;V>=0;V--)if(M[V].senderId==="user"&&!M[V].read){M[V]={...M[V],read:!0};break}const P={id:(Date.now()+1).toString(),senderId:s.id,text:p,quote:T,timestamp:new Date,type:he.TEXT};return M.push(P),o(P),M}),L&&typeof L.chunkIndex=="number"&&typeof L.chunkTotal=="number"?R(L.chunkIndex<L.chunkTotal):R(!1)},ee=()=>{$.current?$.current.scrollTop=$.current.scrollHeight:w.current?.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{ee()},[N,y]),n.useEffect(()=>{const p=()=>{$.current?$.current.scrollTop=$.current.scrollHeight:ee()};return window.addEventListener("resize",p),window.visualViewport&&window.visualViewport.addEventListener("resize",p),()=>{window.removeEventListener("resize",p),window.visualViewport&&window.visualViewport.removeEventListener("resize",p)}},[]),n.useEffect(()=>{try{const p=localStorage.getItem(X);if(p){const L=JSON.parse(p).map(B=>({id:B.id,senderId:B.senderId,text:B.text,timestamp:new Date(B.ts),type:B.type,quote:B.quote,read:B.read}));L.length&&m(L)}}catch{}},[s.id]),n.useEffect(()=>{try{const p=N.map(T=>({id:T.id,senderId:T.senderId,text:T.text,ts:T.timestamp?.getTime?.()?T.timestamp.getTime():Date.now(),type:T.type,quote:T.quote,read:T.read}));localStorage.setItem(X,JSON.stringify(p))}catch{}},[N]),n.useEffect(()=>{try{const p=localStorage.getItem(a);if(p){const P=JSON.parse(p);(P?.chatMode==="daily"||P?.chatMode==="scene")&&j(P.chatMode),P?.persona&&K(P.persona)}const T=localStorage.getItem(i)||void 0,L=localStorage.getItem(b),B=L?parseFloat(L):void 0;T&&I(T),typeof B=="number"&&!isNaN(B)&&_(B);const M=localStorage.getItem(F)||void 0;M&&q(M)}catch{}},[s.id]),n.useEffect(()=>{const p=`chat_session_${s.id}`,T=localStorage.getItem(p);return(async()=>{if(T){G(T);try{const M=await it(T);if(M?.model?.nickname){q(M.model.nickname);try{localStorage.setItem(F,M.model.nickname)}catch{}}if(M?.temperature!==void 0){_(M.temperature);try{localStorage.setItem(b,String(M.temperature))}catch{}}}catch{}const B=pe(T,(M,P,V)=>{A(M,P,V)});Q.current=B;return}try{const B=localStorage.getItem("user_chat_role_id"),M=B?parseInt(B):void 0,P=await ke(s.id,typeof M=="number"?M:void 0),V=P.sessionId;if(localStorage.setItem(p,V),G(V),P.model?.id){I(P.model.id);try{localStorage.setItem(i,P.model.id)}catch{}}if(P.model?.nickname){q(P.model.nickname);try{localStorage.setItem(F,P.model.nickname)}catch{}}if(typeof P.temperature=="number"){_(P.temperature);try{localStorage.setItem(b,String(P.temperature))}catch{}}const xe=pe(V,(me,Oe,Ue)=>{A(me,Oe,Ue)});Q.current=xe}catch{}})(),()=>{Q.current?.close(),Q.current=null}},[s.id]);const se=p=>{j(p),p==="scene"?!c.includes("ï¼ˆ")&&!c.includes("(")?S(T=>`ï¼ˆï¼‰${T}`):c===""&&S("ï¼ˆï¼‰"):(c==="ï¼ˆï¼‰"||c==="()")&&S("");try{localStorage.setItem(a,JSON.stringify({chatMode:p,persona:d||void 0}))}catch{}},ae=async()=>{if(!c.trim()||c.trim()==="ï¼ˆï¼‰"||c.trim()==="()")return;const p={id:Date.now().toString(),senderId:"user",text:c,timestamp:new Date,type:he.TEXT,read:!1};m(T=>[...T,p]),o(p),S(l==="scene"?"ï¼ˆï¼‰":""),R(!0);try{if(!Y){const T=localStorage.getItem("user_chat_role_id"),L=T?parseInt(T):void 0,M=(await ke(s.id,typeof L=="number"?L:void 0)).sessionId;localStorage.setItem(`chat_session_${s.id}`,M),G(M);const P=pe(M,(V,xe,me)=>{A(V,xe,me)});Q.current=P}Q.current?.sendText(p.text,l,d),Q.current?.sendTyping(!1)}catch(T){console.error(T),R(!1)}},De=p=>p.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1});return e.jsx(Z.div,{className:"fixed inset-0 bg-primary-50 z-50",style:{height:"calc(var(--vh) * 100)",overscrollBehavior:"none"},initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.3,ease:"linear"},children:e.jsxs("div",{className:"mx-auto w-full max-w-md h-full flex flex-col relative bg-white shadow-2xl rounded-none md:rounded-3xl md:overflow-hidden",children:[e.jsx("div",{className:"bg-primary-50/95 backdrop-blur-md pt-[env(safe-area-inset-top)] shadow-none z-10 border-b border-white/50 flex-shrink-0",children:e.jsxs("div",{className:"px-4 h-12 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:v,className:"p-2 -ml-2 text-slate-800 hover:bg-black/5 rounded-full transition-colors",children:e.jsx(be,{size:24})}),e.jsx("div",{className:"flex items-center cursor-pointer active:opacity-70 transition-opacity",onClick:t,children:e.jsx("h2",{className:"font-bold text-slate-800 text-lg",children:y?"æ­£åœ¨è¾“å…¥ä¸­...":s.name})})]}),e.jsx("button",{onClick:()=>x(!0),className:"p-2 text-slate-800 hover:text-primary-600 rounded-full hover:bg-black/5 transition-all",children:e.jsx(We,{size:24})})]})}),e.jsxs("div",{ref:$,className:"flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar bg-primary-50",style:{overflowAnchor:"none"},children:[e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("span",{className:"bg-black/10 text-white text-[10px] px-3 py-1 rounded-full font-medium",children:"ä»Šå¤©"})}),N.map((p,T)=>{const L=p.senderId==="user";return e.jsxs("div",{className:`flex w-full ${L?"justify-end":"justify-start"} mb-4 group`,children:[!L&&e.jsx("div",{className:"flex-shrink-0 mr-3 flex flex-col items-center gap-1",children:e.jsx("div",{onClick:t,className:"w-10 h-10 rounded-full overflow-hidden bg-blue-100 flex items-center justify-center text-blue-500 font-bold border border-white cursor-pointer active:scale-95 transition-transform",children:s.avatar?e.jsx("img",{src:s.avatar,alt:s.name,className:"w-full h-full object-cover"}):s.name[0]})}),e.jsxs("div",{className:`flex flex-col ${L?"items-end":"items-start"} max-w-[75%]`,children:[e.jsx("div",{className:`
                      px-4 py-3 text-[15px] shadow-sm leading-relaxed relative
                      ${L?"bg-[#A855F7] text-white rounded-[20px] rounded-tr-sm":"bg-white text-slate-800 rounded-[20px] rounded-tl-sm border border-slate-100"}
                    `,children:p.text}),!L&&p.quote&&e.jsx("div",{className:"mt-1 max-w-full",children:e.jsx("div",{className:"inline-block bg-slate-100 text-slate-500 text-xs leading-tight rounded-[12px] px-2 py-1 border border-slate-200",children:p.quote})}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${L?"mr-1":"ml-1"}`,children:[L&&p.read&&e.jsx("span",{className:"text-[10px] text-slate-400",children:"å·²è¯»"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:De(p.timestamp)})]})]}),L&&e.jsx("div",{className:"flex-shrink-0 ml-3",children:e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-pink-200 flex items-center justify-center text-pink-600 font-bold border border-white shadow-sm",children:d?.avatar?e.jsx("img",{src:d.avatar,alt:"Me",className:"w-full h-full object-cover"}):"å‚²"})})]},p.id)}),e.jsx("div",{ref:w})]}),e.jsx("div",{className:"bg-white p-3 pb-3 border-t border-slate-100 shadow-[0_-4px_20px_rgba(0,0,0,0.02)] pb-[env(safe-area-inset-bottom)] mb-3 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-2 bg-white rounded-[24px] px-3 py-2 border border-slate-100 shadow-[0_12px_28px_rgba(0,0,0,0.12)] transition-shadow focus-within:shadow-[0_16px_40px_rgba(0,0,0,0.16)]",children:[e.jsx("div",{className:"flex-1 flex items-center pl-2",children:e.jsx("textarea",{ref:H,value:c,onChange:p=>{S(p.target.value),Q.current?.sendTyping(!0)},onKeyDown:p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),ae())},onBlur:()=>Q.current?.sendTyping(!1),placeholder:"",className:"w-full bg-transparent border-none outline-none focus:ring-0 text-slate-700 text-sm p-0 resize-none max-h-24 overflow-y-auto leading-5 placeholder:text-slate-400",rows:1,style:{minHeight:"22px"}})}),e.jsx("button",{onClick:ae,disabled:!c.trim()||c.trim()==="ï¼ˆï¼‰",className:`p-2 rounded-full transition-all duration-300 flex-shrink-0 flex items-center justify-center ${c.trim()&&c.trim()!=="ï¼ˆï¼‰"?"bg-[#A855F7] text-white shadow-md active:scale-95":"bg-transparent text-[#A855F7]"}`,children:e.jsx(Je,{size:20,className:c.trim()&&c.trim()!=="ï¼ˆï¼‰"?"ml-0.5":""})})]})}),e.jsx(je,{initial:!1,children:U&&e.jsxs(e.Fragment,{children:[e.jsx(Z.div,{className:"absolute inset-0 bg-black/20 z-[60] will-change-opacity",onClick:()=>x(!1),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:de}),e.jsxs(Z.div,{className:"absolute top-0 right-0 h-full w-3/4 bg-white z-[70] shadow-2xl will-change-transform transform-gpu",initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:ht,children:[e.jsxs("div",{className:"p-5 border-b border-slate-100 flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-lg text-slate-800",children:"èŠå¤©è®¾ç½®"}),e.jsx("button",{onClick:()=>x(!1),className:"text-slate-400 hover:text-slate-600",children:e.jsx(le,{size:24})})]}),e.jsxs("div",{className:"p-2",children:[e.jsxs("button",{onClick:()=>{x(!1),C(!0)},className:"w-full flex items-center justify-between p-4 hover:bg-slate-50 rounded-xl transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-700",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600",children:e.jsx(oe,{size:18})}),e.jsx("span",{className:"font-bold text-sm",children:"æˆ‘çš„è§’è‰²è®¾ç½®"})]}),e.jsx(ne,{size:16,className:"text-slate-300"})]}),e.jsx("div",{className:"h-[1px] bg-slate-50 mx-4"}),e.jsxs("button",{onClick:()=>{x(!1),W(!0)},className:"w-full flex items-center justify-between p-4 hover:bg-slate-50 rounded-xl transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-700",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600",children:e.jsx(qe,{size:18})}),e.jsx("span",{className:"font-bold text-sm",children:"æ¨¡å‹"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-slate-500",children:J||"é»˜è®¤"}),e.jsx(ne,{size:16,className:"text-slate-300"})]})]}),e.jsx("div",{className:"h-[1px] bg-slate-50 mx-4"}),e.jsxs("div",{className:"w-full flex items-center justify-between p-4 hover:bg-slate-50 rounded-xl transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 text-slate-700",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600",children:e.jsx(Ie,{size:18})}),e.jsx("span",{className:"font-bold text-sm",children:"èŠå¤©æ¨¡å¼"})]}),e.jsxs("div",{className:"flex bg-slate-100 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>se("daily"),className:`px-3 py-1 text-xs font-bold rounded-md transition-all ${l==="daily"?"bg-white text-slate-800 shadow-sm":"text-slate-400"}`,children:"æ—¥å¸¸"}),e.jsx("button",{onClick:()=>se("scene"),className:`px-3 py-1 text-xs font-bold rounded-md transition-all ${l==="scene"?"bg-white text-purple-600 shadow-sm":"text-slate-400"}`,children:"åœºæ™¯"})]})]})]})]})]})}),u&&e.jsx(Me,{currentPersona:void 0,onBack:()=>k(!1),onSave:p=>{k(!1),C(!0)},withinContainer:!0}),e.jsx(Le,{isOpen:z,currentPersona:d,onClose:()=>C(!1),onAdd:()=>{C(!1),k(!0)},onSelect:p=>{K(p);try{localStorage.setItem(a,JSON.stringify({chatMode:l,persona:p}))}catch{}}}),e.jsx(jt,{isOpen:D,currentModelId:g,onClose:()=>W(!1),onSelect:(p,T)=>{I(p),q(T);try{localStorage.setItem(i,p),T&&localStorage.setItem(F,T)}catch{}Y&&ye(Y,{modelId:p}).catch(()=>{})},temperature:E,onTempChange:p=>{_(p);try{localStorage.setItem(b,String(p))}catch{}Y&&ye(Y,{temperature:p}).catch(()=>{})}})]})})},Pe=n.createContext({showToast:()=>{},showCenter:()=>{}}),Tt=({children:s})=>{const[f,d]=n.useState([]),v=n.useRef(new Map),o=(r,N)=>{const m=v.current.get(r);m&&clearTimeout(m);const l=window.setTimeout(()=>{d(j=>j.filter(c=>c.id!==r)),v.current.delete(r)},N);v.current.set(r,l)},h=(r,N="info")=>{const m=Date.now(),l=2e3;d(j=>[...j,{id:m,text:r,type:N,position:"bottom",duration:l}]),o(m,l)},t=r=>{d(m=>{const l=m.find(c=>c.position==="center"&&c.text===r);if(l)return o(l.id,3e3),m;const j=Date.now();return o(j,2e3),[...m,{id:j,text:r,type:"center",position:"center",duration:2e3}]})};return e.jsxs(Pe.Provider,{value:{showToast:h,showCenter:t},children:[s,e.jsx("div",{className:"fixed bottom-6 left-0 right-0 z-[100] flex justify-center pointer-events-none",children:e.jsx("div",{className:"space-y-2",children:f.filter(r=>r.position==="bottom").map(r=>e.jsx("div",{className:`${r.type==="role"?"bg-white text-pink-600 border border-pink-200 shadow-md":r.type==="error"?"bg-red-500 text-white":r.type==="success"?"bg-green-500 text-white":"bg-slate-800 text-white"} px-4 py-2 rounded-2xl shadow-lg inline-block`,children:r.text},r.id))})}),e.jsx("div",{className:"fixed top-[25%] left-1/2 -translate-x-1/2 z-[100] pointer-events-none",children:e.jsx("div",{className:"space-y-2 flex flex-col items-center",children:f.filter(r=>r.position==="center").map(r=>e.jsx("div",{className:"bg-white text-slate-800 px-6 py-3 rounded-2xl shadow-2xl border border-slate-200 whitespace-nowrap",children:r.text},r.id))})}),e.jsx("style",{children:`
        @keyframes toastFade {
          0% { opacity: 0; transform: translateY(-6px); }
          10% { opacity: 1; transform: translateY(0); }
          90% { opacity: 1; transform: translateY(0); }
          100% { opacity: 0; transform: translateY(-6px); }
        }
      `})]})},Fe=()=>n.useContext(Pe),zt=({character:s,onBack:f,onStartChat:d,isFromChat:v=!1,isExistingChat:o=!1})=>{const[h,t]=n.useState(!1),{showToast:r,showCenter:N}=Fe(),m=h?s.tags:s.tags.slice(0,4),l=s.tags.length>4;return e.jsx(Z.div,{className:"fixed inset-0 z-50 bg-primary-50",initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.3,ease:"linear"},children:e.jsxs("div",{className:"mx-auto w-full max-w-md h-full flex flex-col bg-white shadow-2xl rounded-none md:rounded-3xl md:overflow-hidden relative",children:[e.jsx("button",{onClick:f,className:"absolute top-4 left-4 z-50 w-10 h-10 bg-black/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/30 transition-all",children:e.jsx(be,{size:24})}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar relative pb-24",children:[e.jsxs("div",{className:"relative w-full h-[55vh]",children:[e.jsx("img",{src:s.profileImage||s.avatar,alt:s.name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-slate-900/60 via-transparent to-slate-900/10"}),e.jsxs("div",{className:"absolute bottom-12 left-6 right-6 z-10 text-white flex flex-col items-start space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-5xl font-bold tracking-wide",children:s.name}),e.jsxs("span",{className:"bg-white/20 backdrop-blur-md px-2 py-0.5 rounded-full text-[10px] border border-white/30 text-white flex items-center gap-1",children:[e.jsx("span",{className:"text-green-400",children:"â—"})," ",s.roleType||"åŸåˆ›"]})]}),e.jsxs("div",{className:"flex items-center text-white text-sm font-medium pl-1",children:[e.jsx("span",{children:s.profession}),e.jsx("span",{className:"mx-2 bg-white w-1 h-1 rounded-full"}),e.jsx("span",{children:s.age})]}),e.jsxs("div",{className:"text-white text-xs font-medium pl-1",children:["by ",s.creator]})]})]}),e.jsxs("div",{className:"relative -mt-6 bg-white rounded-t-none md:rounded-t-[32px] px-6 py-8 min-h-[50vh] z-10",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:m.map((j,c)=>e.jsxs("span",{className:"px-4 py-1.5 rounded-full bg-purple-50 text-purple-600 text-sm font-bold shadow-sm",children:["# ",j]},c))}),l&&e.jsx("div",{className:"flex justify-center mb-8",children:e.jsxs("button",{onClick:()=>t(!h),className:"text-xs text-purple-300 flex items-center gap-1 font-bold hover:text-purple-400 transition-colors",children:[h?"æ”¶èµ·":"å±•ç¤ºæ›´å¤š"," ",h?e.jsx(ge,{size:14}):e.jsx(re,{size:14})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"ä¸€å¥è¯äººè®¾"}),e.jsxs("div",{className:"relative pl-4 py-1",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-purple-400 rounded-full"}),e.jsxs("div",{className:"bg-purple-50/50 p-4 rounded-r-xl text-slate-700 font-bold text-lg",children:["â€œ",s.oneLinePersona,"â€"]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"æ€§æ ¼"}),e.jsx("div",{className:"bg-slate-50 border border-slate-100 rounded-2xl p-5 text-slate-600 leading-7 text-justify text-sm",children:s.personality})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"å½“å‰å…³ç³»"}),e.jsx("div",{children:e.jsxs("span",{className:"inline-flex items-center gap-1 bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-sm font-bold",children:[e.jsx(Ee,{size:12,fill:"currentColor"})," ",s.currentRelationship]})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-900 font-extrabold text-lg mb-4",children:"ç¬¬ä¸€æƒ…èŠ‚"}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"bg-pink-400 text-white text-[10px] px-1.5 py-0.5 rounded font-bold",children:"THEME"}),e.jsx("span",{className:"bg-pink-50 text-pink-800 text-sm font-bold px-2 py-0.5 rounded",children:s.plotTheme})]}),e.jsx("div",{className:"bg-slate-50 border border-slate-100 rounded-2xl p-5 text-slate-600 leading-7 text-justify text-sm mb-4",children:s.plotDescription}),s.openingLine&&e.jsxs("div",{className:"bg-purple-50/50 rounded-2xl p-4 flex items-center",children:[e.jsx("span",{className:"text-purple-600 font-bold text-sm whitespace-nowrap mr-3",children:"è§’è‰²å¼€åœºç™½"}),e.jsx("div",{className:"h-4 w-[1px] bg-purple-200 mr-4"}),e.jsx("span",{className:"text-slate-700 font-bold text-sm",children:s.openingLine})]})]})]})]}),e.jsx("div",{className:"absolute bottom-3 inset-x-0 z-50",children:e.jsx("div",{className:"mx-auto w-full max-w-md bg-white/90 backdrop-blur-md border-t border-slate-100 p-4 pb-[env(safe-area-inset-bottom)]",children:e.jsx("button",{onClick:()=>{if(v){d();return}if(o){N("å½“å‰è§’è‰²å·²ç»åœ¨ä¼šè¯åˆ—è¡¨");return}d()},className:"w-full font-bold text-lg py-4 rounded-2xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-2 bg-purple-200 text-purple-900 shadow-purple-100",children:v?e.jsxs(e.Fragment,{children:[e.jsx(fe,{size:20}),"å›åˆ°èŠå¤©"]}):"å”¤é†’è§’è‰²"})})})]})})},It=({character:s,createdId:f,onBack:d,onStartChat:v,onEdit:o,onDeleted:h})=>{const[t,r]=n.useState(!1),[N,m]=n.useState(!0),[l,j]=n.useState(s),[c,S]=n.useState(!1),[y,R]=n.useState(!1),[U,x]=n.useState(!1);n.useEffect(()=>{let z=!0,C;const D=async()=>{try{const g=await ue(f);if(!z)return;g&&(g.status==="published"||g.system_prompt||g.hasSystemPrompt)&&(m(!0),j(I=>({...I,id:String(g.id||I.id),name:g.name||I.name,avatar:g.avatar||I.avatar,profileImage:I.profileImage,oneLinePersona:g.tagline||I.oneLinePersona,personality:g.personality||I.personality,profession:String(g.occupation||I.profession||""),age:String(g.age||I.age||""),currentRelationship:String(g.relationship||I.currentRelationship||""),plotTheme:String(g.plot_theme||I.plotTheme||""),plotDescription:String(g.plot_summary||I.plotDescription||""),openingLine:String(g.opening_line||I.openingLine||"")})),C&&clearInterval(C))}catch{}};return(async()=>{try{const g=await ue(f);if(!z)return;if(g){j(_=>({..._,id:String(g.id||_.id),name:g.name||_.name,avatar:g.avatar||_.avatar,oneLinePersona:g.tagline||_.oneLinePersona,personality:g.personality||_.personality,profession:String(g.occupation||_.profession||""),age:String(g.age||_.age||""),currentRelationship:String(g.relationship||_.currentRelationship||""),plotTheme:String(g.plot_theme||_.plotTheme||""),plotDescription:String(g.plot_summary||_.plotDescription||""),openingLine:String(g.opening_line||_.openingLine||"")}));const I=!!g.system_prompt||!!g.hasSystemPrompt,E=typeof g.status=="string"?g.status.trim():"";if(E==="draft"){R(!0),m(!1);return}if(E===""&&!I){R(!1),m(!1),C=setInterval(D,3e3),D();return}R(!1),m(!0);return}R(!1),m(!0)}catch{R(!1),m(!0)}})(),()=>{z=!1,clearInterval(C)}},[f]);const u=t?l.tags:l.tags.slice(0,4),k=l.tags.length>4;return e.jsxs(Z.div,{className:"fixed inset-0 z-50 bg-primary-50",initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{duration:.3,ease:"linear"},children:[e.jsxs("div",{className:"mx-auto w-full max-w-md h-full flex flex-col bgç™½ shadow-2xl rounded-none md:rounded-3xl md:overflow-hidden relative",children:[e.jsx("button",{onClick:d,className:"absolute top-4 left-4 z-50 w-10 h-10 bg-black/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black/30 transition-all",children:e.jsx(be,{size:24})}),e.jsx("button",{onClick:()=>o?.(l),className:"absolute top-4 right-4 z-50 w-10 h-10 bg-black/40 text-white rounded-full flex items-center justify-center hover:bg-black/60 transition-all border border-white/30",children:e.jsx($e,{size:20})}),e.jsx("button",{disabled:c,onClick:()=>x(!0),className:`absolute top-16 right-4 z-50 w-10 h-10 bg-black/40 text-white rounded-full flex items-center justify-center hover:bg-black/60 transition-all border border-white/30 ${c?"opacity-60 cursor-not-allowed":""}`,children:e.jsx(Ke,{size:18,className:"text-red-500"})}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar relative pb-24",children:[e.jsxs("div",{className:"relative w-full h-[55vh]",children:[e.jsx("img",{src:l.profileImage||l.avatar,alt:l.name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-slate-900/60 via-transparent to-slate-900/10"}),e.jsxs("div",{className:"absolute bottom-12 left-6 right-6 z-10 text-white flex flex-col items-start space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-5xl font-bold tracking-wide",children:l.name}),e.jsxs("span",{className:"bg-white/20 backdrop-blur-md px-2 py-0.5 rounded-full text-[10px] border border-white/30 text-white flex items-center gap-1",children:[e.jsx("span",{className:"text-green-400",children:"â—"})," ",l.roleType||"åŸåˆ›è§’è‰²"]})]}),e.jsxs("div",{className:"flex items-center text-white text-sm font-medium pl-1",children:[e.jsx("span",{children:l.profession}),e.jsx("span",{className:"mx-2 bg-white w-1 h-1 rounded-full"}),e.jsx("span",{children:l.age})]}),e.jsxs("div",{className:"text-white text-xs font-medium pl-1",children:["by ",l.creator]})]})]}),e.jsxs("div",{className:"relative -mt-6 bg-white rounded-t-none md:rounded-t-[32px] px-6 py-8 min-h-[50vh] z-10",children:[e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:u.map((z,C)=>e.jsxs("span",{className:"px-4 py-1.5 rounded-full bg-purple-50 text-purple-600 text-sm font-bold shadow-sm",children:["# ",z]},C))}),k&&e.jsx("div",{className:"flex justify-center mb-8",children:e.jsxs("button",{onClick:()=>r(!t),className:"text-xs text-purple-300 flex items-center gap-1 font-bold hover:text-purple-400 transition-colors",children:[t?"æ”¶èµ·":"å±•ç¤ºæ›´å¤š"," ",t?e.jsx(ge,{size:14}):e.jsx(re,{size:14})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"ä¸€å¥è¯äººè®¾"}),e.jsxs("div",{className:"relative pl-4 py-1",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-purple-400 rounded-full"}),e.jsxs("div",{className:"bg-purple-50/50 p-4 rounded-r-xl text-slate-700 font-bold text-lg",children:["â€œ",l.oneLinePersona,"â€"]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"æ€§æ ¼"}),e.jsx("div",{className:"bg-slate-50 border border-slate-100 rounded-2xl p-5 text-slate-600 leading-7 text-justify text-sm",children:l.personality})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-500 font-bold text-sm mb-3",children:"å½“å‰å…³ç³»"}),e.jsx("div",{children:e.jsxs("span",{className:"inline-flex items-center gap-1 bg-pink-100 text-pink-500 px-3 py-1 rounded-full text-sm font-bold",children:[e.jsx(Ee,{size:12,fill:"currentColor"})," ",l.currentRelationship]})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"text-purple-900 font-extrabold text-lg mb-4",children:"ç¬¬ä¸€æƒ…èŠ‚"}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"bg-pink-400 text-white text-[10px] px-1.5 py-0.5 rounded font-bold",children:"THEME"}),e.jsx("span",{className:"bg-pink-50 text-pink-800 text-sm font-bold px-2 py-0.5 rounded",children:l.plotTheme})]}),e.jsx("div",{className:"bg-slate-50 border border-slate-100 rounded-2xl p-5 text-slate-600 leading-7 text-justify text-sm mb-4",children:l.plotDescription}),l.openingLine&&e.jsxs("div",{className:"bg-purple-50/50 rounded-2xl p-4 flex items-center",children:[e.jsx("span",{className:"text-purple-600 font-bold text-sm whitespace-nowrap mr-3",children:"è§’è‰²å¼€åœºç™½"}),e.jsx("div",{className:"h-4 w-[1px] bg-purple-200 mr-4"}),e.jsx("span",{className:"text-slate-700 font-bold text-sm",children:l.openingLine})]})]})]})]}),e.jsx("div",{className:"absolute bottom-3 inset-x-0 z-50",children:e.jsx("div",{className:"mx-auto w-full max-w-md bg-white/90 backdrop-blur-md border-t border-slate-100 p-4 pb-[env(safe-area-inset-bottom)]",children:e.jsx("button",{disabled:!N||y,onClick:()=>v(l),className:`w-full font-bold text-lg py-4 rounded-2xl shadow-lg transition-all flex items-center justify-center gap-2 ${N&&!y?"bg-purple-200 text-purple-900 shadow-purple-100 active:scale-[0.98]":"bg-slate-200 text-slate-500 cursor-not-allowed"}`,children:N&&!y?e.jsxs(e.Fragment,{children:[e.jsx(fe,{size:20}),"å”¤é†’è§’è‰²"]}):y?"è¯·ç¼–è¾‘è§’è‰²å’Œç”Ÿæˆè§’è‰²å¡":"è§’è‰²åˆ›å»ºä¸­ï¼Œè¯·ç¨ç­‰ã€‚"})})})]}),U&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[80] bgé»‘/20 animate-[fadeBg_200ms_ease]"}),e.jsx("div",{className:"fixed inset-0 z-[90] flex items-center justify-center",onClick:()=>!c&&x(!1),children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-slate-200 w-[85%] max-w-sm animate-[fadeCard_200ms_ease]",onClick:z=>z.stopPropagation(),children:[e.jsx("div",{className:"px-6 py-5 text-center text-slate-800 font-bold",children:"ç¡®è®¤åˆ é™¤æ­¤è§’è‰²ï¼Ÿ"}),e.jsx("div",{className:"h-[1px] bg-slate-100"}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{disabled:c,className:"flex-1 py-4 text-slate-600 active:opacity-70",onClick:()=>{c||x(!1)},children:"å–æ¶ˆ"}),e.jsx("div",{className:"w-[1px] bg-slate-100"}),e.jsx("button",{disabled:c,className:"flex-1 py-4 text-red-600 font-bold active:opacity-70",onClick:async()=>{if(!c)try{S(!0),await ot(f),x(!1),h?h():d()}catch{S(!1)}},children:"ç¡®è®¤åˆ é™¤"})]})]})}),e.jsx("style",{children:`
            @keyframes fadeCard { from { opacity: 0; transform: translateY(-6px) } to { opacity: 1; transform: translateY(0) } }
            @keyframes fadeBg { from { opacity: 0 } to { opacity: 1 } }
          `})]})]})},Et=({onBack:s,onCreate:f,isEdit:d=!1,characterId:v,initial:o,onUpdated:h})=>{const[t,r]=n.useState({type:"åŸåˆ›è§’è‰²",avatar:"",profileImage:"",name:"",gender:"ç”·",age:"",profession:"",tagline:"",personality:"",searchTags:[],relationship:"é™Œç”Ÿäºº",plotTheme:"",plotSummary:"",openingLine:"",styleExamples:["","",""],hobbies:"",experiences:"",isPublic:!0}),[N,m]=n.useState(!1),[l,j]=n.useState(!0),[c,S]=n.useState(!1),[y,R]=n.useState(""),[U,x]=n.useState(!1),[u,k]=n.useState({}),[z,C]=n.useState(!1),[D,W]=n.useState(null),g=n.useRef(null),I=a=>{const i=a.split(","),b=i[0].match(/:(.*?);/)?.[1]||"image/jpeg",F=atob(i[1]);let A=F.length;const ee=new Uint8Array(A);for(;A--;)ee[A]=F.charCodeAt(A);return new Blob([ee],{type:b})};n.useEffect(()=>{o&&r(i=>({...i,type:o.roleType||i.type,avatar:o.avatar||i.avatar,profileImage:o.profileImage||i.profileImage,name:o.name||i.name,gender:o.gender||i.gender,age:o.age||i.age,profession:o.profession||i.profession,tagline:o.oneLinePersona||i.tagline,personality:o.personality||i.personality,relationship:o.currentRelationship||i.relationship,plotTheme:o.plotTheme||i.plotTheme,plotSummary:o.plotDescription||i.plotSummary,openingLine:o.openingLine||i.openingLine,styleExamples:Array.isArray(o.styleExamples)&&o.styleExamples.length?o.styleExamples:i.styleExamples,hobbies:o.hobbies||i.hobbies,experiences:o.experiences||i.experiences,searchTags:Array.isArray(o.tags)?o.tags:i.searchTags,isPublic:typeof o.isPublic=="boolean"?o.isPublic:i.isPublic}));const a=localStorage.getItem("create_character_draft");if(a&&!d)try{const i=JSON.parse(a);r(b=>({...b,...i}))}catch(i){console.error("Failed to load draft",i)}},[o,d]),n.useEffect(()=>{if(!d||!v)return;const a=!(o&&Array.isArray(o.tags)&&o.tags.length),i=!(o&&Array.isArray(o.styleExamples)&&o.styleExamples.length);!a&&!i||(async()=>{try{const b=await ue(v),F=Array.isArray(b?.styleExamples)?b.styleExamples.slice(0,3):[];for(;F.length<3;)F.push("");r(A=>({...A,name:b?.name??A.name,gender:b?.gender??A.gender,avatar:b?.avatar??A.avatar,tagline:b?.tagline??A.tagline,personality:b?.personality??A.personality,relationship:b?.relationship??A.relationship,plotTheme:b?.plot_theme??A.plotTheme,plotSummary:b?.plot_summary??A.plotSummary,openingLine:b?.opening_line??A.openingLine,hobbies:b?.hobbies??A.hobbies,experiences:b?.experiences??A.experiences,age:b?.age!=null?String(b.age):A.age,profession:b?.occupation??A.profession,searchTags:Array.isArray(b?.tags)?b.tags:A.searchTags,styleExamples:F,isPublic:b?.visibility?b.visibility==="public":A.isPublic}))}catch{}})()},[d,v,o]);const E=["åŸåˆ›è§’è‰²","äºŒæ¬¡åˆ›ä½œ","å…¶ä»–"],_=["é™Œç”Ÿäºº","æš§æ˜§","æ‹çˆ±ä¸­","å†·æˆ˜","åˆ†æ‰‹"],J=["M/M","M/F","BL","BG","è€½ç¾","ç™¾åˆ","è´£ä»»æ„Ÿ","å¶åƒ","å æœ‰æ¬²","éœ¸é“","è°ƒæˆ","è…¹é»‘","æ¸©æŸ”","å¹´ä¸‹","å¹´ä¸Š","æ„Ÿæ€§","ä½“è´´","ç†æ€§","åå·®","æ¿€æƒ…","æ ¡å›­","è´´å¿ƒ","åæ‰§","ç–¯æ‰¹","å‚²å¨‡","èŒåœº","å†·æ¼ ","å¿§éƒ","äººå¤«","å…»èƒƒ","æ§åˆ¶æ¬²","é»äºº","å¯çˆ±","æˆç†Ÿ","æ€§æ„Ÿ"],q=()=>{g.current?.click()},w=a=>{const i=a.target.files?.[0];if(i){const b=new FileReader;b.onloadend=()=>{W(b.result)},b.readAsDataURL(i)}g.current&&(g.current.value="")},$=a=>{t.searchTags.includes(a)?r(i=>({...i,searchTags:i.searchTags.filter(b=>b!==a)})):r(i=>({...i,searchTags:[...i.searchTags,a]}))},H=()=>{const a=y.trim();a&&!t.searchTags.includes(a)&&(r(i=>({...i,searchTags:[...i.searchTags,a]})),R(""))},K=async a=>{if(a){try{const i=localStorage.getItem("user_access_token");let b=t.avatar||null;if(b&&b.startsWith("data:image")){const A=I(b),ee=new FormData,se=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;ee.append("avatar",A,"avatar.jpg"),ee.append("filename",se),b=`/uploads/users/avatars/${se}`;try{await fetch("/api/uploads/avatar",{method:"POST",headers:{Authorization:i?`Bearer ${i}`:""},body:ee})}catch{}}const F={name:t.name||"æœªå‘½å",gender:t.gender,avatar:b,identity:null,tagline:t.tagline,personality:t.personality,relationship:t.relationship,plotTheme:t.plotTheme,plotSummary:t.plotSummary,openingLine:t.openingLine,hobbies:t.hobbies,experiences:t.experiences,age:t.age&&parseInt(t.age,10)||null,occupation:t.profession,character_type:t.type,visibility:t.isPublic?"public":"private",tags:t.searchTags,styleExamples:t.styleExamples.filter(Boolean)};d&&v?await xt(v,F):await mt(F)}catch{}localStorage.setItem("create_character_draft",JSON.stringify(t))}else localStorage.removeItem("create_character_draft"),r({type:"åŸåˆ›è§’è‰²",avatar:"",profileImage:"",name:"",gender:"ç”·",age:"",profession:"",tagline:"",personality:"",searchTags:[],relationship:"é™Œç”Ÿäºº",plotTheme:"",plotSummary:"",openingLine:"",styleExamples:["","",""],hobbies:"",experiences:"",isPublic:!0});x(!1)},Y=()=>{const a={};return t.name.trim()||(a.name=!0),t.age.trim()||(a.age=!0),t.profession.trim()||(a.profession=!0),t.tagline.trim()||(a.tagline=!0),t.personality.trim()||(a.personality=!0),t.searchTags.length===0&&(a.searchTags=!0),t.relationship.trim()||(a.relationship=!0),t.plotTheme.trim()||(a.plotTheme=!0),t.plotSummary.trim()||(a.plotSummary=!0),t.openingLine.trim()||(a.openingLine=!0),k(a),Object.keys(a).length===0},G=async()=>{if(!Y()){C(!0);return}let a=null;try{const b=localStorage.getItem("user_access_token");let F=t.avatar||null;if(F&&F.startsWith("data:image")){const ee=I(F),se=new FormData,ae=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;se.append("avatar",ee,"avatar.jpg"),se.append("filename",ae),F=`/uploads/users/avatars/${ae}`;try{await fetch("/api/uploads/avatar",{method:"POST",headers:{Authorization:b?`Bearer ${b}`:""},body:se})}catch{}}const A={name:t.name,gender:t.gender,avatar:F,identity:null,tagline:t.tagline,personality:t.personality,relationship:t.relationship,plotTheme:t.plotTheme,plotSummary:t.plotSummary,openingLine:t.openingLine,hobbies:t.hobbies,experiences:t.experiences,age:t.age&&parseInt(t.age,10)||null,occupation:t.profession,character_type:t.type,visibility:t.isPublic?"public":"private",tags:t.searchTags,styleExamples:t.styleExamples.filter(Boolean)};d&&v?(await ct(v,A),a=typeof v=="number"?v:parseInt(String(v))||null):a=await dt(A)}catch{}const i={id:a?String(a):`c_${Date.now()}`,name:t.name,avatar:t.avatar||"https://image.pollinations.ai/prompt/anime%20silhouette%20purple?width=400&height=400&nologo=true",profileImage:t.profileImage||t.avatar,status:Re.ONLINE,bio:`${t.age} ${t.profession}`,tags:t.searchTags,isPinned:!1,relationshipLevel:0,creator:"æˆ‘",playCount:"0",age:t.age||"æœªçŸ¥",profession:t.profession||"æœªçŸ¥",gender:t.gender,roleType:t.type,isOriginal:t.type==="åŸåˆ›è§’è‰²",oneLinePersona:t.tagline,personality:t.personality,currentRelationship:t.relationship,plotTheme:t.plotTheme,plotDescription:t.plotSummary,openingLine:t.openingLine,styleExamples:t.styleExamples.filter(b=>b),hobbies:t.hobbies,experiences:t.experiences,isPublic:t.isPublic};localStorage.removeItem("create_character_draft"),d&&h?h(i):f(i)},Q=a=>["ä¾‹ï¼šå“¼ï¼Œåˆ«ä»¥ä¸ºæˆ‘ä¼šæ„Ÿè°¢ä½ ã€‚","ä¾‹ï¼šä»Šæ™šæœˆè‰²çœŸç¾ï¼Œä¸ä¸€èµ·èµ°èµ°å—ï¼Ÿ","ä¾‹ï¼šå†é è¿‘ä¸€æ­¥ï¼Œæˆ‘å°±ä¸å®¢æ°”äº†ã€‚"][a],X="field-label font-kosugi mb-3 text-slate-700 font-bold text-sm block";return e.jsx("div",{className:"fixed inset-0 bg-white z-[60]",children:e.jsxs("div",{className:"mx-auto w-full max-w-md h-full relative flex flex-col overflow-hidden rounded-3xl shadow-2xl bgç™½ font-kosugi",children:[D&&e.jsx(we,{imageSrc:D,onCancel:()=>{W(null),g.current&&(g.current.value="")},onCrop:a=>{r(i=>({...i,avatar:a,profileImage:D})),W(null)}}),e.jsx("div",{className:"ambient-bg hidden"}),e.jsxs("div",{className:"hidden",children:[e.jsx("div",{className:"star",style:{left:"10%",width:"4px",height:"4px"}}),e.jsx("div",{className:"star",style:{left:"80%",animationDelay:"2s",width:"6px",height:"6px"}})]}),e.jsxs("div",{className:"sticky top-0 z-50 bg-white px-4 py-3 flex items-center border-b border-slate-100 rounded-t-3xl relative",children:[e.jsx("button",{onClick:s,className:"w-8 h-8 flex items-center justify-center text-purple-800 hover:bg-purple-100 rounded-full transition",children:e.jsx(ce,{size:20})}),e.jsx("h1",{className:"absolute left-1/2 -translate-x-1/2 text-xl font-bold text-purple-900 font-kosugi",children:d?"ç¼–è¾‘è§’è‰²":"åˆ›å»ºè§’è‰²"}),!d&&e.jsx("button",{onClick:()=>x(!0),className:"ml-auto text-sm font-bold text-purple-600 font-kosugi",children:"å­˜è‰ç¨¿"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar pb-28 px-4 space-y-6",children:[e.jsxs("section",{className:"mt-4",children:[e.jsx("div",{className:"text-[#2E1065] font-bold text-[0.9rem] mb-2 ml-1 font-kosugi",children:"è§’è‰²ç±»å‹è®¾ç½®"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto no-scrollbar pb-1 mt-2",children:E.map(a=>e.jsx("button",{onClick:()=>r(i=>({...i,type:a})),className:`
                                flex-shrink-0 px-5 py-2.5 rounded-2xl text-sm font-bold transition-all whitespace-nowrap tracking-wide font-kosugi
                                ${t.type===a?"bg-purple-500 text-white shadow-purple-200 shadow-md":"bg-white/70 text-slate-500 border-transparent"}
                            `,children:a},a))})]}),e.jsxs("section",{className:"flex flex-col items-center py-2",children:[e.jsxs("div",{onClick:q,className:"relative group cursor-pointer active:scale-95 transition-transform",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-white border-[3px] border-white shadow-xl flex items-center justify-center overflow-hidden relative",children:t.avatar?e.jsx("img",{src:t.avatar,className:"w-full h-full object-cover",alt:"avatar"}):e.jsx("div",{className:"text-purple-200 text-3xl",children:e.jsx(Ae,{size:32})})}),e.jsx("div",{className:"absolute bottom-0 right-0 bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center border-[3px] border-white shadow-md",children:e.jsx(ie,{size:14})})]}),e.jsx("input",{type:"file",ref:g,className:"hidden",accept:"image/*",onChange:w}),e.jsx("p",{className:"mt-2 text-xs text-purple-400 font-bold tracking-wide font-kosugi",children:"ä¸Šä¼ å¤´åƒ"})]}),e.jsxs("section",{className:"glass-card p-6 space-y-6",children:[e.jsx("div",{className:"section-title !font-kosugi !text-purple-900 mb-2",children:"åŸºç¡€è®¾å®š"}),e.jsxs("div",{children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["å§“å",u.name&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsx("div",{className:"relative",children:e.jsx("input",{value:t.name,onChange:a=>r(i=>({...i,name:a.target.value})),type:"text",placeholder:"ä¾‹ï¼šç¥äº‘",className:`dream-input w-full px-4 py-3 text-sm font-bold ${u.name?"border-red-300 bg-red-50":""}`})})]}),e.jsxs("div",{children:[e.jsx("label",{className:X,children:"æ€§åˆ«"}),e.jsx("div",{className:"flex gap-3",children:["ç”·","å¥³","å…¶ä»–"].map(a=>e.jsx("button",{onClick:()=>r(i=>({...i,gender:a})),className:`flex-1 py-2.5 rounded-2xl text-sm font-bold transition font-kosugi ${t.gender===a?a==="ç”·"?"bg-blue-100 text-blue-600 ring-2 ring-blue-200":a==="å¥³"?"bg-pink-100 text-pink-600 ring-2 ring-pink-200":"bg-purple-100 text-purple-600 ring-2 ring-purple-200":"bg-white/50 text-slate-400"}`,children:a},a))})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["å¹´é¾„",u.age&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsx("input",{value:t.age,onChange:a=>r(i=>({...i,age:a.target.value})),type:"text",placeholder:"ä¾‹ï¼š28å²",className:`dream-input w-full px-4 py-3 text-sm font-bold rounded-2xl ${u.age?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{className:"w-full",children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["èŒä¸š",u.profession&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsx("input",{value:t.profession,onChange:a=>r(i=>({...i,profession:a.target.value})),type:"text",placeholder:"ä¾‹ï¼šéª¨ç§‘åŒ»ç”Ÿ",className:`dream-input w-full px-4 py-3 text-sm font-bold rounded-2xl ${u.profession?"border-red-300 bg-red-50":""}`})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["ä¸€å¥è¯äººè®¾",u.tagline&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsx("input",{value:t.tagline,onChange:a=>r(i=>({...i,tagline:a.target.value})),type:"text",placeholder:"ä¾‹ï¼šè¡¨é¢æ¸©æŸ”å…‹å·±å®åˆ™è…¹é»‘",className:`dream-input w-full px-4 py-3 text-sm ${u.tagline?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["æ€§æ ¼",u.personality&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsx("textarea",{value:t.personality,onChange:a=>r(i=>({...i,personality:a.target.value})),rows:3,placeholder:"ä¾‹ï¼šå æœ‰æ¬²å¼ºï¼Œå®¹æ˜“åƒé†‹...",className:`dream-input w-full px-4 py-3 text-sm resize-none ${u.personality?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["è§’è‰²æ ‡ç­¾",u.searchTags&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsxs("div",{onClick:()=>S(!0),className:`dream-input w-full px-3 py-2 min-h-[46px] flex flex-wrap gap-2 items-center bg-white/60 cursor-pointer hover:bg-white/80 transition ${u.searchTags?"border-red-300 bg-red-50":""}`,children:[t.searchTags.length===0&&e.jsx("span",{className:"text-xs text-[#B3A4C8] ml-1",children:"ç‚¹å‡»æ·»åŠ æ ‡ç­¾ (#å‚²å¨‡ #é«˜å†·...)"}),t.searchTags.map(a=>e.jsxs("span",{className:"tag-pill px-2 py-1 flex items-center shadow-sm",children:["#",a,e.jsx(le,{size:12,className:"ml-1 opacity-60 hover:opacity-100 cursor-pointer",onClick:i=>{i.stopPropagation(),$(a)}})]},a)),e.jsx(ne,{className:"ml-auto text-purple-300",size:16})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:`${X} flex items-center gap-1`,children:["å½“ä¸‹çš„å…³ç³»",u.relationship&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"å¿…å¡«"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[e.jsx("button",{onClick:()=>{m(!0),r(a=>({...a,relationship:""}))},className:`px-4 py-2 rounded-xl text-xs font-bold transition-all font-kosugi ${N?"bg-purple-500 text-white shadow-md":"bg-white text-slate-500 border border-purple-100"}`,children:"è‡ªå®šä¹‰"}),_.map(a=>e.jsx("button",{onClick:()=>{m(!1),r(i=>({...i,relationship:a}))},className:`px-4 py-2 rounded-xl text-xs font-bold transition-all font-kosugi ${t.relationship===a&&!N?"bg-purple-500 text-white shadow-md":"bg-white text-slate-500 border border-purple-100"}`,children:a},a))]}),N&&e.jsx("div",{className:"relative animate-in fade-in",children:e.jsx("input",{value:t.relationship,onChange:a=>r(i=>({...i,relationship:a.target.value})),type:"text",placeholder:"è¯·è¾“å…¥è‡ªå®šä¹‰å…³ç³»",className:`dream-input w-full px-4 py-2 text-sm ${u.relationship?"border-red-300 bg-red-50":""}`})})]})]}),e.jsxs("section",{className:"glass-card p-6 space-y-5",children:[e.jsx("div",{className:"section-title !font-kosugi !text-purple-900 mb-4",children:"ç¬¬ä¸€æƒ…èŠ‚"}),e.jsxs("p",{className:"text-xs text-slate-500 leading-relaxed bg-purple-50/50 p-3 rounded-xl border border-purple-100 flex gap-1",children:[e.jsx(Ve,{size:14,className:"text-purple-400 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"ç¬¬ä¸€æƒ…èŠ‚çš„å†…å®¹å°†è¢«åº”ç”¨äºå’Œè§’è‰²çš„ç¬¬ä¸€æ¬¡èŠå¤©ã€‚æ­¤å¤–ï¼Œè®¾å®šç¬¬ä¸€æƒ…èŠ‚å¹¶é€‰æ‹©å…¬å¼€è§’è‰²åï¼Œæƒ…èŠ‚å†…å®¹å°†æ˜¾ç¤ºåœ¨è§’è‰²èµ„æ–™é¡µä¸Šã€‚"})]}),e.jsxs("div",{className:"bg-white/40 p-4 rounded-3xl border border-purple-100/50 space-y-4",children:[e.jsxs("div",{className:"relative group/input",children:[e.jsxs("label",{className:"text-xs font-bold text-slate-600 mb-2 flex items-center gap-1 font-kosugi",children:["ä¸»é¢˜",u.plotTheme&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal",children:"å¿…å¡«"})]}),e.jsx("input",{value:t.plotTheme,onChange:a=>r(i=>({...i,plotTheme:a.target.value})),type:"text",placeholder:"ä¾‹ï¼šå½“æ¸©æŸ”äººå¤«ç»ˆäºçˆ†å‘è…¹é»‘å±æ€§",className:`dream-input w-full px-3 py-2.5 rounded-xl text-sm bg-white/80 ${u.plotTheme?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{className:"relative group/input",children:[e.jsxs("label",{className:"text-xs font-bold text-slate-600 mb-2 flex items-center gap-1 font-kosugi",children:["æƒ…èŠ‚æ¢—æ¦‚",u.plotSummary&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal",children:"å¿…å¡«"})]}),e.jsx("textarea",{value:t.plotSummary,onChange:a=>r(i=>({...i,plotSummary:a.target.value})),rows:5,placeholder:"ä¾‹ï¼šåœ¨ä¸€èµ·è¿™ä¹ˆä¹…äº†ï¼Œä»–è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„æ¸©æŸ”ä½“è´´ï¼Œä»æ¥ä¸å¹²æ¶‰ä½ çš„ä¸ªäººç”Ÿæ´»ã€‚ä»Šå¤©æ™šä¸Šä½ å»é…’å§ç©ï¼Œæ•…æ„è£…ä½œå–é†‰å’Œä»–æ‰“ç”µè¯ï¼Œå´åœ¨ä»–åº”äº†ä¸€å£°åå¼€å§‹è½¯å£°å«ç€åˆ«äººçš„åå­—......",className:`dream-input w-full px-3 py-2.5 rounded-xl text-sm bg-white/80 resize-none leading-relaxed ${u.plotSummary?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{className:"relative group/input",children:[e.jsxs("label",{className:"text-xs font-bold text-slate-600 mb-2 flex items-center gap-1 font-kosugi",children:["å¼€åœºç™½",u.openingLine&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal",children:"å¿…å¡«"})]}),e.jsx("textarea",{value:t.openingLine,onChange:a=>r(i=>({...i,openingLine:a.target.value})),rows:2,placeholder:"ä¾‹ï¼šâ€œå‡ºæ¥ï¼Œæˆ‘åœ¨é…’å§é—¨å£â€",className:`dream-input w-full px-3 py-2.5 rounded-xl text-sm bg-white/80 resize-none ${u.openingLine?"border-red-300 bg-red-50":""}`})]})]})]}),e.jsxs("section",{className:"glass-card p-0 overflow-hidden transition-all",children:[e.jsxs("button",{onClick:()=>j(!l),className:"w-full flex items-center justify-between p-6 bg-transparent transition",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"section-title !font-kosugi !text-purple-900 mb-0",children:"è¿›é˜¶è®¾å®š"}),e.jsx("span",{className:"text-[10px] bg-purple-100 text-purple-500 px-1.5 py-0.5 rounded font-bold border border-purple-200 self-center font-kosugi",children:"å¯é€‰"})]}),l?e.jsx(ge,{className:"text-purple-400"}):e.jsx(re,{className:"text-purple-400"})]}),l&&e.jsxs("div",{className:"p-6 pt-0 space-y-5 animate-in slide-in-from-top-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:X,children:"è¯´è¯é£æ ¼ç¤ºä¾‹"}),e.jsx("div",{className:"space-y-3",children:[0,1,2].map(a=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-bold text-purple-300 w-4 font-mono",children:["0",a+1]}),e.jsx("input",{value:t.styleExamples[a],onChange:i=>{const b=[...t.styleExamples];b[a]=i.target.value,r(F=>({...F,styleExamples:b}))},type:"text",placeholder:Q(a),className:"dream-input flex-1 px-3 py-2.5 rounded-xl text-sm"})]},a))})]}),e.jsxs("div",{children:[e.jsx("label",{className:X,children:"çˆ±å¥½"}),e.jsx("textarea",{value:t.hobbies,onChange:a=>r(i=>({...i,hobbies:a.target.value})),rows:2,placeholder:"ä¾‹ï¼šå–œæ¬¢çœ‹ä¹¦ã€æ”¶é›†å¤è‘£æ€€è¡¨...",className:"dream-input w-full px-4 py-3 text-sm resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:X,children:"ç»å†"}),e.jsx("textarea",{value:t.experiences,onChange:a=>r(i=>({...i,experiences:a.target.value})),rows:2,placeholder:"è¯·å¡«å†™è§’è‰²ä¸ªäººç»å†æˆ–ä½ ä»¬çš„å…±åŒç»å†",className:"dream-input w-full px-4 py-3 text-sm resize-none"})]}),e.jsxs("div",{className:"pt-2 border-t border-purple-100",children:[e.jsx("label",{className:`${X} mb-1`,children:"æ˜¯å¦å…¬å¼€"}),e.jsx("p",{className:"text-[10px] text-slate-500 leading-tight mb-3",children:"é€‰æ‹©å…¬å¼€ï¼Œè§’è‰²å°†è¢«å‘å¸ƒåˆ°å¹¿åœºä¾›å…¶ä»–ç”¨æˆ·é€‰æ‹©å’Œä½¿ç”¨ã€‚ä¸å…¬å¼€è§’è‰²åˆ™ä»…ä¾›ä¸ªäººä½¿ç”¨ã€‚"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>r(a=>({...a,isPublic:!0})),className:`flex-1 py-2.5 rounded-2xl text-sm font-bold transition flex items-center justify-center gap-1 font-kosugi ${t.isPublic?"bg-purple-500 text-white shadow-md":"bg-white text-slate-500 border border-purple-100"}`,children:[e.jsx(Ge,{size:14})," å…¬å¼€"]}),e.jsxs("button",{onClick:()=>r(a=>({...a,isPublic:!1})),className:`flex-1 py-2.5 rounded-2xl text-sm font-bold transition flex items-center justify-center gap-1 font-kosugi ${t.isPublic?"bg-white text-slate-500 border border-purple-100":"bg-purple-500 text-white shadow-md"}`,children:[e.jsx(Ze,{size:14})," ä¸å…¬å¼€"]})]})]})]})]})]}),e.jsx("div",{className:"absolute bottom-0 inset-x-0 mx-auto w-full max-w-md bg-white/90 backdrop-blur-md p-4 z-50 border-t border-purple-50 rounded-b-3xl shadow-2xl",children:e.jsx("button",{onClick:G,className:"w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-purple-300 active:scale-95 transition-transform flex items-center justify-center tracking-widest text-lg font-kosugi",children:d?"æ›´æ–°è§’è‰²å¡":"ç”Ÿæˆè§’è‰²å¡"})}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 backdrop-blur-[2px] z-[61]",onClick:()=>S(!1)}),e.jsxs("div",{className:"fixed bottom-0 left-0 w-full bg-white rounded-t-[30px] z-[62] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col h-[80vh] animate-in slide-in-from-bottom duration-300",children:[e.jsxs("div",{className:"px-5 py-4 flex justify-between items-center border-b border-purple-50 bg-white rounded-t-[30px]",children:[e.jsx("button",{onClick:()=>S(!1),className:"w-8 h-8 rounded-full bg-purple-50 text-purple-800 flex items-center justify-center",children:e.jsx(re,{size:20})}),e.jsx("h3",{className:"text-lg font-bold text-purple-900 font-kosugi",children:"æ·»åŠ  #æ ‡ç­¾"}),e.jsx("button",{onClick:()=>S(!1),className:"text-sm font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full font-kosugi",children:"å®Œæˆ"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 pb-10",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1 font-kosugi",children:"é€‰å®šçš„æ ‡ç­¾"}),e.jsxs("div",{className:"flex flex-wrap gap-2 min-h-[46px] bg-purple-50/50 p-3 rounded-xl border border-purple-100 border-dashed",children:[t.searchTags.length===0&&e.jsx("span",{className:"text-xs text-slate-400 self-center",children:"æš‚æ— æ ‡ç­¾"}),t.searchTags.map(a=>e.jsxs("button",{onClick:()=>$(a),className:"bg-purple-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm flex items-center gap-1 font-kosugi",children:["#",a," ",e.jsx(le,{size:10,className:"opacity-80"})]},a))]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1 font-kosugi",children:"ç›´æ¥æ·»åŠ  (è‡ªå®šä¹‰)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:y,onChange:a=>R(a.target.value),onKeyDown:a=>a.key==="Enter"&&H(),type:"text",placeholder:"è¾“å…¥æ ‡ç­¾ï¼Œä¸ç”¨åŠ #",className:"dream-input flex-1 px-4 py-2 text-sm bg-white"}),e.jsx("button",{onClick:H,className:"bg-gradient-to-r from-purple-400 to-purple-500 text-white px-4 rounded-xl font-bold text-sm shadow-md active:scale-95 transition font-kosugi",children:"æ·»åŠ "})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1 font-kosugi",children:"æ ‡ç­¾é€‰æ‹©"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:J.map(a=>e.jsxs("button",{onClick:()=>$(a),className:`
                                            rounded-2xl font-bold text-[0.85rem] px-2 py-2 transition-all whitespace-nowrap overflow-hidden text-ellipsis font-kosugi
                                            ${t.searchTags.includes(a)?"bg-[#8B5CF6] text-white shadow-md":"bg-[#F3E8FF] text-[#6B21A8]"}
                                        `,children:["#",a]},a))})]})]})]})]}),U&&e.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-3xl p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 text-center mb-4 font-kosugi",children:d?"æ˜¯å¦åªæ›´æ–°å†…å®¹ï¼Ÿ":"æ˜¯å¦ä¿å­˜è‰ç¨¿ï¼Ÿ"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>K(!1),className:"flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors font-kosugi",children:d?"å–æ¶ˆ":"å¦"}),e.jsx("button",{onClick:()=>K(!0),className:"flex-1 py-2.5 rounded-xl bg-purple-500 text-white font-bold shadow-lg shadow-purple-200 hover:bg-purple-600 transition-colors font-kosugi",children:d?"ç¡®è®¤æ›´æ–°":"æ˜¯"})]})]})}),z&&e.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-3xl p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200 flex flex-col items-center",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-3",children:e.jsx(Qe,{size:28})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 text-center mb-1 font-kosugi",children:"æœ‰å†…å®¹æ²¡å¡«å†™å®Œå“¦ï½"}),e.jsx("p",{className:"text-xs text-slate-400 text-center mb-5 font-kosugi",children:"è¯·å®Œå–„æ‰€æœ‰å¿…å¡«é¡¹åç»§ç»­"}),e.jsx("button",{onClick:()=>C(!1),className:"w-full py-2.5 rounded-xl bg-purple-500 text-white font-bold shadow-lg shadow-purple-200 hover:bg-purple-600 transition-colors font-kosugi",children:"æˆ‘çŸ¥é“äº†"})]})})]})})},$t=({onLogin:s})=>{const[f,d]=n.useState(""),[v,o]=n.useState(""),[h,t]=n.useState(!1),{showToast:r}=Fe(),[N,m]=n.useState(!1),l=async()=>{if(!f||!v){r("è¯·è¾“å…¥è´¦å·å’Œå¯†ç ","error");return}t(!0);try{const y=await bt.login(f,v);y?.access_token&&localStorage.setItem("user_access_token",y.access_token),y?.refresh_token&&localStorage.setItem("user_refresh_token",y.refresh_token),setTimeout(()=>{m(!0),setTimeout(s,300)},200)}catch(y){console.error(y),r("ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ","error")}finally{t(!1)}},[j,c]=n.useState(!1),S=()=>{c(!j)};return O.createElement(Z.div,{className:"min-h-screen w-full flex items-center justify-center bg-primary-50 relative overflow-hidden font-sans text-slate-800",initial:{x:0},animate:{x:N?"-100%":0},transition:{duration:.3,ease:"linear"}},O.createElement("div",{className:"relative z-10 w-full max-w-md p-6 sm:p-12 flex flex-col justify-center"},O.createElement("div",{className:"text-center mb-10 sm:mb-12 space-y-3"},O.createElement("h1",{className:"text-3xl sm:text-4xl font-bold tracking-tight text-slate-800"},"Welcome back"),O.createElement("p",{className:"text-slate-500 text-sm sm:text-base leading-relaxed max-w-xs mx-auto"},"You can search course, apply course and find scholarship for abroad studies")),O.createElement("form",{className:"space-y-6",onSubmit:y=>{y.preventDefault(),l()}},O.createElement("div",{className:"group relative transition-all duration-300"},O.createElement("input",{type:"text",value:f,onChange:y=>d(y.target.value),className:"w-full px-5 py-4 rounded-2xl border-2 border-slate-200 bg-white/60 text-slate-700 placeholder:text-slate-300 focus:outline-none focus:ring-0 focus:border-primary-500 focus:bg-white focus:shadow-[0_0_0_4px_rgba(168,85,247,0.15)] transition-all pr-12",placeholder:"Username"}),O.createElement("div",{className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-purple-500 pointer-events-none transition-opacity duration-300"},f.length>0&&O.createElement(Te,{size:20,strokeWidth:2.5}))),O.createElement("div",{className:"group relative transition-all duration-300"},O.createElement("input",{type:j?"text":"password",value:v,onChange:y=>o(y.target.value),className:"w-full px-5 py-4 rounded-2xl border-2 border-slate-200 bg-white/60 text-slate-700 placeholder:text-slate-300 focus:outline-none focus:ring-0 focus:border-primary-500 focus:bg-white focus:shadow-[0_0_0_4px_rgba(168,85,247,0.15)] transition-all pr-12 tracking-widest",placeholder:"Password"}),O.createElement("button",{type:"button",onClick:S,className:"absolute right-4 top-1/2 transform -translate-y-1/2 text-[#B3A4C8] hover:text-[#8B5CF6] focus:outline-none transition-colors p-1"},j?O.createElement(et,{size:20}):O.createElement(tt,{size:20}))),O.createElement("button",{type:"submit",disabled:h,className:"w-full bg-[#A855F7] hover:bg-purple-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-purple-200 active:scale-[0.98] transition-all duration-200 ease-out text-lg mt-4 tracking-wide disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center"},h?O.createElement("span",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}):"Login"),O.createElement("div",{className:"text-center pt-2"},O.createElement("a",{href:"#",className:"text-purple-500 font-bold text-sm hover:underline hover:text-purple-700 transition-colors"},"Forgot password"))),O.createElement("div",{className:"mt-16 sm:mt-12 text-center"},O.createElement("p",{className:"text-slate-600 font-bold text-sm sm:text-base cursor-pointer hover:text-slate-800 transition-colors"},"Don't have an account? Join us"))))},At=({userProfile:s,myCharacters:f,myUserCharacters:d,myStories:v,onUpdateProfile:o,onCharacterClick:h,onLogout:t})=>{const[r,N]=n.useState(!1),[m,l]=n.useState(s.nickname),[j,c]=n.useState(!1),[S,y]=n.useState(null),[R,U]=n.useState(!1),[x,u]=n.useState(!1),[k,z]=n.useState(void 0),[C,D]=n.useState(void 0),[W,g]=n.useState(s.usedCount??0),I=n.useRef(null),E=w=>{const $=w.split(","),H=$[0].match(/:(.*?);/)?.[1]||"image/jpeg",K=atob($[1]);let Y=K.length;const G=new Uint8Array(Y);for(;Y--;)G[Y]=K.charCodeAt(Y);return new Blob([G],{type:H})},_=()=>{I.current?.click()},J=w=>{const $=w.target.files?.[0];if($){const H=new FileReader;H.onloadend=()=>{y(H.result)},H.readAsDataURL($)}I.current&&(I.current.value="")},q=async()=>{const w=m.trim();if(!w){l(s.nickname),N(!1);return}try{const{authFetch:$}=await Ce(async()=>{const{authFetch:H}=await import("./user-services-BjP0463N.js").then(K=>K.p);return{authFetch:H}},[]);await $("/user/profile",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:w})}),o({...s,nickname:w})}catch{l(s.nickname)}N(!1)};return n.useEffect(()=>{g(s.usedCount??0)},[s.usedCount]),e.jsxs("div",{className:"h-full w-full bg-[#F8F9FB] flex flex-col font-kosugi relative",children:[S&&e.jsx(we,{imageSrc:S,onCancel:()=>y(null),onCrop:async w=>{const $=localStorage.getItem("user_access_token");let H=w;try{if(w&&w.startsWith("data:image")){const K=E(w),Y=new FormData,G=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;Y.append("avatar",K,"avatar.jpg"),Y.append("filename",G),H=`/uploads/users/avatars/${G}`,await fetch("/api/uploads/avatar",{method:"POST",headers:{Authorization:$?`Bearer ${$}`:""},body:Y}).catch(()=>{})}}catch{}try{const{authFetch:K}=await Ce(async()=>{const{authFetch:Y}=await import("./user-services-BjP0463N.js").then(G=>G.p);return{authFetch:Y}},[]);await K("/user/profile",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({avatar:H})})}catch{}o({...s,avatar:H||s.avatar}),y(null)}}),e.jsxs("div",{className:"relative pb-4",children:[e.jsxs("div",{className:"h-40 bg-gradient-to-br from-pink-200 via-purple-200 to-indigo-200 rounded-b-[40px] relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-[-20px] left-[-20px] w-40 h-40 bg-white/20 rounded-full blur-xl"}),e.jsx("div",{className:"absolute bottom-[-10px] right-[-10px] w-32 h-32 bg-purple-400/20 rounded-full blur-xl"})]}),e.jsxs("div",{className:"absolute top-20 left-4 right-4 bg-white rounded-3xl shadow-lg p-4 flex flex-col items-center animate-in slide-in-from-bottom-4 duration-500",children:[e.jsxs("div",{className:"relative -mt-12 mb-2 group cursor-pointer",onClick:_,children:[e.jsx("div",{className:"w-20 h-20 rounded-full border-4 border-white shadow-md overflow-hidden bg-slate-100",children:e.jsx("img",{src:s.avatar||"/uploads/avatars/default_avatar.jpg",alt:"Me",className:"w-full h-full object-cover"})}),e.jsx("div",{className:"absolute bottom-0 right-0 bg-primary-500 p-1.5 rounded-full text-white border-2 border-white shadow-sm",children:e.jsx(Ae,{size:10})}),e.jsx("input",{type:"file",ref:I,className:"hidden",accept:"image/*",onChange:J})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r?e.jsx("input",{value:m,onChange:w=>l(w.target.value),onBlur:q,onKeyDown:w=>w.key==="Enter"&&q(),autoFocus:!0,className:"text-lg font-bold text-center text-slate-800 border-b-2 border-primary-300 outline-none bg-transparent min-w-[100px]"}):e.jsx("h2",{className:"text-lg font-bold text-slate-800",children:s.nickname}),!r&&e.jsx("button",{onClick:()=>N(!0),className:"text-slate-400 hover:text-primary-500",children:e.jsx($e,{size:12})})]}),e.jsx("div",{className:"flex flex-col items-center gap-1 mb-1",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-400 text-[10px] font-bold bg-slate-50 px-3 py-0.5 rounded-full",children:[e.jsx(st,{size:10}),e.jsx("span",{className:"tracking-wide",children:s.email})]})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-4 pb-24 space-y-6 no-scrollbar mt-14",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>u(!0),className:"bg-white rounded-3xl shadow-[0_6px_14px_rgba(0,0,0,0.06)] hover:shadow-[0_8px_18px_rgba(0,0,0,0.08)] active:shadow-[0_12px_28px_rgba(0,0,0,0.12)] active:scale-[0.98] transition-all p-5 flex flex-col items-center justify-center gap-2 border border-transparent",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-purple-50 text-primary-600 flex items-center justify-center",children:e.jsx(oe,{size:22})}),e.jsx("div",{className:"text-slate-800 font-bold text-sm",children:"æˆ‘çš„æ¡£æ¡ˆ"})]}),e.jsxs("div",{className:"bg-white rounded-3xl shadow-[0_6px_14px_rgba(0,0,0,0.06)] hover:shadow-[0_8px_18px_rgba(0,0,0,0.08)] active:shadow-[0_12px_28px_rgba(0,0,0,0.12)] p-5 flex flex-col items-center justify-center gap-2 border border-transparent",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-purple-50 text-primary-600 flex items-center justify-center",children:e.jsx(Ie,{size:22})}),e.jsxs("div",{className:"text-slate-800 font-bold text-sm",children:["èŠå¤©æ¬¡æ•°ï¼š",W]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("div",{className:"w-1 h-4 bg-purple-400 rounded-full"}),e.jsx("h3",{className:"font-bold text-slate-700",children:"æˆ‘çš„è§’è‰²"})]}),(d.length>0?d:f).length>0?e.jsx("div",{className:"flex flex-col gap-3",children:(d.length>0?d:f).map(w=>e.jsxs("div",{onClick:()=>h(w),className:"bgç™½ p-3 rounded-2xl shadow-sm flex items-center gap-4 active:scale-[0.98] transition-all cursor-pointer border border-transparent hover:border-purple-100",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-slate-100 flex-shrink-0 overflow-hidden border border-slate-50",children:e.jsx("img",{src:w.avatar,className:"w-full h-full object-cover",alt:w.name})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h4",{className:"font-bold text-slate-800",children:w.name}),e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded font-bold ${w.isPublic?"bg-green-100 text-green-600":"bg-slate-100 text-slate-400"}`,children:w.isPublic?"å…¬å¼€":"ç§å¯†"})]}),e.jsx("p",{className:"text-xs text-slate-400 truncate mt-1",children:w.oneLinePersona||w.bio})]}),e.jsx(ne,{size:16,className:"text-slate-300"})]},w.id))}):e.jsx("div",{className:"bgç™½ rounded-2xl p-6 text-center shadow-sm border border-slate-50 border-dashed",children:e.jsx("p",{className:"text-xs text-slate-400",children:"è¿˜æ²¡æœ‰åˆ›å»ºè¿‡è§’è‰²"})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 px-1",children:[e.jsx("div",{className:"w-1 h-4 bg-pink-400 rounded-full"}),e.jsx("h3",{className:"font-bold text-slate-700",children:"æˆ‘çš„æ•…äº‹"})]}),e.jsx("div",{className:"bg-white rounded-2xl p-6 text-center shadow-sm border border-slate-50 border-dashed flex flex-col items-center gap-2",children:e.jsx("p",{className:"text-xs text-slate-400",children:"è¿˜æ²¡æœ‰ç©¿è¶Šè¿‡æ•…äº‹"})})]}),e.jsx("div",{className:"bg-white rounded-3xl shadow-sm p-2",children:e.jsxs("button",{onClick:()=>c(!0),className:"w-full flex items-center justify-center gap-3 p-2 hover:bg-red-50 rounded-2xl transition-colors group",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center group-hover:bg-red-100 group-hover:text-red-500 transition-colors",children:e.jsx(Ne,{size:16})}),e.jsx("span",{className:"text-center font-bold text-slate-700 text-sm group-hover:text-red-500",children:"é€€å‡ºç™»å½•"})]})})]}),j&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-[32px] p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-50 text-red-400 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Ne,{size:28})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2",children:"ä½ ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ"}),e.jsx("p",{className:"text-xs text-slate-400 mb-6 px-4 leading-relaxed"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>c(!1),className:"flex-1 py-3 rounded-2xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors text-sm",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:t,className:"flex-1 py-3 rounded-2xl bg-red-500 text-white font-bold shadow-lg shadow-red-200 hover:bg-red-600 transition-colors text-sm",children:"ç¡®è®¤é€€å‡º"})]})]})}),R&&e.jsx(Me,{currentPersona:k,roleId:C,onBack:()=>U(!1),onSave:w=>{z(w),U(!1)},withinContainer:!0}),e.jsx(Le,{isOpen:x,currentPersona:k,onClose:()=>u(!1),onAdd:()=>{u(!1),D(void 0),z(void 0),U(!0)},onSelect:(w,$)=>{z(w),D($),u(!1),U(!0)}})]})};export{ft as B,Re as C,$t as L,he as M,te as N,Tt as T,Me as U,Ce as _,Et as a,_t as b,It as c,zt as d,kt as e,St as f,Ct as g,At as h};
