import{r as o,j as e,R as B}from"./index-DiMvcmcb.js";import{b as Z,c as H,f as P,T as K,u as q}from"./AdminDashboard-D62DCIkd.js";import{C as F}from"./chevron-left-B3HkbiML.js";import{X as D}from"./x-CKT7hpuC.js";import{C as G,R as J,Z as Q,a as ee,A as te}from"./zoom-out-1jEnNmIA.js";import{S as se}from"./save-DC2LZN-i.js";import{P as ae}from"./plus-Bz3dnY0B.js";import{P as ne}from"./pen-line-BpKLzpbM.js";import{S as le}from"./send-BX7jbBow.js";import"./createLucideIcon-CiU7U1is.js";const re=l=>new Promise(x=>{const c=new FileReader;c.addEventListener("load",()=>x(c.result),!1),c.readAsDataURL(l)}),oe=l=>new Promise((x,c)=>{const s=new Image;s.addEventListener("load",()=>x(s)),s.addEventListener("error",a=>c(a)),s.setAttribute("crossOrigin","anonymous"),s.src=l});function ie({initialImage:l,onSave:x,onCancel:c}){const[s,a]=o.useState(l?"edit":"upload"),[v,f]=o.useState(l||null),b=async h=>{if(h.target.files&&h.target.files.length>0){const u=h.target.files[0],p=await re(u);f(p),a("edit")}};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200",children:e.jsxs("div",{className:"relative w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-200",children:[e.jsx(ce,{step:s,onBack:()=>a("upload"),onClose:c}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[s==="upload"&&e.jsx(de,{onFileChange:b}),s==="edit"&&v&&e.jsx(xe,{imageSrc:v,onSave:x,onCancel:()=>a("upload")})]})]})})}function ce({step:l,onBack:x,onClose:c}){const s=l==="upload"?"上传封面":"裁剪封面";return e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[l==="edit"&&e.jsx("button",{onClick:x,className:"p-2 -ml-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-pink-600 transition-colors",children:e.jsx(F,{size:20})}),e.jsx("h2",{className:"text-lg font-cute text-pink-900",children:s})]}),e.jsx("button",{onClick:c,className:"p-2 -mr-2 rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors",children:e.jsx(D,{size:20})})]})}function de({onFileChange:l}){const[x,c]=o.useState(!1),s=o.useRef(null);return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 p-8 flex flex-col items-center justify-center",children:e.jsxs("div",{onDragOver:a=>{a.preventDefault(),c(!0)},onDragLeave:a=>{a.preventDefault(),c(!1)},onDrop:a=>{a.preventDefault(),c(!1),a.dataTransfer.files&&a.dataTransfer.files.length>0&&l({target:{files:a.dataTransfer.files}})},onClick:()=>s.current.click(),className:`w-full max-w-xl aspect-[2/1] rounded-3xl flex flex-col items-center justify-center transition-all duration-300 cursor-pointer border-2 border-dashed ${x?"bg-pink-50 border-pink-400 scale-105":"bg-gray-50 border-gray-200 hover:border-pink-300 hover:bg-pink-50/30"}`,children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-white shadow-sm flex items-center justify-center mb-4 text-pink-500",children:e.jsx(G,{size:32})}),e.jsx("p",{className:"text-gray-600 font-bold mb-1",children:"点击或拖拽上传封面"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"输出尺寸 800×400，比例 2:1"})]})}),e.jsx("input",{type:"file",ref:s,onChange:l,className:"hidden",accept:"image/*"})]})}function xe({imageSrc:l,onSave:x,onCancel:c}){const s=o.useRef(null),[a,v]=o.useState(null),[f,b]=o.useState(!1),[h,u]=o.useState(0),[p,I]=o.useState({x:0,y:0}),[R,E]=o.useState(!1),[r,j]=o.useState({x:0,y:0}),[M,A]=o.useState(1),[T,t]=o.useState(1),n=800,y=800,m=400;o.useEffect(()=>{(async()=>{try{const i=await oe(l);v(i);const g=n/i.width,k=n/i.height,w=Math.max(g,k);A(w),t(1)}catch{}})()},[l]);const O=d=>{d.preventDefault();const i=d.deltaY*-.001;t(g=>Math.max(.5,Math.min(g+i,3)))},_=o.useCallback(()=>{if(!a||!s.current)return;const i=s.current.getContext("2d");i.clearRect(0,0,n,n),i.fillStyle="#18181b",i.fillRect(0,0,n,n),i.save(),i.translate(n/2,n/2),i.rotate(h*Math.PI/180),i.translate(-n/2,-n/2);const g=h*Math.PI/180,k=p.x*Math.cos(-g)-p.y*Math.sin(-g),w=p.x*Math.sin(-g)+p.y*Math.cos(-g),N=M*T,C=a.width*N,S=a.height*N,z=n/2,W=n/2;i.drawImage(a,z-C/2+k,W-S/2+w,C,S),i.restore();const $=(n-m)/2;i.fillStyle="rgba(0, 0, 0, 0.6)",i.beginPath(),i.rect(0,0,n,n),i.rect(0,$,y,m),i.fill("evenodd")},[a,h,p,M,T]);o.useEffect(()=>{_()},[_]);const X=d=>{var w,N,C,S;E(!0);const i=s.current.getBoundingClientRect(),g=d.clientX||((N=(w=d.touches)==null?void 0:w[0])==null?void 0:N.clientX),k=d.clientY||((S=(C=d.touches)==null?void 0:C[0])==null?void 0:S.clientY);j({x:g-i.left,y:k-i.top})},Y=d=>{if(!R)return;const i=s.current.getBoundingClientRect(),g=d.clientX||(d.touches?d.touches[0].clientX:0),k=d.clientY||(d.touches?d.touches[0].clientY:0),w=g-i.left,N=k-i.top,C=w-r.x,S=N-r.y;I(z=>({x:z.x+C,y:z.y+S})),j({x:w,y:N})},L=()=>E(!1),U=()=>u(d=>(d+90)%360),V=async()=>{if(!(!s.current||f)){b(!0);try{const d=document.createElement("canvas");d.width=y,d.height=m;const i=d.getContext("2d"),g=(n-m)/2;i.drawImage(s.current,0,g,y,m,0,0,y,m);const k=await new Promise((C,S)=>{d.toBlob(z=>z?C(z):S(new Error("blob_failed")),"image/jpeg",.92)}),w=new File([k],`cover_${Date.now()}.jpg`,{type:"image/jpeg"}),N=await Z.cover(w);x(N.url)}catch{}finally{b(!1)}}};return e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsx("div",{className:"flex-1 relative flex items-center justify-center bg-gray-900 overflow-hidden",children:e.jsx("canvas",{ref:s,width:n,height:n,onMouseDown:X,onMouseMove:Y,onMouseUp:L,onMouseLeave:L,onTouchStart:X,onTouchMove:Y,onTouchEnd:L,onWheel:O,className:"cursor-move max-w-full max-h-full",style:{width:"100%",height:"auto",maxHeight:"520px"}})}),e.jsxs("div",{className:"p-4 bg-white flex items-center justify-between border-t border-gray-100 gap-4",children:[e.jsx("button",{onClick:U,className:"px-2 py-2 rounded-xl text-pink-600 hover:text-pink-700 text-xs font-bold hover:bg-pink-50",children:e.jsx(J,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 max-w-[240px]",children:[e.jsx(Q,{size:16,className:"text-gray-400"}),e.jsx("input",{type:"range",min:"0.5",max:"3",step:"0.1",value:T,onChange:d=>t(parseFloat(d.target.value)),className:"w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-500"}),e.jsx(ee,{size:16,className:"text-gray-400"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:c,className:"px-4 py-2 rounded-xl text-gray-500 font-bold text-sm hover:bg-gray-100",children:"取消"}),e.jsx("button",{onClick:V,disabled:f,className:`px-5 py-2 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 ${f?"opacity-60 cursor-not-allowed":"hover:opacity-90"}`,children:f?"上传中...":"完成"})]})]})]})}const ue=({initialData:l,onCancel:x,notify:c})=>{const[s,a]=o.useState({title:"",description:"",image:"",tags:[],author:"",likes:"",content:"",publishDate:""}),[v,f]=o.useState([]),[b,h]=o.useState([]),[u,p]=o.useState(!1),I=B.useRef(null);o.useEffect(()=>{l&&(a({title:l.title||"",description:l.description||"",image:l.image||"",tags:Array.isArray(l.tags)?l.tags:[],author:l.author||"",likes:l.likes||"",content:l.content||"",publishDate:l.publish_date||""}),Array.isArray(l.character_ids)&&f(l.character_ids.map(t=>Number(t))))},[l]),o.useEffect(()=>{(async()=>{try{const t=await H.list({creator_role:"admin_role"}),y=(Array.isArray(t==null?void 0:t.items)?t.items:[]).filter(m=>m.status==="published");h(y.map(m=>({id:Number(m.id),name:m.name})))}catch{}})()},[]),o.useEffect(()=>{const t=n=>{u&&I.current&&!I.current.contains(n.target)&&p(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[u]);const[R,E]=o.useState(""),[r,j]=o.useState(!1),M=()=>{const t=R.trim();t&&(a(n=>({...n,tags:n.tags.includes(t)?n.tags:[...n.tags,t]})),E(""))},A=t=>a(n=>({...n,tags:n.tags.filter(y=>y!==t)})),T=async()=>{if(!s.title.trim()||!s.content.trim()){c&&c("请输入标题与内容","error");return}const t={title:s.title.trim(),description:s.description||null,image:s.image||null,author:s.author||null,likes:s.likes||null,content:s.content,tags:s.tags,character_ids:v};try{l!=null&&l.id?(await P.update(l.id,t),c&&c("保存成功：故事已更新")):(await P.create(t),c&&c("保存成功：故事已创建")),x&&x()}catch{c&&c("保存失败","error")}};return e.jsxs("div",{className:"animate-fade-in pb-20",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:x,className:"w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-500 hover:text-pink-600 transition-colors",children:e.jsx(F,{size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-cute text-pink-900",children:l?"编辑故事":"创建故事"}),e.jsx("p",{className:"text-gray-400 text-xs",children:"填写并保存故事内容"})]}),e.jsx("div",{className:"ml-auto",children:e.jsxs("button",{onClick:T,className:"px-6 py-2.5 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white font-bold text-sm shadow-lg shadow-pink-200 flex items-center gap-2",children:[e.jsx(se,{size:16})," 保存"]})})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:e.jsxs("div",{className:"solid-card p-8 rounded-3xl space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"标题"}),e.jsx("input",{value:s.title,onChange:t=>a({...s,title:t.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"描述"}),e.jsx("textarea",{value:s.description,onChange:t=>a({...s,description:t.target.value}),rows:"3",className:"dream-input w-full px-4 py-3 rounded-xl text-sm resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"封面图片"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{onClick:()=>j(!0),className:"w-full aspect-[2/1] bg-gray-100 rounded-2xl overflow-hidden border-4 border-white shadow-xl cursor-pointer",children:s.image?e.jsx("img",{src:s.image,alt:"cover",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-300 font-bold",children:"点击上传并裁剪 (800×400)"})}),e.jsx("input",{value:s.image,onChange:t=>a({...s,image:t.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm",placeholder:"或直接粘贴图片 URL"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"作者"}),e.jsx("input",{value:s.author,onChange:t=>a({...s,author:t.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"点赞数（文本）"}),e.jsx("input",{value:s.likes,onChange:t=>a({...s,likes:t.target.value}),className:"dream-input w-full px-4 py-3 rounded-xl text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"标签"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:R,onChange:t=>E(t.target.value),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),M())},className:"dream-input flex-1 px-4 py-3 rounded-xl text-sm",placeholder:"输入标签并回车"}),e.jsx("button",{onClick:M,className:"px-4 rounded-xl bg-pink-500 text-white text-sm font-bold",children:"添加"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.tags.map(t=>e.jsxs("button",{onClick:()=>A(t),className:"bg-pink-50 text-pink-600 px-3 py-1.5 rounded-xl text-xs font-bold border border-pink-100",children:["#",t," ×"]},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-pink-800 mb-2",children:"正文"}),e.jsx("textarea",{value:s.content,onChange:t=>a({...s,content:t.target.value}),rows:"14",className:"dream-input w-full px-5 py-4 rounded-xl text-sm leading-relaxed font-mono text-gray-700 bg-white focus:bg-white resize-y shadow-inner"})]})]})}),e.jsxs("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:[e.jsx("div",{className:"glass-card p-6 rounded-3xl text-sm text-gray-500",children:"在右侧填写故事信息并点击保存。"}),e.jsxs("div",{className:"solid-card p-6 rounded-3xl space-y-4",children:[e.jsx("div",{className:"text-xs font-bold text-pink-800",children:"登场角色（管理员且已发布）"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative w-full max-w-md",ref:I,children:[e.jsxs("button",{onClick:()=>p(!u),className:`dream-input w-full px-4 py-3 rounded-xl text-sm text-left font-bold transition-all bg-white flex justify-between items-center ${u?"border-pink-500 ring-4 ring-pink-100/50":""}`,children:[e.jsx("span",{className:"text-gray-700",children:"选择角色"}),e.jsx("div",{className:`text-pink-400 transition-transform ${u?"rotate-180":""}`,children:"▼"})]}),u&&e.jsx("ul",{className:"absolute top-full mt-1 w-full bg-white border border-pink-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50",children:b.filter(t=>!v.includes(t.id)).length===0?e.jsx("li",{className:"px-4 py-3 text-sm text-gray-400",children:"暂无可选角色"}):b.filter(t=>!v.includes(t.id)).map(t=>e.jsx("li",{onClick:()=>{f(n=>n.includes(t.id)?n:[...n,t.id]),p(!1)},className:"px-4 py-3 text-sm text-gray-700 hover:bg-pink-50 cursor-pointer transition-colors",children:t.name},t.id))})]}),e.jsx("button",{className:"px-3 py-2 bg-pink-500 text-white rounded-xl text-xs font-bold",onClick:()=>p(!0),children:"添加"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.map(t=>{var y;const n=((y=b.find(m=>m.id===t))==null?void 0:y.name)||t;return e.jsxs("span",{className:"bg-pink-50 text-pink-600 px-3 py-1.5 rounded-xl text-xs font-bold border border-pink-100",children:[n,e.jsx("button",{className:"ml-2 text-pink-500",onClick:()=>f(m=>m.filter(O=>O!==t)),children:"×"})]},t)})})]})]})]}),r&&e.jsx(ie,{initialImage:s.image||null,onSave:async t=>{a(n=>({...n,image:t})),j(!1)},onCancel:()=>j(!1)})]})},me=()=>{const[l,x]=o.useState("list"),[c,s]=o.useState(null),{showToast:a}=q(),[v,f]=o.useState([]),[b,h]=o.useState(null),u=async()=>{try{const r=await P.list();f(r.items||[])}catch{a("加载失败","error")}};o.useEffect(()=>{u()},[]);const p=()=>{s(null),x("create")},I=r=>{s(r),x("create")},R=async r=>{try{await P.remove(r),a("删除成功"),u()}catch{a("删除失败","error")}},E=async(r,j)=>{try{await P.setStatus(r,j==="published"?"draft":"published"),a(j==="published"?"已回收为草稿":"已发布"),u()}catch{a("操作失败","error")}};return l==="create"?e.jsx(ue,{initialData:c,onCancel:()=>{x("list"),u()},notify:a}):e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-cute text-pink-900 flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-6 bg-yellow-400 rounded-full inline-block"})," 故事管理"]}),e.jsx("p",{className:"text-gray-400 text-xs mt-1 ml-4",children:"查看与编辑故事内容"})]}),e.jsxs("button",{onClick:p,className:"bg-gradient-to-r from-pink-500 to-pink-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-pink-200 hover:opacity-90 transition-all flex items-center gap-2 text-sm",children:[e.jsx(ae,{size:16})," 创建故事"]})]}),e.jsx("div",{className:"grid gap-6",style:{gridTemplateColumns:"repeat(auto-fit, minmax(320px, 360px))"},children:v.map(r=>e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"glass-card p-4 rounded-3xl hover:shadow-xl transition-all group relative overflow-hidden h-[220px] flex flex-col",children:[e.jsx("div",{className:`absolute top-4 right-4 text-xs px-2 py-0.5 rounded-md font-bold ${r.status==="published"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-500"}`,children:r.status==="published"?"已发布":"草稿"}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-pink-200 to-pink-300 flex items-center justify-center text-white text-xl font-bold shadow-inner border-2 border-white overflow-hidden flex-shrink-0",children:r.image?e.jsx("img",{src:r.image,alt:"cover",className:"w-full h-full object-cover"}):e.jsx("span",{children:r.title?r.title[0]:"?"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800 truncate",children:r.title}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:r.author||""})]}),e.jsx("div",{className:"flex gap-1 mt-2 flex-nowrap whitespace-nowrap overflow-hidden",style:{maxWidth:300},children:(r.tags||[]).map(j=>e.jsxs("span",{className:"text-[10px] bg-pink-50 text-pink-600 px-1.5 py-0.5 rounded border border-pink-100",children:["#",j]},j))})]})]}),e.jsx("div",{className:"mt-3",children:e.jsx("p",{className:"text-gray-600 text-sm leading-relaxed break-words",children:r.description||"暂无描述"})}),e.jsxs("div",{className:"mt-auto flex gap-2 pt-3 border-t border-white/50",children:[e.jsxs("button",{onClick:()=>I(r),className:"flex-1 py-2 text-xs font-bold text-pink-600 bg-pink-50 hover:bg-pink-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(ne,{size:12})," 编辑"]}),r.status==="published"?e.jsxs("button",{onClick:()=>E(r.id,r.status),className:"flex-1 py-2 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(te,{size:12})," 回收"]}):e.jsxs("button",{onClick:()=>E(r.id,r.status),className:"flex-1 py-2 text-xs font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors flex items-center justify-center gap-1 mx-1",children:[e.jsx(le,{size:12})," 发布"]})]})]}),e.jsx("button",{onClick:()=>h(r),className:"absolute -top-2 -right-2 z-10 w-8 h-8 rounded-full bg-white/60 backdrop-blur-md shadow-lg border border-pink-100 flex items-center justify-center text-gray-400 hover:text-red-500 transition",children:e.jsx(D,{size:12})})]},r.id))}),b&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 bg-black/30 z-50",onClick:()=>h(null)}),e.jsx("div",{className:"fixed top-0 right-0 bottom-0 left-64 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-pink-50 p-6 w-full max-w-md shadow-2xl",children:[e.jsx("h3",{className:"font-cute text-lg text-pink-900 mb-2",children:"删除故事"}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["确定删除“",b.title,"”吗？此操作不可撤回。"]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>h(null),className:"px-5 py-2 rounded-xl bg-white border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50",children:"取消"}),e.jsx("button",{onClick:()=>{R(b.id),h(null)},className:"px-5 py-2 rounded-xl bg-red-500 text-white font-bold text-sm shadow-sm hover:bg-red-600",children:"确认删除"})]})]})})]})]})},ke=()=>e.jsx(K,{children:e.jsx(me,{})});export{ke as default};
//# sourceMappingURL=StoryManagement-Ccn5Fdwd.js.map
