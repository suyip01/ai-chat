{"version":3,"mappings":"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","names":["CreateStory","onBack","onPublish","onSaveDraft","availableCharacters","myUserCharacters","initialStory","importableRoles","showCenter","useToast","form","setForm","useState","showTagModal","setShowTagModal","showRoleModal","setShowRoleModal","showErrorModal","setShowErrorModal","errors","setErrors","customTagInput","setCustomTagInput","tempImage","setTempImage","showRoleTips","setShowRoleTips","roleTipsRef","useRef","localImportableRoles","setLocalImportableRoles","combineRequestedRef","useEffect","authFetch","__vitePreload","res","data","items","it","React","c","prefilledRef","ids","idSet","x","matched","prev","roles","timer","onDocClick","e","el","target","fileInputRef","dataUrlToBlob","dataUrl","parts","mime","_a","bstr","n","u8","availableTags","handleImageClick","handleFileChange","file","reader","toggleTag","tag","t","addCustomTag","val","handleAddRole","character","r","newRole","removeRole","roleName","resolveCharacterIds","names","m","submitting","setSubmitting","saveToServer","status","imageUrl","token","blob","fd","fname","up","j","payload","isEdit","url","idOut","newStory","updateDraft","validate","handlePublish","handleSaveDraft","labelClass","jsxs","jsx","ImageCropper","croppedImage","ChevronLeft","Camera","Plus","X","ChevronRight","AlertCircle","Fragment","role","Trash2","Send","ChevronDown","item","a","b"],"ignoreList":[],"sources":["../../user/components/CreateStory.tsx"],"sourcesContent":["\nimport React, { useState, useRef, useEffect } from 'react';\nimport { ChevronLeft, Camera, Plus, ChevronRight, X, ChevronDown, Save, Send, Trash2, AlertCircle } from 'lucide-react';\nimport { Story, Character, StoryRole } from '../types';\nimport { ImageCropper } from './ImageCropper';\nimport { useToast } from './Toast';\n\ninterface CreateStoryProps {\n  onBack: () => void;\n  onPublish: (story: Story) => void;\n  onSaveDraft: (story: Story) => void;\n  availableCharacters: Character[]; // Pool of characters to import\n  myUserCharacters?: Character[];\n  initialStory?: Story | null;\n  importableRoles?: Array<{ id: string; name: string; avatar: string; desc: string; isPrivate: boolean; isMine: boolean }>;\n}\n\nexport const CreateStory: React.FC<CreateStoryProps> = ({\n  onBack,\n  onPublish,\n  onSaveDraft,\n  availableCharacters,\n  myUserCharacters = [],\n  initialStory,\n  importableRoles = []\n}) => {\n  const { showCenter } = useToast();\n  const [form, setForm] = useState<{\n    title: string;\n    description: string;\n    image: string;\n    content: string;\n    tags: string[];\n    roles: StoryRole[];\n  }>(() => {\n    if (initialStory) {\n      return {\n        title: initialStory.title,\n        description: initialStory.description,\n        image: initialStory.image,\n        content: initialStory.content,\n        tags: initialStory.tags,\n        roles: initialStory.availableRoles || []\n      };\n    }\n    return {\n      title: '',\n      description: '',\n      image: '',\n      content: '',\n      tags: [],\n      roles: []\n    };\n  });\n\n  // UI States\n  const [showTagModal, setShowTagModal] = useState(false);\n  const [showRoleModal, setShowRoleModal] = useState(false);\n  const [showErrorModal, setShowErrorModal] = useState(false);\n  const [errors, setErrors] = useState<Record<string, boolean>>({});\n  const [customTagInput, setCustomTagInput] = useState('');\n  const [tempImage, setTempImage] = useState<string | null>(null);\n  const [showRoleTips, setShowRoleTips] = useState(false);\n  const roleTipsRef = useRef<HTMLDivElement | null>(null);\n  const [localImportableRoles, setLocalImportableRoles] = useState(importableRoles);\n  const combineRequestedRef = useRef(false)\n  useEffect(() => {\n    setLocalImportableRoles(importableRoles || []);\n  }, [importableRoles]);\n  useEffect(() => {\n    if (combineRequestedRef.current) return\n    if (localImportableRoles && localImportableRoles.length) return\n    combineRequestedRef.current = true\n    ;(async () => {\n      try {\n        const { authFetch } = await import('../services/http')\n        const res = await authFetch('/stories/combine')\n        if (res && res.ok) {\n          const data = await res.json()\n          const items = Array.isArray(data?.items) ? data.items : []\n          setLocalImportableRoles(items.map((it: any) => ({ id: String(it.character_id), name: it.character_name, avatar: it.character_avatar || '', desc: it.desc || '', isPrivate: !!it.isPrivate, isMine: !!it.isMine })))\n        }\n      } catch { }\n    })()\n  }, [])\n  const myRoles = React.useMemo(() => {\n    const src = Array.isArray(myUserCharacters) ? myUserCharacters : []\n    return src\n      .filter(c => (c as any).isPublished === true && (c as any).isPublic === false)\n      .map(c => ({ id: String(c.id), name: c.name, avatar: c.avatar, desc: c.oneLinePersona || c.bio || '', isPrivate: true, isMine: true }))\n  }, [myUserCharacters])\n  \n  const prefilledRef = useRef(false)\n  useEffect(() => {\n    if (prefilledRef.current) return\n    const ids: Array<string|number> = Array.isArray((initialStory as any)?.characterIds) ? (initialStory as any).characterIds : []\n    if (!ids.length) return\n    if (!localImportableRoles || !localImportableRoles.length) return\n    const idSet = new Set(ids.map(x => String(x)))\n    const matched = localImportableRoles\n      .filter(r => idSet.has(String(r.id)))\n      .map(r => ({ name: r.name, avatar: r.avatar, description: r.desc || '暂无描述' }))\n    if (matched.length) {\n      prefilledRef.current = true\n      setForm(prev => ({ ...prev, roles: matched }))\n    }\n  }, [initialStory, localImportableRoles])\n\n  useEffect(() => {\n    if (!initialStory) return\n    const roles = (initialStory.availableRoles || []) as StoryRole[]\n    if (roles.length) {\n      setForm(prev => ({ ...prev, roles }))\n      prefilledRef.current = true\n    }\n  }, [initialStory])\n\n  useEffect(() => {\n    if (!initialStory) return\n    setForm(prev => ({\n      ...prev,\n      title: initialStory.title || prev.title,\n      description: initialStory.description || prev.description,\n      image: initialStory.image || prev.image,\n      content: initialStory.content || prev.content,\n      tags: Array.isArray(initialStory.tags) ? initialStory.tags : prev.tags\n    }))\n  }, [initialStory])\n\n  useEffect(() => {\n    if (!showRoleTips) return\n    const timer = setTimeout(() => setShowRoleTips(false), 6000)\n    return () => clearTimeout(timer)\n  }, [showRoleTips])\n\n  useEffect(() => {\n    if (!showRoleTips) return\n    const onDocClick = (e: MouseEvent) => {\n      const el = roleTipsRef.current\n      if (!el) { setShowRoleTips(false); return }\n      const target = e.target as Node\n      if (!el.contains(target)) setShowRoleTips(false)\n    }\n    window.addEventListener('click', onDocClick, true)\n    return () => window.removeEventListener('click', onDocClick, true)\n  }, [showRoleTips])\n\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const dataUrlToBlob = (dataUrl: string) => {\n    const parts = dataUrl.split(',');\n    const mime = parts[0].match(/:(.*?);/)?.[1] || 'image/jpeg';\n    const bstr = atob(parts[1]);\n    let n = bstr.length;\n    const u8 = new Uint8Array(n);\n    while (n--) u8[n] = bstr.charCodeAt(n);\n    return new Blob([u8], { type: mime });\n  };\n\n  const availableTags = [\n    'BG', 'BL', 'GL', '暗恋', '校园',\n    '职场', '悬疑', '科幻', '古风', '穿越',\n    '重生', '甜宠', '虐恋', 'HE', 'BE',\n    '爽文', '娱乐圈', '青梅竹马', '强强', '同人'\n  ];\n\n  const handleImageClick = () => {\n    fileInputRef.current?.click();\n  };\n\n\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setTempImage(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n    if (fileInputRef.current) fileInputRef.current.value = '';\n  };\n\n  const toggleTag = (tag: string) => {\n    if (form.tags.includes(tag)) {\n      setForm(prev => ({ ...prev, tags: prev.tags.filter(t => t !== tag) }));\n    } else {\n      setForm(prev => ({ ...prev, tags: [...prev.tags, tag] }));\n    }\n  };\n\n  const addCustomTag = () => {\n    const val = customTagInput.trim();\n    if (val && !form.tags.includes(val)) {\n      setForm(prev => ({ ...prev, tags: [...prev.tags, val] }));\n      setCustomTagInput('');\n    }\n  };\n\n  const handleAddRole = (character: Character) => {\n    // Prevent duplicates\n    if (form.roles.some(r => r.name === character.name)) return;\n\n    const newRole: StoryRole = {\n      name: character.name,\n      avatar: character.avatar,\n      description: character.oneLinePersona || character.bio || '暂无描述'\n    };\n\n    setForm(prev => ({ ...prev, roles: [...prev.roles, newRole] }));\n    setShowRoleModal(false);\n  };\n\n  const removeRole = (roleName: string) => {\n    setForm(prev => ({ ...prev, roles: prev.roles.filter(r => r.name !== roleName) }));\n  };\n\n  const createStoryObject = (status: 'published' | 'draft'): Story => {\n    return {\n      id: initialStory ? initialStory.id : Date.now(),\n      title: form.title || '未命名故事',\n      description: form.description || '暂无简介',\n      image: form.image || 'https://image.pollinations.ai/prompt/abstract%20book%20cover%20pastel?width=600&height=300&nologo=true',\n      content: form.content,\n      tags: form.tags,\n      author: '我',\n      likes: '0',\n      availableRoles: form.roles,\n      status: status,\n      isUserCreated: true,\n      publishDate: new Date().toISOString()\n    };\n  };\n\n  const resolveCharacterIds = (): Array<number | string> => {\n    const names = form.roles.map(r => r.name)\n    const m: Record<string, string | number> = {}\n    importableRoles.forEach(r => { m[r.name] = r.id })\n    return names.map(n => m[n]).filter(Boolean) as Array<number | string>\n  }\n\n  const [submitting, setSubmitting] = useState<'none' | 'publish' | 'draft'>('none')\n\n  const saveToServer = async (status: 'published' | 'draft') => {\n    try {\n      setSubmitting(status === 'published' ? 'publish' : 'draft')\n      let imageUrl = form.image || ''\n      try {\n        const token = localStorage.getItem('user_access_token')\n        if (form.image && form.image.startsWith('data:image')) {\n          const blob = dataUrlToBlob(form.image)\n          const fd = new FormData()\n          const fname = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}.jpg`\n          imageUrl = `/uploads/covers/${fname}`\n          fd.append('cover', blob, 'cover.jpg')\n          fd.append('filename', fname)\n          const up = await fetch('/api/uploads/cover', { method: 'POST', headers: { Authorization: token ? `Bearer ${token}` : '' }, body: fd })\n          if (up && up.ok) {\n            const j = await up.json()\n            if (j && j.url) imageUrl = j.url\n          }\n        }\n      } catch { }\n      const payload = {\n        title: form.title,\n        description: form.description,\n        image: imageUrl,\n        status,\n        content: form.content,\n        tags: form.tags,\n        characterIds: resolveCharacterIds()\n      }\n      const { authFetch } = await import('../services/http')\n      const isEdit = !!initialStory\n      const url = isEdit ? `/user/stories/${initialStory?.id}` : '/user/stories'\n      const method = isEdit ? 'PUT' : 'POST'\n      const res = await authFetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })\n      if (res && res.ok) {\n        let idOut: number | string | undefined\n        try { const data = await res.json(); idOut = data?.id } catch { idOut = initialStory?.id }\n        const newStory: Story = {\n          id: typeof idOut === 'number' ? idOut : (initialStory ? initialStory.id : Date.now()),\n          title: form.title,\n          description: form.description,\n          image: imageUrl || form.image,\n          content: form.content,\n          tags: form.tags,\n          author: localStorage.getItem('user_nickname') || '我',\n          likes: '0',\n          availableRoles: form.roles,\n          status\n        }\n        if (status === 'published') onPublish(newStory)\n        else onSaveDraft(newStory)\n        return\n      }\n      showCenter('保存失败，请重试。', 'error')\n    } catch {\n      showCenter('保存失败，请重试。', 'error')\n    } finally {\n      setSubmitting('none')\n    }\n  }\n\n  const updateDraft = async () => {\n    try {\n      setSubmitting('draft')\n      let imageUrl = form.image || ''\n      try {\n        const token = localStorage.getItem('user_access_token')\n        if (form.image && form.image.startsWith('data:image')) {\n          const blob = dataUrlToBlob(form.image)\n          const fd = new FormData()\n          const fname = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}.jpg`\n          imageUrl = `/uploads/covers/${fname}`\n          fd.append('cover', blob, 'cover.jpg')\n          fd.append('filename', fname)\n          const up = await fetch('/api/uploads/cover', { method: 'POST', headers: { Authorization: token ? `Bearer ${token}` : '' }, body: fd })\n          if (up && up.ok) {\n            const j = await up.json()\n            if (j && j.url) imageUrl = j.url\n          }\n        }\n      } catch { }\n      const payload = {\n        title: form.title,\n        description: form.description,\n        image: imageUrl,\n        content: form.content,\n        tags: form.tags,\n        characterIds: resolveCharacterIds()\n      }\n      const { authFetch } = await import('../services/http')\n      const res = await authFetch(`/user/stories/${initialStory?.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })\n      if (res && res.ok) {\n        const newStory: Story = {\n          id: typeof (initialStory?.id) === 'number' ? (initialStory as Story).id : Date.now(),\n          title: form.title,\n          description: form.description,\n          image: imageUrl || form.image,\n          content: form.content,\n          tags: form.tags,\n          author: localStorage.getItem('user_nickname') || '我',\n          likes: '0',\n          availableRoles: form.roles,\n          status: initialStory?.status\n        }\n        onSaveDraft(newStory)\n        return\n      }\n      showCenter('保存失败，请重试。', 'error')\n    } catch {\n      showCenter('保存失败，请重试。', 'error')\n    } finally {\n      setSubmitting('none')\n    }\n  }\n\n  const validate = () => {\n    const e: Record<string, boolean> = {}\n    if (!form.title.trim()) e.title = true\n    if (!form.content.trim()) e.content = true\n    setErrors(e)\n    return Object.keys(e).length === 0\n  }\n\n  const handlePublish = () => {\n    if (!validate()) { setShowErrorModal(true); return }\n    saveToServer('published')\n  };\n\n  const handleSaveDraft = () => {\n    if (initialStory) { updateDraft(); return; }\n    saveToServer('draft')\n  };\n\n  const labelClass = \"field-label font-kosugi mb-3 text-slate-700 font-bold text-sm block\";\n\n  return (\n    <div className=\"fixed inset-0 bg-white z-[60]\">\n      <div className=\"mx-auto w-full max-w-md h-full relative flex flex-col overflow-hidden rounded-none md:rounded-3xl shadow-2xl bg白 font-kosugi\">\n\n        {/* Cropper */}\n        {tempImage && (\n          <ImageCropper\n            imageSrc={tempImage}\n            aspectRatio={2}\n            outputWidth={800}\n            outputHeight={400}\n            onCancel={() => {\n              setTempImage(null);\n              if (fileInputRef.current) fileInputRef.current.value = '';\n            }}\n            onCrop={(croppedImage) => {\n              setForm(prev => ({ ...prev, image: croppedImage }));\n              setTempImage(null);\n            }}\n          />\n        )}\n\n        {/* Background */}\n        <div className=\"ambient-bg hidden\"></div>\n\n        {/* Header */}\n        <div className=\"sticky top-0 z-50 bg-white px-4 py-3 flex items-center border-b border-slate-100 rounded-t-none md:rounded-t-3xl relative\">\n          {initialStory && (\n            <button onClick={handleSaveDraft} disabled={submitting !== 'none'} className={`absolute right-4 text-sm font-bold font-kosugi ${submitting !== 'none' ? 'text-slate-400 cursor-not-allowed' : 'text-purple-600'}`}>更新草稿</button>\n          )}\n          <button onClick={onBack} className=\"w-8 h-8 flex items-center justify-center text-purple-800 hover:bg-purple-100 rounded-full transition\">\n            <ChevronLeft size={20} />\n          </button>\n          <h1 className=\"absolute left-1/2 -translate-x-1/2 text-xl font-bold text-purple-900 font-kosugi\">\n            {initialStory ? '编辑故事' : '创作故事'}\n          </h1>\n          {!initialStory && (\n            <button onClick={handleSaveDraft} disabled={submitting !== 'none'} className={`ml-auto text-sm font-bold font-kosugi ${submitting !== 'none' ? 'text-slate-400 cursor-not-allowed' : 'text-purple-600'}`}>存草稿</button>\n          )}\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto no-scrollbar pb-28 px-4 space-y-6\">\n\n          {/* 1. Cover Image */}\n          <section className=\"flex flex-col items-center py-2\">\n            <div\n              onClick={handleImageClick}\n              className=\"relative group cursor-pointer active:scale-95 transition-transform w-full h-40 rounded-3xl overflow-hidden shadow-lg border-4 border-white bg-white/50\"\n            >\n              {form.image ? (\n                <img src={form.image} className=\"w-full h-full object-cover\" alt=\"cover\" />\n              ) : (\n                <div className=\"w-full h-full flex flex-col items-center justify-center text-purple-300\">\n                  <Camera size={32} />\n                  <span className=\"text-xs font-bold mt-2\">上传封面</span>\n                </div>\n              )}\n              <div className=\"absolute bottom-2 right-2 bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md\">\n                <Plus size={14} />\n              </div>\n            </div>\n            <input type=\"file\" ref={fileInputRef} className=\"hidden\" accept=\"image/*\" onChange={handleFileChange} />\n          </section>\n\n          {/* 2. Basic Info */}\n          <section className=\"glass-card p-6 space-y-4\">\n            <div className=\"section-title !font-kosugi !text-purple-900 mb-2\">基础信息</div>\n\n            {/* Title */}\n            <div>\n              <label className={`${labelClass} flex items-center gap-1`}>故事标题{errors.title && <span className=\"text-red-500 text-[10px] font-normal ml-1\">必填</span>}</label>\n              <input\n                value={form.title}\n                onChange={e => setForm(prev => ({ ...prev, title: e.target.value }))}\n                type=\"text\"\n                placeholder=\"请输入引人入胜的标题\"\n                className={`dream-input w-full px-4 py-3 text-sm font-bold ${errors.title ? 'border-red-300 bg-red-50' : ''}`}\n              />\n            </div>\n\n            {/* Description */}\n            <div>\n              <label className={labelClass}>一句话简介</label>\n              <input\n                value={form.description}\n                onChange={e => setForm(prev => ({ ...prev, description: e.target.value }))}\n                type=\"text\"\n                placeholder=\"展现在列表卡片上的简介\"\n                className=\"dream-input w-full px-4 py-3 text-sm\"\n              />\n            </div>\n\n            {/* Tags */}\n            <div>\n              <label className={labelClass}>故事标签</label>\n              <div onClick={() => setShowTagModal(true)} className=\"dream-input w-full px-3 py-2 min-h-[46px] flex flex-wrap gap-2 items-center bg-white/60 cursor-pointer hover:bg-white/80 transition\">\n                {form.tags.length === 0 && (\n                  <span className=\"text-xs text-[#B3A4C8] ml-1\">点击添加标签</span>\n                )}\n                {form.tags.map(tag => (\n                  <span key={tag} className=\"tag-pill px-2 py-1 flex items-center shadow-sm\">\n                    #{tag}\n                    <X size={12} className=\"ml-1 opacity-60 hover:opacity-100 cursor-pointer\" onClick={(e) => { e.stopPropagation(); toggleTag(tag); }} />\n                  </span>\n                ))}\n                <ChevronRight className=\"ml-auto text-purple-300\" size={16} />\n              </div>\n            </div>\n          </section>\n\n          {/* 3. Characters */}\n          <section className=\"glass-card p-6 space-y-4\">\n            <div className=\"flex justify-between items-center mb-2 relative\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"section-title !font-kosugi !text-purple-900 mb-0\">登场角色</div>\n                <button\n                  onClick={() => setShowRoleTips(true)}\n                  className=\"w-5 h-5 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center border border-purple-100\"\n                >\n                  <AlertCircle size={12} />\n                </button>\n              </div>\n              <button\n                onClick={() => setShowRoleModal(true)}\n                className=\"text-xs bg-purple-100 text-purple-600 px-3 py-1.5 rounded-full font-bold hover:bg-purple-200 transition\"\n              >\n                + 导入角色\n              </button>\n              {showRoleTips && (\n                <>\n                  <div className=\"fixed inset-0 z-[60]\" onClick={() => setShowRoleTips(false)}></div>\n                  <div ref={roleTipsRef} className=\"absolute left-0 top-8 z-[61] bg-white rounded-2xl shadow-xl border border-slate-100 p-3 w-[88%]\">\n                    <div className=\"text-xs text-slate-700 font-kosugi\">当故事角色来自于“角色广场”或“你已创建的角色”时，请在下方添加所有出场角色，便于读者一键与角色聊天哦～</div>\n                    <div className=\"text-[10px] text-slate-400 mt-1 font-kosugi\">若角色不来自上述来源，可不添加。</div>\n                  </div>\n                </>\n              )}\n            </div>\n\n            {form.roles.length === 0 ? (\n              <div className=\"text-center py-6 text-slate-400 text-xs border border-dashed border-purple-200 rounded-xl\">\n                暂无角色，请点击上方按钮添加\n              </div>\n            ) : (\n              <div className=\"flex flex-col divide-y divide-slate-200\">\n                {form.roles.map((role) => (\n                  <div key={role.name} className=\"flex items-center gap-3 bg-white/60 py-3\">\n                    <div className=\"w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden\">\n                      {role.avatar ? (\n                        <img src={role.avatar} alt={role.name} className=\"w-full h-full object-cover\" />\n                      ) : (\n                        <span className=\"text-sm font-bold text-slate-500\">{(role.name || '?')[0]}</span>\n                      )}\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"font-bold text-slate-700 text-sm\">{role.name}</div>\n                      <div className=\"text-[10px] text-slate-500 truncate\">{role.description}</div>\n                    </div>\n                    <button onClick={() => removeRole(role.name)} className=\"text-slate-400 hover:text-red-400 p-2\">\n                      <Trash2 size={16} />\n                    </button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </section>\n\n          {/* 4. Story Content */}\n          <section className=\"glass-card p-6 h-auto min-h-[300px] flex flex-col\">\n            <div className=\"section-title !font-kosugi !text-purple-900 mb-4 flex items-center gap-1\">故事正文{errors.content && <span className=\"text-red-500 text-[10px] font-normal\">必填</span>}</div>\n            <textarea\n              value={form.content}\n              onChange={e => setForm(prev => ({ ...prev, content: e.target.value }))}\n              placeholder=\"在此输入精彩的故事内容...\"\n              className={`flex-1 w-full bg-transparent border-none outline-none resize-none text-slate-700 leading-relaxed text-base min-h-[200px] placeholder:text-slate-300 ${errors.content ? 'border-red-300 bg-red-50' : ''}`}\n            ></textarea>\n          </section>\n\n        </div>\n\n        {/* Footer */}\n        <div className=\"absolute bottom-0 inset-x-0 mx-auto w-full max-w-md bg-white/90 backdrop-blur-md p-4 z-50 border-t border-purple-50 rounded-none md:rounded-b-3xl shadow-2xl\">\n          <button\n            onClick={handlePublish}\n            disabled={submitting !== 'none'}\n            className={`w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-purple-300 active:scale-95 transition flex items-center justify-center gap-2 ${submitting !== 'none' ? 'opacity-70 cursor-not-allowed' : ''}`}\n          >\n            <Send size={18} /> {submitting === 'publish' ? '发布中...' : '发布故事'}\n          </button>\n        </div>\n\n        {/* Tag Modal */}\n        {showTagModal && (\n          <>\n            <div className=\"fixed inset-0 bg-black/30 backdrop-blur-[2px] z-[61]\" onClick={() => setShowTagModal(false)}></div>\n            <div className=\"fixed bottom-0 left-0 right-0 mx-auto w-full max-w-md bg-white rounded-t-[30px] z-[62] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col h-[70vh] animate-in slide-in-from-bottom duration-300\">\n              <div className=\"px-5 py-4 flex justify-between items-center border-b border-purple-50 bg-white rounded-t-[30px]\">\n                <button onClick={() => setShowTagModal(false)} className=\"w-8 h-8 rounded-full bg-purple-50 text-purple-800 flex items-center justify-center\">\n                  <ChevronDown size={20} />\n                </button>\n                <h3 className=\"text-lg font-bold text-purple-900 font-kosugi\">添加故事标签</h3>\n                <button onClick={() => setShowTagModal(false)} className=\"text-sm font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full font-kosugi\">完成</button>\n              </div>\n\n              <div className=\"flex-1 overflow-y-auto p-5 pb-10\">\n                <div className=\"mb-4\">\n                  <div className=\"text-xs font-bold text-slate-400 mb-2 ml-1\">选定的标签</div>\n                  <div className=\"flex flex-wrap gap-2 min-h-[46px] bg-purple-50/50 p-3 rounded-xl border border-purple-100 border-dashed\">\n                    {form.tags.length === 0 && <span className=\"text-xs text-slate-400 self-center\">暂无标签</span>}\n                    {form.tags.map(tag => (\n                      <button key={tag} onClick={() => toggleTag(tag)} className=\"bg-purple-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm flex items-center gap-1\">\n                        #{tag} <X size={10} className=\"opacity-80\" />\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                <div className=\"mb-6\">\n                  <div className=\"text-xs font-bold text-slate-400 mb-2 ml-1\">自定义标签</div>\n                  <div className=\"flex gap-2\">\n                    <input\n                      value={customTagInput}\n                      onChange={e => setCustomTagInput(e.target.value)}\n                      onKeyDown={e => e.key === 'Enter' && addCustomTag()}\n                      type=\"text\"\n                      placeholder=\"输入标签\"\n                      className=\"dream-input flex-1 px-4 py-2 text-sm bg-white\"\n                    />\n                    <button onClick={addCustomTag} className=\"bg-purple-500 text-white px-4 rounded-xl font-bold text-sm shadow-md active:scale-95 transition\">\n                      添加\n                    </button>\n                  </div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs font-bold text-slate-400 mb-2 ml-1\">热门标签</div>\n                  <div className=\"grid grid-cols-4 gap-2\">\n                    {availableTags.map(tag => (\n                      <button\n                        key={tag}\n                        onClick={() => toggleTag(tag)}\n                        className={`\n                                            rounded-2xl font-bold text-[0.85rem] px-2 py-2 transition-all whitespace-nowrap overflow-hidden text-ellipsis\n                                            ${form.tags.includes(tag) ? 'bg-[#8B5CF6] text-white shadow-md' : 'bg-[#F3E8FF] text-[#6B21A8]'}\n                                        `}\n                      >\n                        #{tag}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </>\n        )}\n\n        {/* Character/Role Selection Modal */}\n        {showRoleModal && (\n          <>\n            <div className=\"fixed inset-0 bg-black/30 backdrop-blur-[2px] z-[61]\" onClick={() => setShowRoleModal(false)}></div>\n            <div className=\"fixed bottom-0 left-0 right-0 mx-auto w-full max-w-md bg-white rounded-t-[30px] overflow-hidden z-[62] flex flex-col h-[70vh] animate-in slide-in-from-bottom duration-300 shadow-[0_-10px_40px_rgba(0,0,0,0.1)]\">\n              <div className=\"px-5 py-4 flex justify-between items-center border-b border-purple-50\">\n                <h3 className=\"text-lg font-bold text-purple-900 font-kosugi\">选择角色导入</h3>\n                <button onClick={() => setShowRoleModal(false)} className=\"p-2 bg-slate-100 rounded-full\"><X size={16} /></button>\n              </div>\n              <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n                {(localImportableRoles || [])\n                  .filter(item => !form.roles.some(r => r.name === item.name))\n                  .sort((a, b) => (a.isPrivate === b.isPrivate ? 0 : a.isPrivate ? -1 : 1))\n                  .map(item => (\n                    <div\n                      key={`imp_${item.id || item.name}`}\n                      onClick={() => handleAddRole({ name: item.name, avatar: item.avatar, oneLinePersona: item.desc, bio: item.desc } as any)}\n                      className=\"flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-2xl shadow-sm active:scale-[0.98] transition cursor-pointer hover:border-purple-200\"\n                    >\n                      <div className=\"w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden\">\n                        {item.avatar ? (\n                          <img src={item.avatar} alt={item.name} className=\"w-full h-full object-cover\" />\n                        ) : (\n                          <span className=\"text-base font-bold text-slate-500\">{(item.name || '?')[0]}</span>\n                        )}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"font-bold text-slate-800\">{item.name}</div>\n                        <div className=\"text-xs text-slate-400 truncate w-48\">{item.desc}</div>\n                      </div>\n                      {item.isMine && item.isPrivate && (\n                        <span className=\"text-pink-500 text-[10px] font-bold mr-2\">私密</span>\n                      )}\n                      <div className=\"ml-auto bg-purple-50 text-purple-600 p-2 rounded-full\">\n                        <Plus size={16} />\n                      </div>\n                    </div>\n                  ))}\n              </div>\n            </div>\n          </>\n        )}\n\n        {showErrorModal && (\n          <div className=\"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200\">\n            <div className=\"bg-white rounded-3xl p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200 flex flex-col items-center\">\n              <div className=\"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-3\">\n                <AlertCircle size={28} />\n              </div>\n              <h3 className=\"text-lg font-bold text-slate-800 text-center mb-1 font-kosugi\">有内容没填写完哦～</h3>\n              <p className=\"text-xs text-slate-400 text-center mb-5 font-kosugi\">请完善所有必填项后继续</p>\n              <button\n                onClick={() => setShowErrorModal(false)}\n                className=\"w-full py-2.5 rounded-xl bg-purple-500 text-white font-bold shadow-lg shadow-purple-200 hover:bg-purple-600 transition-colors font-kosugi\"\n              >\n                我知道了\n              </button>\n            </div>\n          </div>\n        )}\n\n      </div>\n    </div>\n  );\n};\n"],"file":"assets/CreateStory-qimqaeIp.js"}