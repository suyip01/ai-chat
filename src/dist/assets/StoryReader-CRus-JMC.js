import{r as l,j as e}from"./index-DiMvcmcb.js";import{A as $}from"./arrow-left-D36-7upH.js";import{c as I}from"./createLucideIcon-CiU7U1is.js";import{C as _}from"./check-CIfsadPx.js";import{I as q}from"./info-Bu7G037R.js";/**
 * @license lucide-react v0.555.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],P=I("arrow-right",O),K=({story:n,onBack:E,onStartRoleplay:H,connectedRoleNames:j=[],validRoleNames:x=[]})=>{const a=l.useRef(null),o=l.useRef(null),[h,w]=l.useState(20),[N,k]=l.useState(0),[f,y]=l.useState(!1),[A,S]=l.useState(!1),[c,L]=l.useState(null),[M,T]=l.useState(!1),R=l.useRef(0),z=l.useRef(0),u=l.useCallback(()=>{if(!a.current||!o.current)return;const{scrollTop:t,scrollHeight:s,clientHeight:r}=a.current,m=o.current.clientHeight;if(s<=r){w(m),k(0);return}const b=r/s,g=Math.max(b*m,30);w(g);const i=s-r,v=m-g,d=t/i;k(d*v)},[]);l.useEffect(()=>{const t=new ResizeObserver(()=>{u()});a.current&&t.observe(a.current),o.current&&t.observe(o.current);const s=setTimeout(u,100);return()=>{t.disconnect(),clearTimeout(s)}},[u]);const C=t=>{t.preventDefault(),t.stopPropagation(),y(!0);const s="touches"in t?t.touches[0].clientX:t.clientY;R.current=s,z.current=N};l.useEffect(()=>{const t=r=>{if(!f||!a.current||!o.current)return;r.preventDefault();const b=("touches"in r?r.touches[0].clientY:r.clientY)-R.current,i=o.current.clientHeight-h,v=a.current.scrollHeight-a.current.clientHeight;if(i<=0)return;let d=z.current+b;d=Math.max(0,Math.min(d,i));const F=d/i;a.current.scrollTop=F*v},s=()=>{y(!1)};return f&&(document.addEventListener("mousemove",t),document.addEventListener("mouseup",s),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("touchend",s)),()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",t),document.removeEventListener("touchend",s)}},[f,h]);const Y=()=>{if(c){if(j.includes(c)){T(!0);return}const t=(n.availableRoles||[]).find(s=>s.name===c);t&&H(t)}},D=n.content.split(`
`).filter(t=>t.trim()!==""),p=(n.availableRoles||[]).filter(t=>x&&x.length?x.includes(t.name):!0);return e.jsxs("div",{className:"fixed inset-0 bg-white z-[60] flex flex-col h-full w-full animate-in slide-in-from-right duration-300",children:[e.jsxs("div",{className:"mx-auto w-full max-w-md h-full flex flex-col relative bg-white rounded-none md:rounded-3xl md:overflow-hidden shadow-2xl",children:[e.jsx("button",{onClick:E,className:"absolute top-4 left-4 z-[100] w-10 h-10 bg-black/20 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-black/30 transition-all",children:e.jsx($,{size:24})}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar bg-[#FAFAFA]",onScroll:u,ref:a,children:[e.jsxs("div",{className:"w-full h-64 relative",children:[e.jsx("img",{src:n.image||"/uploads/covers/default_storyimg.jpg",alt:n.title,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-[#FAFAFA] to-transparent"})]}),e.jsxs("div",{className:"px-6 -mt-12 relative z-10 pb-20",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 mb-4 leading-tight",children:n.title}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-slate-200 overflow-hidden border border-white shadow-sm mr-3",children:e.jsx("img",{src:n.user_avatar||`https://api.dicebear.com/7.x/miniavs/svg?seed=${n.author}`,alt:"author",className:"w-full h-full object-cover"})}),e.jsx("span",{className:"text-sm font-bold text-slate-700",children:n.author})]})]}),e.jsx("article",{className:"prose prose-slate max-w-none",children:D.map((t,s)=>e.jsx("p",{className:"mb-6 text-justify tracking-wide text-[16px]",style:{lineHeight:1.8,color:"#334155"},children:t},s))}),e.jsx("div",{className:"flex items-center justify-center my-10",children:e.jsx("span",{className:"text-slate-400/80 text-sm font-medium tracking-widest",children:"—— 全文完 ——"})}),e.jsx("div",{className:"mb-12 flex flex-wrap gap-4 pl-1",children:n.tags.map(t=>e.jsxs("span",{className:"text-sm text-slate-400",children:["#",t]},t))}),p.length>0&&e.jsx("div",{className:"flex justify-center mb-8",children:e.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-2 px-6 py-3 bg-purple-100 rounded-full shadow-lg shadow-purple-200/50 hover:bg-purple-200 transition-all active:scale-95 cursor-pointer",children:[e.jsx("span",{className:"text-lg font-bold text-purple-600 tracking-widest",children:"与角色开聊"}),e.jsx(P,{size:18,className:"text-purple-600"})]})})]})]}),e.jsx("div",{ref:o,className:"absolute right-1 top-4 bottom-4 w-1.5 z-[70]",children:e.jsx("div",{className:"w-full rounded-full cursor-pointer transition-colors duration-200 bg-slate-400/40 hover:bg-slate-400/60",style:{height:`${h}px`,transform:`translateY(${N}px)`,touchAction:"none"},onMouseDown:C,onTouchStart:C})})]}),A&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("div",{className:"bg-white w-[85%] max-w-sm rounded-[32px] overflow-hidden shadow-2xl animate-in zoom-in-95 duration-300",children:[e.jsxs("div",{className:"p-6 pb-2",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 text-center mb-6 font-kosugi",children:"请选择聊天角色"}),e.jsx("div",{className:"space-y-3 max-h-[50vh] overflow-y-auto no-scrollbar py-2 px-1",children:p.length>0?p.map(t=>{const s=c===t.name,r=j.includes(t.name);return e.jsxs("div",{onClick:()=>L(t.name),className:`
                                            relative p-4 rounded-2xl flex items-center justify-between cursor-pointer transition-all border-2
                                            ${s?"bg-purple-50 border-purple-500 shadow-md scale-[1.02]":"bg-slate-50 border-transparent hover:bg-slate-100"}
                                        `,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`font-bold text-base ${s?"text-purple-700":"text-slate-800"}`,children:t.name}),r&&e.jsx("span",{className:"text-[10px] text-green-500 font-bold mt-1",children:"● 已建联"})]}),s&&e.jsx("div",{className:"w-5 h-5 rounded-full bg-purple-500 flex items-center justify-center text-white shadow-sm",children:e.jsx(_,{size:12,strokeWidth:3})})]},t.name)}):e.jsx("p",{className:"text-center text-slate-400 py-4 text-sm",children:"暂无识别到的角色"})})]}),e.jsx("div",{className:"p-6 pt-2 bg-gradient-to-t from-white via-white to-transparent",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>S(!1),className:"flex-1 py-3.5 rounded-2xl border border-slate-200 font-bold text-slate-500 hover:bg-slate-50 text-sm",children:"取消"}),e.jsx("button",{onClick:Y,disabled:!c,className:`
                                   flex-1 py-3.5 rounded-2xl font-bold text-white text-sm shadow-lg transition-all flex items-center justify-center gap-2
                                   ${c?"bg-purple-600 shadow-purple-200 hover:bg-purple-700 active:scale-95":"bg-slate-300 shadow-none cursor-not-allowed"}
                               `,children:"查看角色卡"})]})})]})}),M&&e.jsx("div",{className:"fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-3xl p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200 flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 text-purple-500 rounded-full flex items-center justify-center mb-4",children:e.jsx(q,{size:24})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2 font-kosugi",children:"你已经与该角色建联了"}),e.jsx("p",{className:"text-xs text-slate-400 mb-6 font-kosugi",children:"请在聊天列表查看与该角色的聊天记录"}),e.jsx("button",{onClick:()=>T(!1),className:"w-full py-3 rounded-2xl bg-purple-600 text-white font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition-colors text-sm font-kosugi",children:"我知道了"})]})})]})};export{K as StoryReader};
//# sourceMappingURL=StoryReader-CRus-JMC.js.map
