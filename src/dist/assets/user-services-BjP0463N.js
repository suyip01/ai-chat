import{_ as n,B as g}from"./user-components-BCzIkXTb.js";const w=t=>t==="male"?"男":t==="female"?"女":"未透露",F=async t=>{const e={name:t?.name||"未命名",age:parseInt(t?.age||"0")||null,gender:w(t?.gender),profession:t?.profession||null,basic_info:t?.basicInfo||null,personality:t?.personality||null,avatar:t?.avatar||null},{authFetch:a}=await n(async()=>{const{authFetch:r}=await Promise.resolve().then(()=>c);return{authFetch:r}},void 0),s=await a("/user/chat-role",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error("create_role_failed");return(await s.json()).id},I=async(t,e)=>{const a={name:e?.name||"未命名",age:parseInt(e?.age||"0")||null,gender:w(e?.gender),profession:e?.profession||null,basic_info:e?.basicInfo||null,personality:e?.personality||null,avatar:e?.avatar||null},{authFetch:s}=await n(async()=>{const{authFetch:r}=await Promise.resolve().then(()=>c);return{authFetch:r}},void 0);if(!(await s(`/user/chat-role/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("update_role_failed");return!0},A=async()=>{const{authFetch:t}=await n(async()=>{const{authFetch:s}=await Promise.resolve().then(()=>c);return{authFetch:s}},void 0),e=await t("/user/chat-role",{method:"GET"});if(!e.ok)throw new Error("fetch_roles_failed");const a=await e.json();return Array.isArray(a)?a:[]},C=async(t,e)=>{const a={character_id:Number(t)};typeof e=="number"&&(a.user_chat_role_id=e);const{authFetch:s}=await n(async()=>{const{authFetch:h}=await Promise.resolve().then(()=>c);return{authFetch:h}},void 0),o=await s("/chat/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok)throw new Error("create_session_failed");const r=await o.json();return typeof r=="string"?{sessionId:r}:{sessionId:r.sessionId,model:r.model,temperature:r.temperature}},j=(t,e)=>{const o=`${`${location.protocol==="https:"?"wss":"ws"}://${location.host}`}/ws/chat`;console.log("[ws] connecting",o);let r=null,h=!1,d=1e3;const y=1e4,_=[],p=()=>{r=new WebSocket(o),r.onmessage=l=>{try{const i=JSON.parse(String(l.data));i&&i.type==="assistant_message"&&typeof i.content=="string"&&e(i.content,i.quote,{chunkIndex:i.chunkIndex,chunkTotal:i.chunkTotal})}catch{}},r.onerror=l=>{console.error("[ws] error",l)},r.onopen=()=>{for(console.log("[ws] open"),d=1e3;_.length;){const i=_.shift();try{r?.send(JSON.stringify(i))}catch{}}const l={type:"typing",sessionId:t,typing:!1};try{r?.send(JSON.stringify(l))}catch{}},r.onclose=()=>{console.log("[ws] closed"),h||(setTimeout(p,d),d=Math.min(d*2,y))}};return p(),{ws:r,sendText:(l,i,u)=>{const f={sessionId:t,text:l,chatMode:i};u&&(f.userRole={name:u.name,gender:w(u.gender),age:u.age||"",profession:u.profession||"",basic_info:u.basicInfo||"",personality:u.personality||"",avatar:u.avatar||""}),r&&r.readyState===WebSocket.OPEN?r.send(JSON.stringify(f)):_.push(f)},sendTyping:l=>{const i={type:"typing",sessionId:t,typing:l};r&&r.readyState===WebSocket.OPEN?r.send(JSON.stringify(i)):_.push(i)},close:()=>{h=!0;try{r?.close()}catch{}}}},L=async()=>{const{authFetch:t}=await n(async()=>{const{authFetch:s}=await Promise.resolve().then(()=>c);return{authFetch:s}},void 0),e=await t("/chat/models",{method:"GET"});if(!e.ok)throw new Error("list_models_failed");const a=await e.json();return Array.isArray(a.items)?a.items:[]},D=async(t,e)=>{const a={};e.modelId&&(a.model_id=e.modelId),typeof e.temperature=="number"&&(a.temperature=e.temperature);const{authFetch:s}=await n(async()=>{const{authFetch:r}=await Promise.resolve().then(()=>c);return{authFetch:r}},void 0);if(!(await s(`/chat/sessions/${t}/config`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("update_session_config_failed");return!0},N=async t=>{const{authFetch:e}=await n(async()=>{const{authFetch:r}=await Promise.resolve().then(()=>c);return{authFetch:r}},void 0),a=await e(`/chat/sessions/${t}`,{method:"GET"});if(!a.ok)throw new Error("get_session_failed");const o=(await a.json())?.session||{};return{model:o?.model,temperature:o?.temperature}},$=async()=>{const{authFetch:t}=await n(async()=>{const{authFetch:s}=await Promise.resolve().then(()=>c);return{authFetch:s}},void 0),e=await t("/user-characters");if(!e.ok)throw new Error("failed");const a=await e.json();return Array.isArray(a.items)?a.items:[]},R=async t=>{const{authFetch:e}=await n(async()=>{const{authFetch:s}=await Promise.resolve().then(()=>c);return{authFetch:s}},void 0),a=await e(`/user-characters/${t}`);if(!a.ok)throw new Error("failed");return await a.json()},U=async t=>{const{authFetch:e}=await n(async()=>{const{authFetch:o}=await Promise.resolve().then(()=>c);return{authFetch:o}},void 0),a=await e("/user-characters",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error("create_character_failed");return(await a.json()).id},V=async t=>{const{authFetch:e}=await n(async()=>{const{authFetch:o}=await Promise.resolve().then(()=>c);return{authFetch:o}},void 0),a=await e("/user-characters/draft",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error("create_draft_failed");return(await a.json()).id},J=async(t,e)=>{const{authFetch:a}=await n(async()=>{const{authFetch:o}=await Promise.resolve().then(()=>c);return{authFetch:o}},void 0);if(!(await a(`/user-characters/${t}/draft`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("update_draft_failed");return!0},x=async(t,e)=>{const{authFetch:a}=await n(async()=>{const{authFetch:o}=await Promise.resolve().then(()=>c);return{authFetch:o}},void 0);if(!(await a(`/user-characters/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("update_failed");return!0},W=async t=>{const{authFetch:e}=await n(async()=>{const{authFetch:s}=await Promise.resolve().then(()=>c);return{authFetch:s}},void 0);if(!(await e(`/user-characters/${t}`,{method:"DELETE"})).ok)throw new Error("delete_failed");return!0},m=t=>({id:t?.id??t?._id??t?.character_id??String(Date.now()),name:t?.name??t?.title??"",avatar:t?.avatar??t?.cover??t?.image??"",profileImage:t?.profileImage??t?.banner??t?.image??"",bio:t?.bio??t?.tagline??t?.description??"",tags:t?.tags??t?.keywords??[],creator:t?.creator??t?.author??"",oneLinePersona:t?.oneLinePersona??t?.tagline??"",personality:t?.personality??t?.personality??"",profession:t?.profession??t?.occupation??"",age:t?.age??"",roleType:t?.roleType??t?.character_type??"",currentRelationship:t?.currentRelationship??t?.relationship??"",plotTheme:t?.plotTheme??t?.plot_theme??"",plotDescription:t?.plotDescription??t?.plot_summary??"",openingLine:t?.openingLine??t?.opening_line??""}),B=async t=>{const e=new URLSearchParams;t?.tag&&e.set("tag",t.tag),e.set("limit",String(t.limit));const{authFetch:a}=await n(async()=>{const{authFetch:h}=await Promise.resolve().then(()=>c);return{authFetch:h}},void 0),s=await a(`/characters/?${e.toString()}`);if(!s.ok)throw new Error("failed");const o=await s.json();return(Array.isArray(o?.items)?o.items:[]).map(m)},E=()=>localStorage.getItem("user_access_token")||"",T=()=>localStorage.getItem("user_refresh_token")||"",P=t=>{t&&localStorage.setItem("user_access_token",t)},v=async(t,e={})=>{const a=t.startsWith("http")?t:`${g}${t.startsWith("/")?"":"/"}${t}`,s=new Headers(e.headers||{}),o=E();o&&s.set("Authorization",`Bearer ${o}`);const r=await fetch(a,{...e,headers:s});if(r.status!==401)return r;const h=T();if(!h)return r;try{const d=await fetch(`${g}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:h})});if(d.ok){const y=await d.json();y?.access_token&&P(y.access_token);const _=new Headers(e.headers||{});return _.set("Authorization",`Bearer ${y.access_token}`),fetch(a,{...e,headers:_})}}catch{}return r},c=Object.freeze(Object.defineProperty({__proto__:null,authFetch:v},Symbol.toStringTag,{value:"Module"}));export{D as a,C as b,j as c,W as d,F as e,A as f,N as g,R as h,x as i,U as j,J as k,L as l,V as m,B as n,$ as o,c as p,I as u};
