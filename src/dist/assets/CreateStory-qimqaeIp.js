const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/http-DKg3Rn4S.js","assets/api-BQ_HNd4s.js"])))=>i.map(i=>d[i]);
import{r as c,_ as F,R as ue,j as e}from"./index-DiMvcmcb.js";import{I as xe}from"./ImageCropper-u3NJns5t.js";import{u as pe}from"./App-Bl6Z-21V.js";import{C as fe}from"./chevron-left-B3HkbiML.js";import{C as he}from"./camera-wGCI_KHa.js";import{P as Q}from"./plus-Bz3dnY0B.js";import{X as $}from"./x-CKT7hpuC.js";import{C as ge}from"./chevron-right-jr0esStd.js";import{C as Y}from"./circle-alert-_OBbJmYg.js";import{T as be}from"./trash-2-CCl4-mF6.js";import{S as je}from"./send-BX7jbBow.js";import{C as ve}from"./chevron-down-C8dX3bVB.js";import"./check-CIfsadPx.js";import"./createLucideIcon-CiU7U1is.js";import"./user-DjmimaIa.js";const Le=({onBack:Z,onPublish:S,onSaveDraft:D,availableCharacters:we,myUserCharacters:R=[],initialStory:l,importableRoles:w=[]})=>{const{showCenter:N}=pe(),[a,d]=c.useState(()=>l?{title:l.title,description:l.description,image:l.image,content:l.content,tags:l.tags,roles:l.availableRoles||[]}:{title:"",description:"",image:"",content:"",tags:[],roles:[]}),[ee,k]=c.useState(!1),[te,C]=c.useState(!1),[se,L]=c.useState(!1),[_,ae]=c.useState({}),[M,B]=c.useState(""),[O,T]=c.useState(null),[j,v]=c.useState(!1),U=c.useRef(null),[u,V]=c.useState(w),W=c.useRef(!1);c.useEffect(()=>{V(w||[])},[w]),c.useEffect(()=>{W.current||u&&u.length||(W.current=!0,(async()=>{try{const{authFetch:t}=await F(async()=>{const{authFetch:n}=await import("./http-DKg3Rn4S.js");return{authFetch:n}},__vite__mapDeps([0,1])),s=await t("/stories/combine");if(s&&s.ok){const n=await s.json(),r=Array.isArray(n==null?void 0:n.items)?n.items:[];V(r.map(o=>({id:String(o.character_id),name:o.character_name,avatar:o.character_avatar||"",desc:o.desc||"",isPrivate:!!o.isPrivate,isMine:!!o.isMine})))}}catch{}})())},[]),ue.useMemo(()=>(Array.isArray(R)?R:[]).filter(s=>s.isPublished===!0&&s.isPublic===!1).map(s=>({id:String(s.id),name:s.name,avatar:s.avatar,desc:s.oneLinePersona||s.bio||"",isPrivate:!0,isMine:!0})),[R]);const z=c.useRef(!1);c.useEffect(()=>{if(z.current)return;const t=Array.isArray(l==null?void 0:l.characterIds)?l.characterIds:[];if(!t.length||!u||!u.length)return;const s=new Set(t.map(r=>String(r))),n=u.filter(r=>s.has(String(r.id))).map(r=>({name:r.name,avatar:r.avatar,description:r.desc||"暂无描述"}));n.length&&(z.current=!0,d(r=>({...r,roles:n})))},[l,u]),c.useEffect(()=>{if(!l)return;const t=l.availableRoles||[];t.length&&(d(s=>({...s,roles:t})),z.current=!0)},[l]),c.useEffect(()=>{l&&d(t=>({...t,title:l.title||t.title,description:l.description||t.description,image:l.image||t.image,content:l.content||t.content,tags:Array.isArray(l.tags)?l.tags:t.tags}))},[l]),c.useEffect(()=>{if(!j)return;const t=setTimeout(()=>v(!1),6e3);return()=>clearTimeout(t)},[j]),c.useEffect(()=>{if(!j)return;const t=s=>{const n=U.current;if(!n){v(!1);return}const r=s.target;n.contains(r)||v(!1)};return window.addEventListener("click",t,!0),()=>window.removeEventListener("click",t,!0)},[j]);const h=c.useRef(null),G=t=>{var p;const s=t.split(","),n=((p=s[0].match(/:(.*?);/))==null?void 0:p[1])||"image/jpeg",r=atob(s[1]);let o=r.length;const g=new Uint8Array(o);for(;o--;)g[o]=r.charCodeAt(o);return new Blob([g],{type:n})},le=["BG","BL","GL","暗恋","校园","职场","悬疑","科幻","古风","穿越","重生","甜宠","虐恋","HE","BE","爽文","娱乐圈","青梅竹马","强强","同人"],ne=()=>{var t;(t=h.current)==null||t.click()},re=t=>{var n;const s=(n=t.target.files)==null?void 0:n[0];if(s){const r=new FileReader;r.onloadend=()=>{T(r.result)},r.readAsDataURL(s)}h.current&&(h.current.value="")},E=t=>{a.tags.includes(t)?d(s=>({...s,tags:s.tags.filter(n=>n!==t)})):d(s=>({...s,tags:[...s.tags,t]}))},H=()=>{const t=M.trim();t&&!a.tags.includes(t)&&(d(s=>({...s,tags:[...s.tags,t]})),B(""))},oe=t=>{if(a.roles.some(n=>n.name===t.name))return;const s={name:t.name,avatar:t.avatar,description:t.oneLinePersona||t.bio||"暂无描述"};d(n=>({...n,roles:[...n.roles,s]})),C(!1)},ce=t=>{d(s=>({...s,roles:s.roles.filter(n=>n.name!==t)}))},J=()=>{const t=a.roles.map(n=>n.name),s={};return w.forEach(n=>{s[n.name]=n.id}),t.map(n=>s[n]).filter(Boolean)},[x,y]=c.useState("none"),q=async t=>{try{y(t==="published"?"publish":"draft");let s=a.image||"";try{const i=localStorage.getItem("user_access_token");if(a.image&&a.image.startsWith("data:image")){const m=G(a.image),f=new FormData,X=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;s=`/uploads/covers/${X}`,f.append("cover",m,"cover.jpg"),f.append("filename",X);const I=await fetch("/api/uploads/cover",{method:"POST",headers:{Authorization:i?`Bearer ${i}`:""},body:f});if(I&&I.ok){const A=await I.json();A&&A.url&&(s=A.url)}}}catch{}const n={title:a.title,description:a.description,image:s,status:t,content:a.content,tags:a.tags,characterIds:J()},{authFetch:r}=await F(async()=>{const{authFetch:i}=await import("./http-DKg3Rn4S.js");return{authFetch:i}},__vite__mapDeps([0,1])),o=!!l,g=o?`/user/stories/${l==null?void 0:l.id}`:"/user/stories",b=await r(g,{method:o?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(b&&b.ok){let i;try{const f=await b.json();i=f==null?void 0:f.id}catch{i=l==null?void 0:l.id}const m={id:typeof i=="number"?i:l?l.id:Date.now(),title:a.title,description:a.description,image:s||a.image,content:a.content,tags:a.tags,author:localStorage.getItem("user_nickname")||"我",likes:"0",availableRoles:a.roles,status:t};t==="published"?S(m):D(m);return}N("保存失败，请重试。","error")}catch{N("保存失败，请重试。","error")}finally{y("none")}},ie=async()=>{try{y("draft");let t=a.image||"";try{const o=localStorage.getItem("user_access_token");if(a.image&&a.image.startsWith("data:image")){const g=G(a.image),p=new FormData,b=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.jpg`;t=`/uploads/covers/${b}`,p.append("cover",g,"cover.jpg"),p.append("filename",b);const i=await fetch("/api/uploads/cover",{method:"POST",headers:{Authorization:o?`Bearer ${o}`:""},body:p});if(i&&i.ok){const m=await i.json();m&&m.url&&(t=m.url)}}}catch{}const s={title:a.title,description:a.description,image:t,content:a.content,tags:a.tags,characterIds:J()},{authFetch:n}=await F(async()=>{const{authFetch:o}=await import("./http-DKg3Rn4S.js");return{authFetch:o}},__vite__mapDeps([0,1])),r=await n(`/user/stories/${l==null?void 0:l.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(r&&r.ok){const o={id:typeof(l==null?void 0:l.id)=="number"?l.id:Date.now(),title:a.title,description:a.description,image:t||a.image,content:a.content,tags:a.tags,author:localStorage.getItem("user_nickname")||"我",likes:"0",availableRoles:a.roles,status:l==null?void 0:l.status};D(o);return}N("保存失败，请重试。","error")}catch{N("保存失败，请重试。","error")}finally{y("none")}},de=()=>{const t={};return a.title.trim()||(t.title=!0),a.content.trim()||(t.content=!0),ae(t),Object.keys(t).length===0},me=()=>{if(!de()){L(!0);return}q("published")},K=()=>{if(l){ie();return}q("draft")},P="field-label font-kosugi mb-3 text-slate-700 font-bold text-sm block";return e.jsx("div",{className:"fixed inset-0 bg-white z-[60]",children:e.jsxs("div",{className:"mx-auto w-full max-w-md h-full relative flex flex-col overflow-hidden rounded-none md:rounded-3xl shadow-2xl bg白 font-kosugi",children:[O&&e.jsx(xe,{imageSrc:O,aspectRatio:2,outputWidth:800,outputHeight:400,onCancel:()=>{T(null),h.current&&(h.current.value="")},onCrop:t=>{d(s=>({...s,image:t})),T(null)}}),e.jsx("div",{className:"ambient-bg hidden"}),e.jsxs("div",{className:"sticky top-0 z-50 bg-white px-4 py-3 flex items-center border-b border-slate-100 rounded-t-none md:rounded-t-3xl relative",children:[l&&e.jsx("button",{onClick:K,disabled:x!=="none",className:`absolute right-4 text-sm font-bold font-kosugi ${x!=="none"?"text-slate-400 cursor-not-allowed":"text-purple-600"}`,children:"更新草稿"}),e.jsx("button",{onClick:Z,className:"w-8 h-8 flex items-center justify-center text-purple-800 hover:bg-purple-100 rounded-full transition",children:e.jsx(fe,{size:20})}),e.jsx("h1",{className:"absolute left-1/2 -translate-x-1/2 text-xl font-bold text-purple-900 font-kosugi",children:l?"编辑故事":"创作故事"}),!l&&e.jsx("button",{onClick:K,disabled:x!=="none",className:`ml-auto text-sm font-bold font-kosugi ${x!=="none"?"text-slate-400 cursor-not-allowed":"text-purple-600"}`,children:"存草稿"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar pb-28 px-4 space-y-6",children:[e.jsxs("section",{className:"flex flex-col items-center py-2",children:[e.jsxs("div",{onClick:ne,className:"relative group cursor-pointer active:scale-95 transition-transform w-full h-40 rounded-3xl overflow-hidden shadow-lg border-4 border-white bg-white/50",children:[a.image?e.jsx("img",{src:a.image,className:"w-full h-full object-cover",alt:"cover"}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center text-purple-300",children:[e.jsx(he,{size:32}),e.jsx("span",{className:"text-xs font-bold mt-2",children:"上传封面"})]}),e.jsx("div",{className:"absolute bottom-2 right-2 bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md",children:e.jsx(Q,{size:14})})]}),e.jsx("input",{type:"file",ref:h,className:"hidden",accept:"image/*",onChange:re})]}),e.jsxs("section",{className:"glass-card p-6 space-y-4",children:[e.jsx("div",{className:"section-title !font-kosugi !text-purple-900 mb-2",children:"基础信息"}),e.jsxs("div",{children:[e.jsxs("label",{className:`${P} flex items-center gap-1`,children:["故事标题",_.title&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal ml-1",children:"必填"})]}),e.jsx("input",{value:a.title,onChange:t=>d(s=>({...s,title:t.target.value})),type:"text",placeholder:"请输入引人入胜的标题",className:`dream-input w-full px-4 py-3 text-sm font-bold ${_.title?"border-red-300 bg-red-50":""}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:P,children:"一句话简介"}),e.jsx("input",{value:a.description,onChange:t=>d(s=>({...s,description:t.target.value})),type:"text",placeholder:"展现在列表卡片上的简介",className:"dream-input w-full px-4 py-3 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:P,children:"故事标签"}),e.jsxs("div",{onClick:()=>k(!0),className:"dream-input w-full px-3 py-2 min-h-[46px] flex flex-wrap gap-2 items-center bg-white/60 cursor-pointer hover:bg-white/80 transition",children:[a.tags.length===0&&e.jsx("span",{className:"text-xs text-[#B3A4C8] ml-1",children:"点击添加标签"}),a.tags.map(t=>e.jsxs("span",{className:"tag-pill px-2 py-1 flex items-center shadow-sm",children:["#",t,e.jsx($,{size:12,className:"ml-1 opacity-60 hover:opacity-100 cursor-pointer",onClick:s=>{s.stopPropagation(),E(t)}})]},t)),e.jsx(ge,{className:"ml-auto text-purple-300",size:16})]})]})]}),e.jsxs("section",{className:"glass-card p-6 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 relative",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"section-title !font-kosugi !text-purple-900 mb-0",children:"登场角色"}),e.jsx("button",{onClick:()=>v(!0),className:"w-5 h-5 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center border border-purple-100",children:e.jsx(Y,{size:12})})]}),e.jsx("button",{onClick:()=>C(!0),className:"text-xs bg-purple-100 text-purple-600 px-3 py-1.5 rounded-full font-bold hover:bg-purple-200 transition",children:"+ 导入角色"}),j&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[60]",onClick:()=>v(!1)}),e.jsxs("div",{ref:U,className:"absolute left-0 top-8 z-[61] bg-white rounded-2xl shadow-xl border border-slate-100 p-3 w-[88%]",children:[e.jsx("div",{className:"text-xs text-slate-700 font-kosugi",children:"当故事角色来自于“角色广场”或“你已创建的角色”时，请在下方添加所有出场角色，便于读者一键与角色聊天哦～"}),e.jsx("div",{className:"text-[10px] text-slate-400 mt-1 font-kosugi",children:"若角色不来自上述来源，可不添加。"})]})]})]}),a.roles.length===0?e.jsx("div",{className:"text-center py-6 text-slate-400 text-xs border border-dashed border-purple-200 rounded-xl",children:"暂无角色，请点击上方按钮添加"}):e.jsx("div",{className:"flex flex-col divide-y divide-slate-200",children:a.roles.map(t=>e.jsxs("div",{className:"flex items-center gap-3 bg-white/60 py-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden",children:t.avatar?e.jsx("img",{src:t.avatar,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-sm font-bold text-slate-500",children:(t.name||"?")[0]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-slate-700 text-sm",children:t.name}),e.jsx("div",{className:"text-[10px] text-slate-500 truncate",children:t.description})]}),e.jsx("button",{onClick:()=>ce(t.name),className:"text-slate-400 hover:text-red-400 p-2",children:e.jsx(be,{size:16})})]},t.name))})]}),e.jsxs("section",{className:"glass-card p-6 h-auto min-h-[300px] flex flex-col",children:[e.jsxs("div",{className:"section-title !font-kosugi !text-purple-900 mb-4 flex items-center gap-1",children:["故事正文",_.content&&e.jsx("span",{className:"text-red-500 text-[10px] font-normal",children:"必填"})]}),e.jsx("textarea",{value:a.content,onChange:t=>d(s=>({...s,content:t.target.value})),placeholder:"在此输入精彩的故事内容...",className:`flex-1 w-full bg-transparent border-none outline-none resize-none text-slate-700 leading-relaxed text-base min-h-[200px] placeholder:text-slate-300 ${_.content?"border-red-300 bg-red-50":""}`})]})]}),e.jsx("div",{className:"absolute bottom-0 inset-x-0 mx-auto w-full max-w-md bg-white/90 backdrop-blur-md p-4 z-50 border-t border-purple-50 rounded-none md:rounded-b-3xl shadow-2xl",children:e.jsxs("button",{onClick:me,disabled:x!=="none",className:`w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-purple-300 active:scale-95 transition flex items-center justify-center gap-2 ${x!=="none"?"opacity-70 cursor-not-allowed":""}`,children:[e.jsx(je,{size:18})," ",x==="publish"?"发布中...":"发布故事"]})}),ee&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 backdrop-blur-[2px] z-[61]",onClick:()=>k(!1)}),e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 mx-auto w-full max-w-md bg-white rounded-t-[30px] z-[62] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col h-[70vh] animate-in slide-in-from-bottom duration-300",children:[e.jsxs("div",{className:"px-5 py-4 flex justify-between items-center border-b border-purple-50 bg-white rounded-t-[30px]",children:[e.jsx("button",{onClick:()=>k(!1),className:"w-8 h-8 rounded-full bg-purple-50 text-purple-800 flex items-center justify-center",children:e.jsx(ve,{size:20})}),e.jsx("h3",{className:"text-lg font-bold text-purple-900 font-kosugi",children:"添加故事标签"}),e.jsx("button",{onClick:()=>k(!1),className:"text-sm font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full font-kosugi",children:"完成"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-5 pb-10",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1",children:"选定的标签"}),e.jsxs("div",{className:"flex flex-wrap gap-2 min-h-[46px] bg-purple-50/50 p-3 rounded-xl border border-purple-100 border-dashed",children:[a.tags.length===0&&e.jsx("span",{className:"text-xs text-slate-400 self-center",children:"暂无标签"}),a.tags.map(t=>e.jsxs("button",{onClick:()=>E(t),className:"bg-purple-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow-sm flex items-center gap-1",children:["#",t," ",e.jsx($,{size:10,className:"opacity-80"})]},t))]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1",children:"自定义标签"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:M,onChange:t=>B(t.target.value),onKeyDown:t=>t.key==="Enter"&&H(),type:"text",placeholder:"输入标签",className:"dream-input flex-1 px-4 py-2 text-sm bg-white"}),e.jsx("button",{onClick:H,className:"bg-purple-500 text-white px-4 rounded-xl font-bold text-sm shadow-md active:scale-95 transition",children:"添加"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-slate-400 mb-2 ml-1",children:"热门标签"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:le.map(t=>e.jsxs("button",{onClick:()=>E(t),className:`
                                            rounded-2xl font-bold text-[0.85rem] px-2 py-2 transition-all whitespace-nowrap overflow-hidden text-ellipsis
                                            ${a.tags.includes(t)?"bg-[#8B5CF6] text-white shadow-md":"bg-[#F3E8FF] text-[#6B21A8]"}
                                        `,children:["#",t]},t))})]})]})]})]}),te&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 backdrop-blur-[2px] z-[61]",onClick:()=>C(!1)}),e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 mx-auto w-full max-w-md bg-white rounded-t-[30px] overflow-hidden z-[62] flex flex-col h-[70vh] animate-in slide-in-from-bottom duration-300 shadow-[0_-10px_40px_rgba(0,0,0,0.1)]",children:[e.jsxs("div",{className:"px-5 py-4 flex justify-between items-center border-b border-purple-50",children:[e.jsx("h3",{className:"text-lg font-bold text-purple-900 font-kosugi",children:"选择角色导入"}),e.jsx("button",{onClick:()=>C(!1),className:"p-2 bg-slate-100 rounded-full",children:e.jsx($,{size:16})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:(u||[]).filter(t=>!a.roles.some(s=>s.name===t.name)).sort((t,s)=>t.isPrivate===s.isPrivate?0:t.isPrivate?-1:1).map(t=>e.jsxs("div",{onClick:()=>oe({name:t.name,avatar:t.avatar,oneLinePersona:t.desc,bio:t.desc}),className:"flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-2xl shadow-sm active:scale-[0.98] transition cursor-pointer hover:border-purple-200",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden",children:t.avatar?e.jsx("img",{src:t.avatar,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-base font-bold text-slate-500",children:(t.name||"?")[0]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold text-slate-800",children:t.name}),e.jsx("div",{className:"text-xs text-slate-400 truncate w-48",children:t.desc})]}),t.isMine&&t.isPrivate&&e.jsx("span",{className:"text-pink-500 text-[10px] font-bold mr-2",children:"私密"}),e.jsx("div",{className:"ml-auto bg-purple-50 text-purple-600 p-2 rounded-full",children:e.jsx(Q,{size:16})})]},`imp_${t.id||t.name}`))})]})]}),se&&e.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white rounded-3xl p-6 w-[80%] max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200 flex flex-col items-center",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-3",children:e.jsx(Y,{size:28})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 text-center mb-1 font-kosugi",children:"有内容没填写完哦～"}),e.jsx("p",{className:"text-xs text-slate-400 text-center mb-5 font-kosugi",children:"请完善所有必填项后继续"}),e.jsx("button",{onClick:()=>L(!1),className:"w-full py-2.5 rounded-xl bg-purple-500 text-white font-bold shadow-lg shadow-purple-200 hover:bg-purple-600 transition-colors font-kosugi",children:"我知道了"})]})})]})})};export{Le as CreateStory};
//# sourceMappingURL=CreateStory-qimqaeIp.js.map
